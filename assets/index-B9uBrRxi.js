import{initializeApp as Qe}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import{getAuth as ze,GoogleAuthProvider as Ke,onAuthStateChanged as Ge,signInWithPopup as We,signInWithEmailAndPassword as Ve,createUserWithEmailAndPassword as Ye,signOut as Je}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";import{getDatabase as Xe,ref as Rt,get as de,update as Ze,child as it,onValue as Wt,off as Vt,set as kt,remove as Tt}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function e(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(a){if(a.ep)return;a.ep=!0;const i=e(a);fetch(a.href,i)}})();const J={OFF:0,ALL:1,ONE:2},ts=["HI_RES_LOSSLESS","LOSSLESS","HIGH","LOW"],es={HI_RES_LOSSLESS:["HI_RES_LOSSLESS","HIRES_LOSSLESS","HIRESLOSSLESS","HIFI_PLUS","HI_RES_FLAC","HI_RES","HIRES","MASTER","MASTER_QUALITY","MQA"],LOSSLESS:["LOSSLESS","HIFI"],HIGH:["HIGH","HIGH_QUALITY"],LOW:["LOW","LOW_QUALITY"]},Se="Too Many Requests. Please wait a moment and try again.",mt='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><polygon points="7 3 21 12 7 21 7 3"></polygon></svg>',ss='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>',ns='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>',as='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>',ft='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',is='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>',rt='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="heart-icon"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>',Pt='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',rs='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>',xt=s=>{if(isNaN(s))return"0:00";const t=Math.floor(s/60),e=Math.floor(s%60);return`${t}:${String(e).padStart(2,"0")}`},N=(s,t=!1)=>`<div class="placeholder-text ${t?"loading":""}">${s}</div>`,O=new WeakMap,gt=s=>s?s.replace(/[\\/:*?"<>|]/g,"_").replace(/\s+/g," ").trim():"Unknown",Le=s=>{switch(s){case"LOW":case"HIGH":return"m4a";default:return"flac"}},jt=(s,t)=>{const e=localStorage.getItem("filename-template")||"{trackNumber} - {artist} - {title}",n=Le(t),a=s.artist?.name||s.artists?.[0]?.name||"Unknown Artist",i={trackNumber:s.trackNumber,artist:a,title:et(s),album:s.album?.title};return qt(e,i)+"."+n},os=s=>s?s.trim().toUpperCase().replace(/[^A-Z0-9]+/g,"_"):"",Ie=s=>{if(!s)return null;const t=os(s);for(const[e,n]of Object.entries(es))if(n.includes(t))return e;return null},ue=s=>{if(!Array.isArray(s))return null;const t=[];for(const e of s){if(typeof e!="string")continue;const n=Ie(e);n&&!t.includes(n)&&t.push(n)}return xe(t)},xe=s=>{let t=null,e=1/0;for(const n of s){if(!n)continue;const a=ts.indexOf(n),i=a===-1?1/0:a;i<e&&(t=n,e=i)}return t},ls=s=>{if(!s)return null;const t=[ue(s.mediaMetadata?.tags),ue(s.album?.mediaMetadata?.tags),Ie(s.audioQuality)];return xe(t)},Dt=s=>new Promise(t=>setTimeout(t,s)),Yt=s=>s?.explicit===!0||s?.explicitLyrics===!0,cs=(s,t)=>{let e;return function(...a){const i=()=>{clearTimeout(e),s(...a)};clearTimeout(e),e=setTimeout(i,t)}},Y=s=>typeof s!="string"?s:s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),et=(s,{fallback:t="Unknown Title"}={})=>s?.title?s?.version?`${s.title} (${s.version})`:s.title:t,tt=(s={},{fallback:t="Unknown Artist"}={})=>s?.artists?.length?s.artists.map(e=>e?.name).join(", "):t,me=(s={},{fallback:t="Unknown Artist"}={})=>s?.artists?.length?s.artists.map(e=>`<span class="artist-link" data-artist-id="${e.id}">${e.name}</span>`).join(", "):t,qt=(s,t)=>{let e=s;return e=e.replace(/\{trackNumber\}/g,t.trackNumber?String(t.trackNumber).padStart(2,"0"):"00"),e=e.replace(/\{artist\}/g,gt(t.artist||"Unknown Artist")),e=e.replace(/\{title\}/g,gt(t.title||"Unknown Title")),e=e.replace(/\{album\}/g,gt(t.album||"Unknown Album")),e=e.replace(/\{albumArtist\}/g,gt(t.albumArtist||"Unknown Artist")),e=e.replace(/\{albumTitle\}/g,gt(t.albumTitle||"Unknown Album")),e=e.replace(/\{year\}/g,t.year||"Unknown"),e},Et=s=>!Array.isArray(s)||s.length===0?0:s.reduce((t,e)=>t+(e.duration||0),0),St=s=>{if(!s||isNaN(s))return"0 min";const t=Math.floor(s/3600),e=Math.floor(s%3600/60);return t>0?`${t} hr ${e} min`:`${e} min`},Lt=new Map;async function _t(s,t){if(!t)return null;if(Lt.has(t))return Lt.get(t);const e=async n=>{try{const a=`https://corsproxy.io/?${encodeURIComponent(n)}`,i=await fetch(a);if(i.ok)return await i.blob()}catch(a){console.warn("Proxy fetch failed:",a)}return null};try{const n=s.getCoverUrl(t,"1280"),a=await fetch(n);if(a.ok){const i=await a.blob();return Lt.set(t,i),i}else{const i=await e(n);if(i)return Lt.set(t,i),i}}catch{const a=s.getCoverUrl(t,"1280"),i=await e(a);if(i)return Lt.set(t,i),i}return null}class ds{constructor(t={}){this.memoryCache=new Map,this.maxSize=t.maxSize||200,this.ttl=t.ttl||1e3*60*30,this.dbName="monochrome-cache",this.dbVersion=1,this.db=null,this.initDB()}async initDB(){if(!(typeof indexedDB>"u"))return new Promise((t,e)=>{const n=indexedDB.open(this.dbName,this.dbVersion);n.onerror=()=>e(n.error),n.onsuccess=()=>{this.db=n.result,t(this.db)},n.onupgradeneeded=a=>{const i=a.target.result;i.objectStoreNames.contains("responses")||i.createObjectStore("responses",{keyPath:"key"}).createIndex("timestamp","timestamp",{unique:!1})}})}generateKey(t,e){const n=typeof e=="object"?JSON.stringify(e):String(e);return`${t}:${n}`}async get(t,e){const n=this.generateKey(t,e);if(this.memoryCache.has(n)){const a=this.memoryCache.get(n);if(Date.now()-a.timestamp<this.ttl)return a.data;this.memoryCache.delete(n)}if(this.db)try{const a=await this.getFromIndexedDB(n);if(a&&Date.now()-a.timestamp<this.ttl)return this.memoryCache.set(n,a),a.data}catch(a){console.debug("IndexedDB read error:",a)}return null}async set(t,e,n){const a=this.generateKey(t,e),i={key:a,data:n,timestamp:Date.now()};if(this.memoryCache.set(a,i),this.memoryCache.size>this.maxSize){const r=this.memoryCache.keys().next().value;this.memoryCache.delete(r)}if(this.db)try{await this.setInIndexedDB(i)}catch(r){console.debug("IndexedDB write error:",r)}}getFromIndexedDB(t){return new Promise((e,n)=>{if(!this.db){e(null);return}const r=this.db.transaction(["responses"],"readonly").objectStore("responses").get(t);r.onsuccess=()=>e(r.result||null),r.onerror=()=>n(r.error)})}setInIndexedDB(t){return new Promise((e,n)=>{if(!this.db){e();return}const r=this.db.transaction(["responses"],"readwrite").objectStore("responses").put(t);r.onsuccess=()=>e(),r.onerror=()=>n(r.error)})}async clear(){if(this.memoryCache.clear(),this.db)return new Promise((t,e)=>{const i=this.db.transaction(["responses"],"readwrite").objectStore("responses").clear();i.onsuccess=()=>t(),i.onerror=()=>e(i.error)})}async clearExpired(){const t=Date.now(),e=[];for(const[n,a]of this.memoryCache.entries())t-a.timestamp>=this.ttl&&e.push(n);if(e.forEach(n=>this.memoryCache.delete(n)),this.db)try{const i=this.db.transaction(["responses"],"readwrite").objectStore("responses").index("timestamp"),r=IDBKeyRange.upperBound(t-this.ttl),c=i.openCursor(r);c.onsuccess=l=>{const o=l.target.result;o&&(o.delete(),o.continue())}}catch(n){console.debug("Failed to clear expired IndexedDB entries:",n)}}getCacheStats(){return{memoryEntries:this.memoryCache.size,maxSize:this.maxSize,ttl:this.ttl}}}const us="Monochrome",ms="Unknown Title",he="Unknown Artist",hs="Unknown Album";async function Ae(s,t,e,n){const a=Le(n);return a==="flac"?await fs(s,t,e):a==="m4a"?await vs(s,t,e):s}async function fs(s,t,e){try{const n=await s.arrayBuffer(),a=new DataView(n);if(!gs(a))return console.warn("Not a valid FLAC file, returning original"),s;const i=ps(a),r=ys(t);let c=null;if(t.album?.cover)try{c=await bs(t.album.cover,e)}catch(o){console.warn("Failed to embed album art:",o)}const l=ws(a,i,r,c);return new Blob([l],{type:"audio/flac"})}catch(n){return console.error("Failed to add FLAC metadata:",n),s}}function gs(s){return s.byteLength>=4&&s.getUint8(0)===102&&s.getUint8(1)===76&&s.getUint8(2)===97&&s.getUint8(3)===67}function ps(s){const t=[];let e=4;for(;e+4<=s.byteLength;){const n=s.getUint8(e),a=(n&128)!==0,i=n&127,r=s.getUint8(e+1)<<16|s.getUint8(e+2)<<8|s.getUint8(e+3);if(e+4+r>s.byteLength){console.warn("Invalid block size detected, stopping parse");break}if(t.push({type:i,isLast:a,size:r,offset:e+4,headerOffset:e}),e+=4+r,a){t.audioDataOffset=e;break}}return t}function ys(s){const t=[];s.title&&t.push(["TITLE",s.title]),s.artist?.name&&t.push(["ARTIST",s.artist.name]),s.album?.title&&t.push(["ALBUM",s.album.title]),s.album?.artist?.name&&t.push(["ALBUMARTIST",s.album.artist.name]),s.trackNumber&&t.push(["TRACKNUMBER",String(s.trackNumber)]),s.album?.numberOfTracks&&t.push(["TRACKTOTAL",String(s.album.numberOfTracks)]);const e=s.album?.releaseDate||(s.streamStartDate?s.streamStartDate.split("T")[0]:"");if(e)try{const h=new Date(e).getFullYear();isNaN(h)||t.push(["DATE",String(h)])}catch{}s.copyright&&t.push(["COPYRIGHT",s.copyright]),s.isrc&&t.push(["ISRC",s.isrc]);const n=us,a=new TextEncoder().encode(n);let i=4+a.length+4;const r=t.map(([h,u])=>{const m=`${h}=${u}`,f=new TextEncoder().encode(m);return i+=4+f.length,f}),c=new ArrayBuffer(i),l=new DataView(c),o=new Uint8Array(c);let d=0;l.setUint32(d,a.length,!0),d+=4,o.set(a,d),d+=a.length,l.setUint32(d,t.length,!0),d+=4;for(const h of r)l.setUint32(d,h.length,!0),d+=4,o.set(h,d),d+=h.length;return o}async function bs(s,t){try{const e=await _t(t,s);if(!e)throw new Error("Failed to fetch album art");const n=new Uint8Array(await e.arrayBuffer()),a=e.type||"image/jpeg",i=new TextEncoder().encode(a),c=new TextEncoder().encode(""),l=8+i.length+4+c.length+4+4+4+4+4+n.length,o=new ArrayBuffer(l),d=new DataView(o),h=new Uint8Array(o);let u=0;return d.setUint32(u,3,!1),u+=4,d.setUint32(u,i.length,!1),u+=4,h.set(i,u),u+=i.length,d.setUint32(u,c.length,!1),u+=4,c.length>0&&(h.set(c,u),u+=c.length),d.setUint32(u,0,!1),u+=4,d.setUint32(u,0,!1),u+=4,d.setUint32(u,0,!1),u+=4,d.setUint32(u,0,!1),u+=4,d.setUint32(u,n.length,!1),u+=4,h.set(n,u),h}catch(e){return console.error("Failed to create FLAC picture block:",e),null}}function ws(s,t,e,n){const a=new Uint8Array(s.buffer),i=t.filter(f=>f.type!==4&&f.type!==6);let r=4;for(const f of i)r+=4+f.size;r+=4+e.length,n&&(r+=4+n.length);const c=t.audioDataOffset;if(c===void 0)throw new Error("Invalid FLAC file structure: unable to locate audio data stream");const l=s.byteLength-c;r+=l;const o=new Uint8Array(r);let d=0;o[d++]=102,o[d++]=76,o[d++]=97,o[d++]=67;for(let f=0;f<i.length;f++){const g=i[f],p=0|g.type;o[d++]=p,o[d++]=g.size>>16&255,o[d++]=g.size>>8&255,o[d++]=g.size&255,o.set(a.subarray(g.offset,g.offset+g.size),d),d+=g.size}const h=d,u=4;o[d++]=u,o[d++]=e.length>>16&255,o[d++]=e.length>>8&255,o[d++]=e.length&255,o.set(e,d),d+=e.length;let m=h;if(n){const f=d,g=6;o[d++]=g,o[d++]=n.length>>16&255,o[d++]=n.length>>8&255,o[d++]=n.length&255,o.set(n,d),d+=n.length,m=f}return o[m]|=128,l>0&&o.set(a.subarray(c,c+l),d),o}async function vs(s,t,e){try{const n=await s.arrayBuffer(),a=new DataView(n),i=Ce(a),r=ks(t);if(t.album?.cover)try{const l=await _t(e,t.album.cover);if(l){const o=new Uint8Array(await l.arrayBuffer());r.cover={type:"covr",data:o}}}catch(l){console.warn("Failed to embed album art in M4A:",l)}const c=Ts(a,i,r);return new Blob([c],{type:"audio/mp4"})}catch(n){return console.error("Failed to add M4A metadata:",n),s}}function Ce(s){const t=[];let e=0;for(;e+8<=s.byteLength;){let n=s.getUint32(e,!1);if(n===0)n=s.byteLength-e;else if(n===1){if(e+16>s.byteLength)break;const i=s.getUint32(e+8,!1),r=s.getUint32(e+12,!1);if(i!==0){console.warn("64-bit MP4 atoms larger than 4GB are not supported - file may be processed incompletely");break}n=r}if(n<8||e+n>s.byteLength)break;const a=String.fromCharCode(s.getUint8(e+4),s.getUint8(e+5),s.getUint8(e+6),s.getUint8(e+7));t.push({type:a,offset:e,size:n}),e+=n}return t}function ks(s){const t={"©nam":s.title||ms,"©ART":s.artist?.name||he,"©alb":s.album?.title||hs,aART:s.album?.artist?.name||he};s.trackNumber&&(t.trkn=s.trackNumber);const e=s.album?.releaseDate||(s.streamStartDate?s.streamStartDate.split("T")[0]:"");if(e)try{const n=new Date(e).getFullYear();isNaN(n)||(t["©day"]=String(n))}catch{}return{tags:t}}function Ts(s,t,e){const n=new Uint8Array(s.buffer),a=t.find(v=>v.type==="moov");if(!a)return console.warn("No moov atom found in M4A file"),n;const i=Es(e),c=Ce(new DataView(n.buffer,a.offset+8,a.size-8)).filter(v=>v.type!=="udta");let l=8;for(const v of c)l+=v.size;l+=i.length;const o=l-a.size,d=n.length+o,h=new Uint8Array(d);let u=0,m=0;const f=t.filter(v=>v.offset<a.offset);for(const v of f)h.set(n.subarray(v.offset,v.offset+v.size),u),u+=v.size,m+=v.size;h[u++]=l>>24&255,h[u++]=l>>16&255,h[u++]=l>>8&255,h[u++]=l&255,h[u++]=109,h[u++]=111,h[u++]=111,h[u++]=118;for(const v of c){a.offset+8+v.offset;const I=a.offset+8+v.offset;h.set(n.subarray(I,I+v.size),u),u+=v.size}h.set(i,u),u+=i.length,m=a.offset+a.size;const g=t.find(v=>v.type==="mdat");return g&&a.offset<g.offset&&xs(h,u-l,l,o),m<n.length&&h.set(n.subarray(m),u),h}function Es(s){const{tags:t,cover:e}=s,n=[];for(const[p,v]of Object.entries(t))p==="trkn"?n.push(Ls(p,v)):n.push(Ss(p,v));e&&n.push(Is(e.data));const a=8+n.reduce((p,v)=>p+v.length,0),i=new Uint8Array(a);let r=0;Z(i,r,a,"ilst"),r+=8;for(const p of n)i.set(p,r),r+=p.length;const c=12+a,l=new Uint8Array(c);r=0,Z(l,r,c,"meta"),r+=8,l[r++]=0,l[r++]=0,l[r++]=0,l[r++]=0,l.set(i,r);const o=new Uint8Array([0,0,0,0,0,0,0,0,109,100,105,114,97,112,112,108,0,0,0,0,0,0,0,0,0,0]),d=8+o.length,h=new Uint8Array(d);Z(h,0,d,"hdlr"),h.set(o,8);const u=12+d+a,m=new Uint8Array(u);r=0,Z(m,r,u,"meta"),r+=8,m[r++]=0,m[r++]=0,m[r++]=0,m[r++]=0,m.set(h,r),r+=d,m.set(i,r);const f=8+u,g=new Uint8Array(f);return Z(g,0,f,"udta"),g.set(m,8),g}function Ss(s,t){const e=new TextEncoder().encode(t),n=16+e.length,a=8+n,i=new Uint8Array(a);let r=0;return Z(i,r,a,s),r+=8,Z(i,r,n,"data"),r+=8,i[r++]=0,i[r++]=0,i[r++]=0,i[r++]=1,i[r++]=0,i[r++]=0,i[r++]=0,i[r++]=0,i.set(e,r),i}function Ls(s,t){const a=new Uint8Array(32);let i=0;Z(a,i,32,s),i+=8,Z(a,i,24,"data"),i+=8,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0;const r=parseInt(t)||0;return a[i++]=r>>8&255,a[i++]=r&255,a[i++]=0,a[i++]=0,a[i++]=0,a[i++]=0,a}function Is(s){const t=16+s.length,e=8+t,n=new Uint8Array(e);let a=0;Z(n,a,e,"covr"),a+=8,Z(n,a,t,"data"),a+=8;let i=13;return s[0]===137&&s[1]===80&&(i=14),n[a++]=0,n[a++]=0,n[a++]=0,n[a++]=i,n[a++]=0,n[a++]=0,n[a++]=0,n[a++]=0,n.set(s,a),n}function Z(s,t,e,n){s[t++]=e>>24&255,s[t++]=e>>16&255,s[t++]=e>>8&255,s[t++]=e&255;for(let a=0;a<4;a++)s[t++]=n.charCodeAt(a)}function xs(s,t,e,n){const a=new DataView(s.buffer,s.byteOffset,s.byteLength);let i=t+8;const r=t+e;Me(a,i,r,n)}function Me(s,t,e,n){let a=t;for(;a+8<=e;){const i=s.getUint32(a,!1),r=String.fromCharCode(s.getUint8(a+4),s.getUint8(a+5),s.getUint8(a+6),s.getUint8(a+7));if(i<8)break;if(r==="trak"||r==="mdia"||r==="minf"||r==="stbl")Me(s,a+8,a+i,n);else if(r==="stco"){const c=s.getUint32(a+12,!1);for(let l=0;l<c;l++){const o=a+16+l*4,d=s.getUint32(o,!1);s.setUint32(o,d+n,!1)}}else if(r==="co64"){const c=s.getUint32(a+12,!1);for(let l=0;l<c;l++){const o=a+16+l*8,d=s.getUint32(o,!1);let u=s.getUint32(o+4,!1)+n,m=0;u>4294967295&&(m=Math.floor(u/4294967296),u=u>>>0);const f=d+m;s.setUint32(o,f,!1),s.setUint32(o+4,u,!1)}}a+=i}}class As{constructor(t){this.settings=t,this.cache=new ds({maxSize:200,ttl:1e3*60*30}),this.streamCache=new Map,setInterval(()=>{this.cache.clearExpired(),this.pruneStreamCache()},1e3*60*5)}pruneStreamCache(){if(this.streamCache.size>50){const t=Array.from(this.streamCache.entries());t.slice(0,t.length-50).forEach(([n])=>this.streamCache.delete(n))}}async fetchWithRetry(t,e={}){const n=e.type||"api",a=await this.settings.getInstances(n);if(a.length===0)throw new Error(`No API instances configured for type: ${n}`);const i=3;let r=null;for(const c of a){const l=c.endsWith("/")?`${c}${t.substring(1)}`:`${c}${t}`;for(let o=1;o<=i;o++)try{const d=await fetch(l,{signal:e.signal});if(d.status===429){const h=d.headers.get("Retry-After");let u=2e3*o;if(h){const m=parseInt(h,10);isNaN(m)||(u=m*1e3)}console.warn(`Rate limit hit. Waiting ${u}ms before retry ${o}/${i}...`),await Dt(u);continue}if(d.ok)return d;if(d.status===401){let h=await d.clone().json();if(h?.subStatus===11002&&(r=new Error(h?.userMessage||"Authentication failed"),o<i)){await Dt(200*o);continue}}if(d.status>=500&&o<i){await Dt(200*o);continue}r=new Error(`Request failed with status ${d.status}`);break}catch(d){if(d.name==="AbortError")throw d;r=d,o<i&&await Dt(200*o)}}throw r||new Error(`All API instances failed for: ${t}`)}findSearchSection(t,e,n){if(!(!t||typeof t!="object")){if(Array.isArray(t)){for(const a of t){const i=this.findSearchSection(a,e,n);if(i)return i}return}if(!n.has(t)){if(n.add(t),"items"in t&&Array.isArray(t.items))return t;if(e in t){const a=this.findSearchSection(t[e],e,n);if(a)return a}for(const a of Object.values(t)){const i=this.findSearchSection(a,e,n);if(i)return i}}}}buildSearchResponse(t){const e=t?.items??[];return{items:e,limit:t?.limit??e.length,offset:t?.offset??0,totalNumberOfItems:t?.totalNumberOfItems??e.length}}normalizeSearchResponse(t,e){const n=this.findSearchSection(t,e,new Set);return this.buildSearchResponse(n)}prepareTrack(t){let e=t;!t.artist&&Array.isArray(t.artists)&&t.artists.length>0&&(e={...t,artist:t.artists[0]});const n=ls(e);return n&&e.audioQuality!==n&&(e={...e,audioQuality:n}),e}prepareAlbum(t){return!t.artist&&Array.isArray(t.artists)&&t.artists.length>0?{...t,artist:t.artists[0]}:t}preparePlaylist(t){return t}prepareArtist(t){return!t.type&&Array.isArray(t.artistTypes)&&t.artistTypes.length>0?{...t,type:t.artistTypes[0]}:t}parseTrackLookup(t){const e=Array.isArray(t)?t:[t];let n,a,i;for(const r of e)if(!(!r||typeof r!="object")){if(!n&&"duration"in r){n=r;continue}if(!a&&"manifest"in r){a=r;continue}if(!i&&"OriginalTrackUrl"in r){const c=r.OriginalTrackUrl;typeof c=="string"&&(i=c)}}if(!n||!a)throw new Error("Malformed track response");return{track:n,info:a,originalTrackUrl:i}}extractStreamUrlFromManifest(t){try{const e=atob(t);try{const n=JSON.parse(e);if(n?.urls?.[0])return n.urls[0]}catch{const n=e.match(/https?:\/\/[\w\-.~:?#[@!$&'()*+,;=%/]+/);return n?n[0]:null}}catch(e){return console.error("Failed to decode manifest:",e),null}}deduplicateAlbums(t){const e=new Map;for(const n of t){const a=JSON.stringify([n.title,n.numberOfTracks||0]);if(e.has(a)){const i=e.get(a);if(n.explicit&&!i.explicit){e.set(a,n);continue}if(!n.explicit&&i.explicit)continue;const r=i.mediaMetadata?.tags?.length||0;(n.mediaMetadata?.tags?.length||0)>r&&e.set(a,n)}else e.set(a,n)}return Array.from(e.values())}async searchTracks(t,e={}){const n=await this.cache.get("search_tracks",t);if(n)return n;try{const i=await(await this.fetchWithRetry(`/search/?s=${encodeURIComponent(t)}`,e)).json(),r=this.normalizeSearchResponse(i,"tracks"),c={...r,items:r.items.map(l=>this.prepareTrack(l))};return await this.cache.set("search_tracks",t,c),c}catch(a){if(a.name==="AbortError")throw a;return console.error("Track search failed:",a),{items:[],limit:0,offset:0,totalNumberOfItems:0}}}async searchArtists(t,e={}){const n=await this.cache.get("search_artists",t);if(n)return n;try{const i=await(await this.fetchWithRetry(`/search/?a=${encodeURIComponent(t)}`,e)).json(),r=this.normalizeSearchResponse(i,"artists"),c={...r,items:r.items.map(l=>this.prepareArtist(l))};return await this.cache.set("search_artists",t,c),c}catch(a){if(a.name==="AbortError")throw a;return console.error("Artist search failed:",a),{items:[],limit:0,offset:0,totalNumberOfItems:0}}}async searchAlbums(t,e={}){const n=await this.cache.get("search_albums",t);if(n)return n;try{const i=await(await this.fetchWithRetry(`/search/?al=${encodeURIComponent(t)}`,e)).json(),r=this.normalizeSearchResponse(i,"albums"),c=r.items.map(o=>this.prepareAlbum(o)),l={...r,items:this.deduplicateAlbums(c)};return await this.cache.set("search_albums",t,l),l}catch(a){if(a.name==="AbortError")throw a;return console.error("Album search failed:",a),{items:[],limit:0,offset:0,totalNumberOfItems:0}}}async searchPlaylists(t,e={}){const n=await this.cache.get("search_playlists",t);if(n)return n;try{const i=await(await this.fetchWithRetry(`/search/?p=${encodeURIComponent(t)}`,e)).json(),r=this.normalizeSearchResponse(i,"playlists"),c={...r,items:r.items.map(l=>this.preparePlaylist(l))};return await this.cache.set("search_playlists",t,c),c}catch(a){if(a.name==="AbortError")throw a;return console.error("Playlist search failed:",a),{items:[],limit:0,offset:0,totalNumberOfItems:0}}}async getAlbum(t){const e=await this.cache.get("album",t);if(e)return e;const a=await(await this.fetchWithRetry(`/album/?id=${t}`)).json(),i=a.data||a;let r,c;if(i&&typeof i=="object"&&!Array.isArray(i)&&(("numberOfTracks"in i||"title"in i)&&(r=this.prepareAlbum(i)),"items"in i&&(c=i,!r&&i.items&&i.items.length>0))){const d=i.items[0],h=d.item||d;h&&h.album&&(r=this.prepareAlbum(h.album))}if(!r)throw new Error("Album not found");if(r&&!r.artist&&c?.items&&c.items.length>0){const d=c.items[0],h=d.item||d;h&&h.artist&&(r={...r,artist:h.artist})}if(r&&!r.releaseDate&&c?.items&&c.items.length>0){const d=c.items[0],h=d.item||d;h&&(h.album&&h.album.releaseDate?r={...r,releaseDate:h.album.releaseDate}:h.streamStartDate&&(r={...r,releaseDate:h.streamStartDate.split("T")[0]}))}const l=(c?.items||[]).map(d=>this.prepareTrack(d.item||d)),o={album:r,tracks:l};return await this.cache.set("album",t,o),o}async getPlaylist(t){const e=await this.cache.get("playlist",t);if(e)return e;const a=await(await this.fetchWithRetry(`/playlist/?id=${t}`)).json(),i=a.data||a;let r=null,c=null;if(i.playlist&&(r=i.playlist),i.items&&(c={items:i.items}),!r||!c){const d=Array.isArray(i)?i:[i];for(const h of d)!h||typeof h!="object"||(!r&&("uuid"in h||"numberOfTracks"in h||"title"in h&&"id"in h)&&(r=h),!c&&"items"in h&&(c=h))}if(!r&&Array.isArray(i)){for(const d of i)if(d&&typeof d=="object"&&("uuid"in d||"numberOfTracks"in d)){r=d;break}}if(!r)throw new Error("Playlist not found");let l=(c?.items||[]).map(d=>this.prepareTrack(d.item||d));if(r.numberOfTracks>l.length){let d=l.length;const h=1e4;for(;l.length<r.numberOfTracks&&l.length<h;)try{const m=await(await this.fetchWithRetry(`/playlist/?id=${t}&offset=${d}`)).json(),f=m.data||m;let g=[];if(f.items)g=f.items;else if(Array.isArray(f)){for(const v of f)if(v&&typeof v=="object"&&"items"in v&&Array.isArray(v.items)){g=v.items;break}}if(!g||g.length===0)break;const p=g.map(v=>this.prepareTrack(v.item||v));if(p.length===0||l.length>0&&p[0].id===l[0].id)break;l=l.concat(p),d+=p.length}catch(u){console.error(`Error fetching playlist tracks at offset ${d}:`,u);break}}const o={playlist:r,tracks:l};return await this.cache.set("playlist",t,o),o}async getMix(t){const e=await this.cache.get("mix",t);if(e)return e;const a=await(await this.fetchWithRetry(`/mix/?id=${t}`,{type:"api"})).json(),i=a.mix,r=a.items||[];if(!i)throw new Error("Mix metadata not found");const c=r.map(d=>this.prepareTrack(d.item||d)),o={mix:{id:i.id,title:i.title,subTitle:i.subTitle,description:i.description,mixType:i.mixType,cover:i.images?.LARGE?.url||i.images?.MEDIUM?.url||i.images?.SMALL?.url||null},tracks:c};return await this.cache.set("mix",t,o),o}async getArtist(t){const e=await this.cache.get("artist",t);if(e)return e;const[n,a]=await Promise.all([this.fetchWithRetry(`/artist/?id=${t}`),this.fetchWithRetry(`/artist/?f=${t}&skip_tracks=true`)]),i=await n.json();let r=i.data||i;const c=r.artist||(Array.isArray(r)?r[0]:r);if(!c)throw new Error("Primary artist details not found.");const l={...this.prepareArtist(c),picture:c.picture||r.cover||null,name:c.name||"Unknown Artist"},o=await a.json(),d=o.data||o,h=Array.isArray(d)?d:[d],u=new Map,m=new Map,f=w=>w?.id&&w.duration&&w.album,g=w=>w?.id&&"numberOfTracks"in w,p=(w,S=new Set)=>{if(!w||typeof w!="object"||S.has(w))return;if(S.add(w),Array.isArray(w)){w.forEach(x=>p(x,S));return}const L=w.item||w;g(L)&&u.set(L.id,this.prepareAlbum(L)),f(L)&&m.set(L.id,this.prepareTrack(L)),Object.values(w).forEach(x=>p(x,S))};h.forEach(w=>p(w));try{const w=await this.searchAlbums(l.name);if(w&&w.items){const S=Number(t);for(const L of w.items)(L.artist?.id===S||Array.isArray(L.artists)&&L.artists.some(A=>A.id===S))&&!u.has(L.id)&&u.set(L.id,L)}}catch(w){console.warn("Failed to fetch additional albums via search:",w)}const v=Array.from(u.values()),I=this.deduplicateAlbums(v).sort((w,S)=>new Date(S.releaseDate||0)-new Date(w.releaseDate||0)),y=I.filter(w=>w.type==="EP"||w.type==="SINGLE"),b=I.filter(w=>!y.includes(w)),T=Array.from(m.values()).sort((w,S)=>(S.popularity||0)-(w.popularity||0)).slice(0,15),k={...l,albums:b,eps:y,tracks:T};return await this.cache.set("artist",t,k),k}async getSimilarArtists(t){const e=await this.cache.get("similar_artists",t);if(e)return e;try{const a=await(await this.fetchWithRetry(`/artist/similar/?id=${t}`,{type:"api"})).json(),r=(a.artists||a.items||a.data||(Array.isArray(a)?a:[])).map(c=>this.prepareArtist(c));return await this.cache.set("similar_artists",t,r),r}catch(n){return console.warn("Failed to fetch similar artists:",n),[]}}async getSimilarAlbums(t){const e=await this.cache.get("similar_albums",t);if(e)return e;try{const a=await(await this.fetchWithRetry(`/album/similar/?id=${t}`,{type:"api"})).json(),r=(a.items||a.albums||a.data||(Array.isArray(a)?a:[])).map(c=>this.prepareAlbum(c));return await this.cache.set("similar_albums",t,r),r}catch(n){return console.warn("Failed to fetch similar albums:",n),[]}}async getRecommendedTracksForPlaylist(t,e=20){const n=new Map;for(const o of t)if(o.artist&&o.artist.id&&n.set(o.artist.id,o.artist),o.artists&&Array.isArray(o.artists))for(const d of o.artists)d.id&&n.set(d.id,d);if(n.size<3){console.log("Not enough artists from stored data, trying search approach...");for(const o of t.slice(0,5))try{const d=`"${o.title}" ${o.artist?.name||""}`.trim(),h=await this.searchTracks(d,{signal:AbortSignal.timeout(5e3)});if(h.items&&h.items.length>0){const u=h.items[0];if(u.artist&&u.artist.id&&n.set(u.artist.id,u.artist),u.artists&&Array.isArray(u.artists))for(const m of u.artists)m.id&&n.set(m.id,m)}}catch(d){console.warn(`Search failed for track "${o.title}":`,d)}}const a=Array.from(n.values());if(console.log(`Found ${a.length} unique artists from ${t.length} tracks`),a.length===0)return console.log("No artists found, cannot generate recommendations"),[];const i=[],r=new Set(t.map(o=>o.id)),c=a.slice(0,Math.min(5,a.length));console.log(`Processing ${c.length} artists for recommendations`);for(const o of c)try{console.log(`Fetching tracks for artist: ${o.name} (ID: ${o.id})`);const d=await this.getArtist(o.id);if(d&&d.tracks&&d.tracks.length>0){const h=d.tracks.filter(u=>!r.has(u.id)).slice(0,4);console.log(`Found ${h.length} new tracks from ${o.name}`),i.push(...h),r.add(...h.map(u=>u.id))}else console.warn(`No tracks found for artist ${o.name}`)}catch(d){console.warn(`Failed to get tracks for artist ${o.name}:`,d)}return console.log(`Total recommended tracks found: ${i.length}`),i.sort(()=>.5-Math.random()).slice(0,e)}normalizeTrackResponse(t){if(!t||typeof t!="object")return t;const e=t.data??t;return[{duration:e.duration??0,id:e.trackId??null},e]}async getTrack(t,e="LOSSLESS"){const n=`${t}_${e}`,a=await this.cache.get("track",n);if(a)return a;const r=await(await this.fetchWithRetry(`/track/?id=${t}&quality=${e}`,{type:"streaming"})).json(),c=this.parseTrackLookup(this.normalizeTrackResponse(r));return await this.cache.set("track",n,c),c}async getStreamUrl(t,e="LOSSLESS"){const n=`stream_${t}_${e}`;if(this.streamCache.has(n))return this.streamCache.get(n);const a=await this.getTrack(t,e);let i;if(a.originalTrackUrl)i=a.originalTrackUrl;else if(i=this.extractStreamUrlFromManifest(a.info.manifest),!i)throw new Error("Could not resolve stream URL");return this.streamCache.set(n,i),i}async downloadTrack(t,e="LOSSLESS",n,a={}){const{onProgress:i,track:r}=a;try{const c=await this.getTrack(t,e);let l;if(c.originalTrackUrl)l=c.originalTrackUrl;else if(l=this.extractStreamUrlFromManifest(c.info.manifest),!l)throw new Error("Could not resolve stream URL");const o=await fetch(l,{cache:"no-store",signal:a.signal});if(!o.ok)throw new Error(`Fetch failed: ${o.status}`);const d=o.headers.get("Content-Length"),h=d?parseInt(d,10):0;let u=0,m;if(o.body&&i){const f=o.body.getReader(),g=[];for(;;){const{done:p,value:v}=await f.read();if(p)break;v&&(g.push(v),u+=v.byteLength,i({stage:"downloading",receivedBytes:u,totalBytes:h||void 0}))}m=new Blob(g,{type:o.headers.get("Content-Type")||"audio/flac"})}else m=await o.blob(),i&&i({stage:"downloading",receivedBytes:m.size,totalBytes:m.size});r&&(i&&i({stage:"processing",message:"Adding metadata..."}),m=await Ae(m,r,this,e)),this.triggerDownload(m,n)}catch(c){throw c.name==="AbortError"||(console.error("Download failed:",c),c.message===Se)?c:new Error("Download failed. The stream may require a proxy.")}}triggerDownload(t,e){const n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download=e,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}getCoverUrl(t,e="320"){return t?`https://resources.tidal.com/images/${t.replace(/-/g,"/")}/${e}x${e}.jpg`:`https://picsum.photos/seed/${Math.random()}/${e}`}getArtistPictureUrl(t,e="320"){return t?`https://resources.tidal.com/images/${t.replace(/-/g,"/")}/${e}x${e}.jpg`:`https://picsum.photos/seed/${Math.random()}/${e}`}async clearCache(){await this.cache.clear(),this.streamCache.clear()}getCacheStats(){return{...this.cache.getCacheStats(),streamUrls:this.streamCache.size}}}const Cs={STORAGE_KEY:"monochrome-api-instances-v2",INSTANCES_URL:"instances.json",SPEED_TEST_CACHE_KEY:"monochrome-instance-speeds",SPEED_TEST_CACHE_DURATION:1e3*60*60,defaultInstances:{api:[],streaming:[]},instancesLoaded:!1,async loadInstancesFromGitHub(){if(this.instancesLoaded)return this.defaultInstances;try{const s=await fetch(this.INSTANCES_URL);if(!s.ok)throw new Error("Failed to fetch instances");const t=await s.json();let e={api:[],streaming:[]};if(Array.isArray(t))e.api=[...t],e.streaming=[...t];else{if(t.api&&Array.isArray(t.api))if(t.api.length>0&&typeof t.api[0]=="string")e.api=[...t.api];else for(const[a,i]of Object.entries(t.api))i.cors===!1&&Array.isArray(i.urls)&&e.api.push(...i.urls);t.streaming&&Array.isArray(t.streaming)?e.streaming=[...t.streaming]:e.api.length>0&&(e.streaming=[...e.api])}return this.defaultInstances=e,this.instancesLoaded=!0,e}catch(s){return console.error("Failed to load instances from GitHub:",s),this.defaultInstances={api:["https://tidal-api.binimum.org","https://monochrome-api.samidy.com"],streaming:["https://triton.squid.wtf","https://wolf.qqdl.site","https://maus.qqdl.site","https://vogel.qqdl.site","https://katze.qqdl.site","https://hund.qqdl.site","https://tidal.kinoplus.online","https://tidal-api.binimum.org"]},this.instancesLoaded=!0,this.defaultInstances}},async speedTestInstance(s,t="api"){let e;t==="streaming"?e=s.endsWith("/")?`${s}track/?id=204567804&quality=HIGH`:`${s}/track/?id=204567804&quality=HIGH`:e=s.endsWith("/")?`${s}artist/?id=3532302`:`${s}/artist/?id=3532302`;const n=performance.now();try{const a=new AbortController,i=setTimeout(()=>a.abort(),5e3),r=await fetch(e,{signal:a.signal,cache:"no-store"});if(clearTimeout(i),!r.ok)return{url:s,type:t,speed:1/0,error:`HTTP ${r.status}`};const l=performance.now()-n;return{url:s,type:t,speed:l,error:null}}catch(a){return{url:s,type:t,speed:1/0,error:a.message}}},getCachedSpeedTests(){try{const s=localStorage.getItem(this.SPEED_TEST_CACHE_KEY);if(!s)return{speeds:{},timestamp:Date.now()};const t=JSON.parse(s);return Date.now()-t.timestamp>this.SPEED_TEST_CACHE_DURATION?{speeds:{},timestamp:Date.now()}:t}catch{return{speeds:{},timestamp:Date.now()}}},updateSpeedCache(s){const t=this.getCachedSpeedTests();s.forEach(e=>{const n=e.type==="streaming"?`${e.url}#streaming`:e.url;t.speeds[n]={speed:e.speed,error:e.error}}),t.timestamp=Date.now();try{localStorage.setItem(this.SPEED_TEST_CACHE_KEY,JSON.stringify(t))}catch{console.warn("[SpeedTest] Failed to cache results")}return t},async testSpecificUrls(s,t){if(!s||s.length===0)return[];console.log(`[SpeedTest] Testing ${s.length} instances for ${t}...`);const e=await Promise.all(s.map(a=>this.speedTestInstance(a,t))),n=e.filter(a=>a.speed!==1/0);return console.log(`[SpeedTest] ${t} Results:`,n.map(a=>`${a.url}: ${a.speed.toFixed(0)}ms`)),e},async getInstances(s="api"){let t;const e=localStorage.getItem(this.STORAGE_KEY);e&&(t=JSON.parse(e)),t||(t=await this.loadInstancesFromGitHub());const n=t[s]||t.api||[];if(n.length===0)return[];const a=this.getCachedSpeedTests(),i=o=>s==="streaming"?`${o}#streaming`:o,r=n.filter(o=>!a.speeds[i(o)]);if(r.length>0){const o=await this.testSpecificUrls(r,s);this.updateSpeedCache(o),Object.assign(a,this.getCachedSpeedTests())}const l=(o=>[...o].sort((d,h)=>{const u=a.speeds[i(d)]?.speed??1/0,m=a.speeds[i(h)]?.speed??1/0;return u-m}))(n);return t[s]=l,this.saveInstances(t),l},async refreshSpeedTests(){const s=await this.loadInstancesFromGitHub(),t=[];s.api&&s.api.length&&t.push(this.testSpecificUrls(s.api,"api")),s.streaming&&s.streaming.length&&t.push(this.testSpecificUrls(s.streaming,"streaming"));const n=(await Promise.all(t)).flat();return this.updateSpeedCache(n),this.getInstances("api")},saveInstances(s,t){if(t)try{const e=localStorage.getItem(this.STORAGE_KEY);let n=e?JSON.parse(e):{api:[],streaming:[]};n[t]=s,localStorage.setItem(this.STORAGE_KEY,JSON.stringify(n))}catch(e){console.error("Failed to save instances:",e)}else localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s))}},ht={STORAGE_KEY:"monochrome-recent-activity",LIMIT:10,_get(){try{const s=localStorage.getItem(this.STORAGE_KEY),t=s?JSON.parse(s):{artists:[],albums:[],playlists:[],mixes:[]};return t.playlists||(t.playlists=[]),t.mixes||(t.mixes=[]),t}catch{return{artists:[],albums:[],playlists:[],mixes:[]}}},_save(s){localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s))},getRecents(){return this._get()},_add(s,t){const e=this._get();e[s]=e[s].filter(n=>n.id!==t.id),e[s].unshift(t),e[s]=e[s].slice(0,this.LIMIT),this._save(e)},addArtist(s){this._add("artists",s)},addAlbum(s){this._add("albums",s)},addPlaylist(s){this._add("playlists",s)},addMix(s){this._add("mixes",s)}},ot={STORAGE_KEY:"monochrome-theme",CUSTOM_THEME_KEY:"monochrome-custom-theme",defaultThemes:{light:{},dark:{},monochrome:{},ocean:{},purple:{},forest:{},mocha:{},machiatto:{},frappe:{},latte:{}},getTheme(){try{return localStorage.getItem(this.STORAGE_KEY)||"system"}catch{return"system"}},setTheme(s){if(localStorage.setItem(this.STORAGE_KEY,s),s==="system"){const t=window.matchMedia("(prefers-color-scheme: dark)").matches;document.documentElement.setAttribute("data-theme",t?"dark":"light")}else document.documentElement.setAttribute("data-theme",s);if(s!=="custom"){const t=document.documentElement;["background","foreground","primary","secondary","muted","border","highlight"].forEach(e=>{t.style.removeProperty(`--${e}`)})}else{const t=this.getCustomTheme();t&&this.applyCustomTheme(t)}},getCustomTheme(){try{const s=localStorage.getItem(this.CUSTOM_THEME_KEY);return s?JSON.parse(s):null}catch{return null}},setCustomTheme(s){localStorage.setItem(this.CUSTOM_THEME_KEY,JSON.stringify(s)),this.applyCustomTheme(s),this.setTheme("custom")},applyCustomTheme(s){const t=document.documentElement;for(const[e,n]of Object.entries(s))t.style.setProperty(`--${e}`,n)}},lt={STORAGE_KEY:"lastfm-enabled",LOVE_ON_LIKE_KEY:"lastfm-love-on-like",isEnabled(){try{return localStorage.getItem(this.STORAGE_KEY)==="true"}catch{return!1}},setEnabled(s){localStorage.setItem(this.STORAGE_KEY,s?"true":"false")},shouldLoveOnLike(){try{return localStorage.getItem(this.LOVE_ON_LIKE_KEY)==="true"}catch{return!1}},setLoveOnLike(s){localStorage.setItem(this.LOVE_ON_LIKE_KEY,s?"true":"false")}},te={STORAGE_KEY:"now-playing-mode",getMode(){try{return localStorage.getItem(this.STORAGE_KEY)||"cover"}catch{return"cover"}},setMode(s){localStorage.setItem(this.STORAGE_KEY,s)}},At={DOWNLOAD_WITH_TRACKS:"lyrics-download-with-tracks",shouldDownloadLyrics(){try{return localStorage.getItem(this.DOWNLOAD_WITH_TRACKS)==="true"}catch{return!1}},setDownloadLyrics(s){localStorage.setItem(this.DOWNLOAD_WITH_TRACKS,s?"true":"false")}},yt={STORAGE_KEY:"album-background-enabled",isEnabled(){try{return localStorage.getItem(this.STORAGE_KEY)!=="false"}catch{return!0}},setEnabled(s){localStorage.setItem(this.STORAGE_KEY,s?"true":"false")}},ee={STORAGE_KEY:"track-list-actions-mode",getMode(){try{const s=localStorage.getItem(this.STORAGE_KEY)||"dropdown";return document.documentElement.setAttribute("data-track-actions-mode",s),s}catch{return"dropdown"}},setMode(s){localStorage.setItem(this.STORAGE_KEY,s),document.documentElement.setAttribute("data-track-actions-mode",s)}},nt={COMPACT_ARTIST_KEY:"card-compact-artist",COMPACT_ALBUM_KEY:"card-compact-album",isCompactArtist(){try{const s=localStorage.getItem(this.COMPACT_ARTIST_KEY);return s===null?!0:s==="true"}catch{return!0}},setCompactArtist(s){localStorage.setItem(this.COMPACT_ARTIST_KEY,s?"true":"false")},isCompactAlbum(){try{return localStorage.getItem(this.COMPACT_ALBUM_KEY)==="true"}catch{return!1}},setCompactAlbum(s){localStorage.setItem(this.COMPACT_ALBUM_KEY,s?"true":"false")}},bt={STORAGE_KEY_MODE:"replay-gain-mode",STORAGE_KEY_PREAMP:"replay-gain-preamp",getMode(){return localStorage.getItem(this.STORAGE_KEY_MODE)||"track"},setMode(s){localStorage.setItem(this.STORAGE_KEY_MODE,s)},getPreamp(){const s=parseFloat(localStorage.getItem(this.STORAGE_KEY_PREAMP));return isNaN(s)?3:s},setPreamp(s){localStorage.setItem(this.STORAGE_KEY_PREAMP,s)}},ct={STORAGE_KEY:"download-quality",getQuality(){try{return localStorage.getItem(this.STORAGE_KEY)||"LOSSLESS"}catch{return"LOSSLESS"}},setQuality(s){localStorage.setItem(this.STORAGE_KEY,s)}},se={STORAGE_KEY:"waveform-seekbar-enabled",isEnabled(){try{return localStorage.getItem(this.STORAGE_KEY)==="true"}catch{return!1}},setEnabled(s){localStorage.setItem(this.STORAGE_KEY,s?"true":"false")}},ne={STORAGE_KEY:"smooth-scrolling-enabled",isEnabled(){try{return localStorage.getItem(this.STORAGE_KEY)==="true"}catch{return!1}},setEnabled(s){localStorage.setItem(this.STORAGE_KEY,s?"true":"false")}},fe={STORAGE_KEY:"monochrome-queue",getQueue(){try{const s=localStorage.getItem(this.STORAGE_KEY);return s?JSON.parse(s):null}catch{return null}},saveQueue(s){try{const t={queue:s.queue,shuffledQueue:s.shuffledQueue,originalQueueBeforeShuffle:s.originalQueueBeforeShuffle,currentQueueIndex:s.currentQueueIndex,shuffleActive:s.shuffleActive,repeatMode:s.repeatMode};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t))}catch(t){console.warn("Failed to save queue to localStorage:",t)}}};typeof window<"u"&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",s=>{ot.getTheme()==="system"&&document.documentElement.setAttribute("data-theme",s.matches?"dark":"light")});class Ms{constructor(){this.panel=document.getElementById("side-panel"),this.titleElement=document.getElementById("side-panel-title"),this.controlsElement=document.getElementById("side-panel-controls"),this.contentElement=document.getElementById("side-panel-content"),this.currentView=null}open(t,e,n,a){if(this.currentView===t&&this.panel.classList.contains("active")){this.close();return}this.currentView=t,this.titleElement.textContent=e,this.controlsElement.innerHTML="",this.contentElement.innerHTML="",n&&n(this.controlsElement),a&&a(this.contentElement),this.panel.classList.add("active")}close(){this.panel.classList.remove("active"),this.currentView=null,setTimeout(()=>{this.panel.classList.contains("active")||(this.controlsElement.innerHTML="",this.contentElement.innerHTML="")},300)}isActive(t){return this.currentView===t&&this.panel.classList.contains("active")}refresh(t,e,n){this.isActive(t)&&(e&&(this.controlsElement.innerHTML="",e(this.controlsElement)),n&&(this.contentElement.innerHTML="",n(this.contentElement)))}updateContent(t,e){this.isActive(t)&&(this.contentElement.innerHTML="",e(this.contentElement))}}const j=new Ms;class Be{constructor(t){this.api=t,this.currentLyrics=null,this.syncedLyrics=[],this.lyricsCache=new Map,this.componentLoaded=!1,this.amLyricsElement=null,this.animationFrameId=null,this.currentTrackId=null,this.mutationObserver=null,this.romajiObserver=null,this.isRomajiMode=!1,this.originalLyricsData=null,this.kuroshiroLoaded=!1,this.kuroshiroLoading=!1,this.romajiTextCache=new Map,this.convertedTracksCache=new Set}async loadKuroshiro(){if(this.kuroshiroLoaded)return!0;if(this.kuroshiroLoading)return new Promise(t=>{const e=setInterval(()=>{this.kuroshiroLoading||(clearInterval(e),t(this.kuroshiroLoaded))},100)});this.kuroshiroLoading=!0;try{window._originalXHROpen||(window._originalXHROpen=XMLHttpRequest.prototype.open,XMLHttpRequest.prototype.open=function(n,a,...i){const r=a.toString();if(r.includes("/dict/")&&r.includes(".dat.gz")){const l=`https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/${r.split("/").pop()}`;return window._originalXHROpen.call(this,n,l,...i)}return window._originalXHROpen.call(this,n,a,...i)}),window._originalFetch||(window._originalFetch=window.fetch,window.fetch=async(n,a)=>{const i=n.toString();if(i.includes("/dict/")&&i.includes(".dat.gz")){const r=i.split("/").pop(),c=`https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/${r}`;return console.log(`Redirecting dict fetch: ${r} -> CDN`),window._originalFetch(c,a)}return window._originalFetch(n,a)}),window.Kuroshiro||await this.loadScript("https://unpkg.com/kuroshiro@1.2.0/dist/kuroshiro.min.js"),window.KuromojiAnalyzer||await this.loadScript("https://unpkg.com/kuroshiro-analyzer-kuromoji@1.1.0/dist/kuroshiro-analyzer-kuromoji.min.js");const t=window.Kuroshiro.default||window.Kuroshiro,e=window.KuromojiAnalyzer.default||window.KuromojiAnalyzer;return this.kuroshiro=new t,await this.kuroshiro.init(new e({dictPath:"/dict/"})),this.kuroshiroLoaded=!0,this.kuroshiroLoading=!1,console.log("✓ Kuroshiro loaded and initialized successfully"),!0}catch(t){return console.error("✗ Failed to load Kuroshiro:",t),this.kuroshiroLoaded=!1,this.kuroshiroLoading=!1,!1}}loadScript(t){return new Promise((e,n)=>{if(document.querySelector(`script[src="${t}"]`)){e();return}const a=document.createElement("script");a.src=t,a.onload=e,a.onerror=()=>n(new Error(`Failed to load script: ${t}`)),document.head.appendChild(a)})}containsJapanese(t){return t?/[\u3040-\u30FF\u31F0-\u9FFF]/.test(t):!1}async convertToRomaji(t){if(!t)return t;if(this.romajiTextCache.has(t))return this.romajiTextCache.get(t);if(!this.kuroshiroLoaded&&!await this.loadKuroshiro()||!this.kuroshiro)return console.warn("Kuroshiro not available, skipping conversion"),t;try{const e=await this.kuroshiro.convert(t,{to:"romaji",mode:"spaced",romajiSystem:"hepburn"});return this.romajiTextCache.set(t,e),e}catch(e){return console.warn("Romaji conversion failed for text:",t.substring(0,30),e),t}}setRomajiMode(t){this.isRomajiMode=t;try{localStorage.setItem("lyricsRomajiMode",t?"true":"false")}catch(e){console.warn("Failed to save Romaji mode preference:",e)}}getRomajiMode(){try{return localStorage.getItem("lyricsRomajiMode")==="true"}catch{return!1}}async ensureComponentLoaded(){if(!this.componentLoaded){if(typeof customElements<"u"&&customElements.get("am-lyrics")){this.componentLoaded=!0;return}return new Promise((t,e)=>{const n=document.createElement("script");n.type="module",n.src="https://cdn.jsdelivr.net/npm/@uimaxbai/am-lyrics@0.6.2/dist/src/am-lyrics.min.js",n.onload=()=>{typeof customElements<"u"?customElements.whenDefined("am-lyrics").then(()=>{this.componentLoaded=!0,t()}).catch(e):t()},n.onerror=()=>e(new Error("Failed to load lyrics component")),document.head.appendChild(n)})}}async fetchLyrics(t,e=null){if(e){if(this.lyricsCache.has(t))return this.lyricsCache.get(t);try{const n=Array.isArray(e.artists)?e.artists.map(o=>o.name||o).join(", "):e.artist?.name||"",a=e.title||"",i=e.album?.title||"",r=e.duration?Math.round(e.duration):null;if(!a||!n)return console.warn("Missing required fields for LRCLIB"),null;const c=new URLSearchParams({track_name:a,artist_name:n});i&&c.append("album_name",i),r&&c.append("duration",r.toString());const l=await fetch(`https://lrclib.net/api/get?${c.toString()}`);if(l.ok){const o=await l.json();if(o.syncedLyrics){const d={subtitles:o.syncedLyrics,lyricsProvider:"LRCLIB"};return this.lyricsCache.set(t,d),d}}}catch(n){console.warn("LRCLIB fetch failed:",n)}}return null}parseSyncedLyrics(t){return t?t.split(`
`).filter(n=>n.trim()).map(n=>{const a=n.match(/\[(\d+):(\d+)\.(\d+)\]\s*(.+)/);if(a){const[,i,r,c,l]=a;return{time:parseInt(i)*60+parseInt(r)+parseInt(c)/100,text:l.trim()}}return null}).filter(Boolean):[]}generateLRCContent(t,e){if(!t||!t.subtitles)return null;const n=et(e),a=tt(e);let i=`[ti:${n}]
`;return i+=`[ar:${a}]
`,i+=`[al:${e.album?.title||"Unknown Album"}]
`,i+=`[by:${t.lyricsProvider||"Unknown"}]
`,i+=`
`,i+=t.subtitles,i}downloadLRC(t,e){const n=this.generateLRCContent(t,e);if(!n){alert("No synced lyrics available for this track");return}const a=new Blob([n],{type:"application/octet-stream"}),i=URL.createObjectURL(a),r=document.createElement("a");r.href=i,r.download=jt(e,"LOSSLESS").replace(/\.flac$/,".lrc"),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)}getCurrentLine(t){if(!this.syncedLyrics||this.syncedLyrics.length===0)return-1;let e=-1;for(let n=0;n<this.syncedLyrics.length&&t>=this.syncedLyrics[n].time;n++)e=n;return e}setupLyricsObserver(t){if(this.stopLyricsObserver(),!t)return;const e=t.shadowRoot||t;this.romajiObserver=new MutationObserver(n=>{n.some(i=>i.type==="childList"&&i.addedNodes.length>0?!0:i.type==="characterData"&&i.target.textContent?this.containsJapanese(i.target.textContent):!1)&&(this.observerTimeout&&clearTimeout(this.observerTimeout),this.observerTimeout=setTimeout(async()=>{await this.convertLyricsContent(t)},100))}),this.romajiObserver.observe(e,{childList:!0,subtree:!0,characterData:!0,attributes:!1}),this.isRomajiMode&&this.convertLyricsContent(t)}async convertLyricsContent(t){if(!t||!this.isRomajiMode)return;const e=t.shadowRoot||t;if(!this.kuroshiroLoaded&&!await this.loadKuroshiro()){console.warn("Cannot convert lyrics - Kuroshiro load failed");return}const n=[],a=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);let i;for(;i=a.nextNode();)n.push(i);for(const r of n){if(!r.parentElement)continue;const c=r.parentElement.tagName?.toLowerCase(),l=String(r.parentElement.className||"");if(["script","style","code","input","textarea","time"].includes(c))continue;const d=r.textContent;if(!(l.includes("progress")&&!l.includes("progress-text")||l.includes("time")&&!l.includes("progress-text")||l.includes("timestamp"))&&!(!d||d.trim().length===0)&&this.containsJapanese(d)){const h=await this.convertToRomaji(d);h&&h!==d&&(r.textContent=h)}}this.currentTrackId&&this.convertedTracksCache.add(this.currentTrackId)}stopLyricsObserver(){this.romajiObserver&&(this.romajiObserver.disconnect(),this.romajiObserver=null),this.observerTimeout&&(clearTimeout(this.observerTimeout),this.observerTimeout=null)}async toggleRomajiMode(t){return this.isRomajiMode=!this.isRomajiMode,this.setRomajiMode(this.isRomajiMode),t&&(this.isRomajiMode?(this.setupLyricsObserver(t),await this.convertLyricsContent(t)):this.stopLyricsObserver()),this.isRomajiMode}}async function Nt(s,t,e){const n=e||new Be;!n.kuroshiroLoaded&&!n.kuroshiroLoading&&(n.getRomajiMode()?await n.loadKuroshiro():n.loadKuroshiro().catch(r=>{console.warn("Failed to load Kuroshiro for Romaji conversion:",r)}));const a=r=>{const c=n.getRomajiMode();n.isRomajiMode=c,r.innerHTML=`
            <button id="close-side-panel-btn" class="btn-icon" title="Close">
                ${Pt}
            </button>
            <button id="romaji-toggle-btn" class="btn-icon" title="Toggle Romaji (Japanese to Latin)" data-enabled="${c}" style="color: ${c?"var(--primary)":""}">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                </svg>
            </button>
        `,r.querySelector("#close-side-panel-btn").addEventListener("click",()=>{j.close(),Ct(t,j.panel)});const l=r.querySelector("#romaji-toggle-btn");if(l){const o=()=>{const d=n.isRomajiMode;l.setAttribute("data-enabled",d),l.style.color=d?"var(--primary)":""};o(),l.addEventListener("click",async()=>{const d=j.panel.querySelector("am-lyrics");d&&(await n.toggleRomajiMode(d),o())})}},i=async r=>{Ct(t,j.panel),await Bs(r,s,t,n)};j.open("lyrics","Lyrics",a,i)}async function Bs(s,t,e,n){s.innerHTML='<div class="lyrics-loading">Loading lyrics...</div>';try{await n.ensureComponentLoaded(),n.isRomajiMode=n.getRomajiMode(),n.currentTrackId=t.id;const a=t.title,i=tt(t),r=t.album?.title,c=t.duration?Math.round(t.duration*1e3):void 0,l=t.isrc||"";s.innerHTML="";const o=document.createElement("am-lyrics");o.setAttribute("song-title",a),o.setAttribute("song-artist",i),r&&o.setAttribute("song-album",r),c&&o.setAttribute("song-duration",c),o.setAttribute("query",`${a} ${i}`.trim()),l&&o.setAttribute("isrc",l),o.setAttribute("highlight-color","#93c5fd"),o.setAttribute("hover-background-color","rgba(59, 130, 246, 0.14)"),o.setAttribute("autoscroll",""),o.setAttribute("interpolate",""),o.style.height="100%",o.style.width="100%",s.appendChild(o),n.setupLyricsObserver(o),n.isRomajiMode&&!n.kuroshiroLoaded&&await n.loadKuroshiro(),await new Promise(u=>{const m=()=>o.querySelector(".lyric-line, [class*='lyric']")||o.shadowRoot&&o.shadowRoot.querySelector("[class*='lyric']")||o.textContent&&o.textContent.length>50;if(m()){u();return}let f=0;const g=25,p=setInterval(()=>{f++,(m()||f>=g)&&(clearInterval(p),u())},200)}),n.isRomajiMode&&(await n.convertLyricsContent(o),setTimeout(()=>n.convertLyricsContent(o),500));const h=$s(t,e,o);return s.lyricsCleanup=h,s.lyricsManager=n,o}catch(a){return console.error("Failed to load lyrics:",a),s.innerHTML='<div class="lyrics-error">Failed to load lyrics</div>',null}}function $s(s,t,e){let n=0,a=performance.now(),i=null;const r=()=>{const h=t.currentTime*1e3;n=h,a=performance.now(),e.currentTime=h},c=()=>{if(!t.paused){const u=performance.now()-a,m=n+u;e.currentTime=m,i=requestAnimationFrame(c)}},l=()=>{n=t.currentTime*1e3,a=performance.now(),c()},o=()=>{i&&(cancelAnimationFrame(i),i=null)},d=h=>{h.detail&&h.detail.timestamp&&(t.currentTime=h.detail.timestamp/1e3,t.play())};return t.addEventListener("timeupdate",r),t.addEventListener("play",l),t.addEventListener("pause",o),t.addEventListener("seeked",r),e.addEventListener("line-click",d),t.paused||c(),()=>{i&&cancelAnimationFrame(i),t.removeEventListener("timeupdate",r),t.removeEventListener("play",l),t.removeEventListener("pause",o),t.removeEventListener("seeked",r),e.removeEventListener("line-click",d)}}function Ct(s,t){t&&t.lyricsCleanup&&(t.lyricsCleanup(),t.lyricsCleanup=null),t&&t.lyricsManager&&t.lyricsManager.stopLyricsObserver()}class $e{constructor(){this.dbName="MonochromeDB",this.version=5,this.db=null}async open(){return this.db?this.db:new Promise((t,e)=>{const n=indexedDB.open(this.dbName,this.version);n.onerror=a=>{console.error("Database error:",a.target.error),e(a.target.error)},n.onsuccess=a=>{this.db=a.target.result,t(this.db)},n.onupgradeneeded=a=>{const i=a.target.result;i.objectStoreNames.contains("favorites_tracks")||i.createObjectStore("favorites_tracks",{keyPath:"id"}).createIndex("addedAt","addedAt",{unique:!1}),i.objectStoreNames.contains("favorites_albums")||i.createObjectStore("favorites_albums",{keyPath:"id"}).createIndex("addedAt","addedAt",{unique:!1}),i.objectStoreNames.contains("favorites_artists")||i.createObjectStore("favorites_artists",{keyPath:"id"}).createIndex("addedAt","addedAt",{unique:!1}),i.objectStoreNames.contains("favorites_playlists")||i.createObjectStore("favorites_playlists",{keyPath:"uuid"}).createIndex("addedAt","addedAt",{unique:!1}),i.objectStoreNames.contains("favorites_mixes")||i.createObjectStore("favorites_mixes",{keyPath:"id"}).createIndex("addedAt","addedAt",{unique:!1}),i.objectStoreNames.contains("history_tracks")||i.createObjectStore("history_tracks",{keyPath:"timestamp"}).createIndex("timestamp","timestamp",{unique:!0}),i.objectStoreNames.contains("user_playlists")||i.createObjectStore("user_playlists",{keyPath:"id"}).createIndex("createdAt","createdAt",{unique:!1})}})}async performTransaction(t,e,n){const a=await this.open();return new Promise((i,r)=>{const c=a.transaction(t,e),l=c.objectStore(t),o=n(l);c.oncomplete=()=>{i(o?.result)},c.onerror=d=>{r(d.target.error)}})}async addToHistory(t){const e="history_tracks",a={...this._minifyItem("track",t),timestamp:Date.now()};return(await this.open()).transaction(e,"readwrite").objectStore(e).put(a),a}async getHistory(){const t="history_tracks",e=await this.open();return new Promise((n,a)=>{const l=e.transaction(t,"readonly").objectStore(t).index("timestamp").getAll();l.onsuccess=()=>{n(l.result.reverse())},l.onerror=()=>a(l.error)})}async toggleFavorite(t,e){const a=`favorites_${t==="mix"?"mixes":`${t}s`}`,i=t==="playlist"?e.uuid:e.id;if(await this.isFavorite(t,i))return await this.performTransaction(a,"readwrite",c=>c.delete(i)),!1;{const l={...this._minifyItem(t,e),addedAt:Date.now()};return await this.performTransaction(a,"readwrite",o=>o.put(l)),!0}}async isFavorite(t,e){const a=`favorites_${t==="mix"?"mixes":`${t}s`}`;try{return!!await this.performTransaction(a,"readonly",r=>r.get(e))}catch{return!1}}async getFavorites(t){const n=`favorites_${t==="mix"?"mixes":`${t}s`}`,a=await this.open();return new Promise((i,r)=>{const d=a.transaction(n,"readonly").objectStore(n).index("addedAt").getAll();d.onsuccess=()=>{i(d.result.reverse())},d.onerror=()=>r(d.error)})}_minifyItem(t,e){if(!e)return e;const n={id:e.id,addedAt:e.addedAt||null};return t==="track"?{...n,title:e.title,duration:e.duration,explicit:e.explicit,artist:e.artist||(e.artists&&e.artists.length>0?e.artists[0]:null),artists:e.artists?.map(a=>({id:a.id,name:a.name}))||[],album:e.album?{id:e.album.id,title:e.album.title,cover:e.album.cover,releaseDate:e.album.releaseDate||null,vibrantColor:e.album.vibrantColor||null,artist:e.album.artist,numberOfTracks:e.album.numberOfTracks}:null,copyright:e.copyright,isrc:e.isrc,trackNumber:e.trackNumber,streamStartDate:e.streamStartDate||null,version:e.version||null,mixes:e.mixes||null}:t==="album"?{...n,title:e.title,cover:e.cover,releaseDate:e.releaseDate||null,explicit:e.explicit,artist:e.artist?{name:e.artist.name,id:e.artist.id}:e.artists?.[0]?{name:e.artists[0].name,id:e.artists[0].id}:null,type:e.type||null,numberOfTracks:e.numberOfTracks}:t==="artist"?{...n,name:e.name,picture:e.picture||e.image||null}:t==="playlist"?{uuid:e.uuid||e.id,addedAt:e.addedAt||e.createdAt||null,title:e.title||e.name,image:e.image||e.squareImage||e.cover||null,numberOfTracks:e.numberOfTracks||(e.tracks?e.tracks.length:0),user:e.user?{name:e.user.name}:null}:t==="mix"?{id:e.id,addedAt:e.addedAt,title:e.title,subTitle:e.subTitle,description:e.description,mixType:e.mixType,cover:e.cover}:e}async exportData(){const t=await this.getFavorites("track"),e=await this.getFavorites("album"),n=await this.getFavorites("artist"),a=await this.getFavorites("playlist"),i=await this.getFavorites("mix"),r=await this.getHistory(),c=await this.getPlaylists();return{favorites_tracks:t.map(o=>this._minifyItem("track",o)),favorites_albums:e.map(o=>this._minifyItem("album",o)),favorites_artists:n.map(o=>this._minifyItem("artist",o)),favorites_playlists:a.map(o=>this._minifyItem("playlist",o)),favorites_mixes:i.map(o=>this._minifyItem("mix",o)),history_tracks:r.map(o=>this._minifyItem("track",o)),user_playlists:c}}async importData(t,e=!1){const n=await this.open(),a=async(i,r)=>{if(r===void 0)return;let c=Array.isArray(r)?r:Object.values(r||{});const o=n.transaction(i,"readwrite").objectStore(i);e&&o.clear();for(const d of c)try{o.put(d)}catch(h){console.warn(`Failed to import item in ${i}:`,d,h)}};await a("favorites_tracks",t.favorites_tracks),await a("favorites_albums",t.favorites_albums),await a("favorites_artists",t.favorites_artists),await a("favorites_playlists",t.favorites_playlists),await a("favorites_mixes",t.favorites_mixes),await a("history_tracks",t.history_tracks),t.user_playlists&&await a("user_playlists",t.user_playlists)}_updatePlaylistMetadata(t){if(t.numberOfTracks=t.tracks?t.tracks.length:0,!t.cover){const e=[],n=new Set,a=t.tracks||[];for(const i of a){const r=i.album?.cover;if(r&&!n.has(r)&&(n.add(r),e.push(r),e.length>=4))break}t.images=e}return t}async createPlaylist(t,e=[],n=""){const i={id:crypto.randomUUID(),name:t,tracks:e.map(r=>this._minifyItem("track",r)),cover:n,createdAt:Date.now()};return this._updatePlaylistMetadata(i),await this.performTransaction("user_playlists","readwrite",r=>r.put(i)),i}async addTrackToPlaylist(t,e){const n=await this.performTransaction("user_playlists","readonly",i=>i.get(t));if(!n)throw new Error("Playlist not found");n.tracks=n.tracks||[];const a=this._minifyItem("track",e);if(!n.tracks.some(i=>i.id===e.id))return n.tracks.push(a),this._updatePlaylistMetadata(n),await this.performTransaction("user_playlists","readwrite",i=>i.put(n)),n}async removeTrackFromPlaylist(t,e){const n=await this.performTransaction("user_playlists","readonly",a=>a.get(t));if(!n)throw new Error("Playlist not found");return n.tracks=n.tracks||[],n.tracks=n.tracks.filter(a=>a.id!==e),this._updatePlaylistMetadata(n),await this.performTransaction("user_playlists","readwrite",a=>a.put(n)),n}async deletePlaylist(t){await this.performTransaction("user_playlists","readwrite",e=>e.delete(t))}async getPlaylist(t){return await this.performTransaction("user_playlists","readonly",e=>e.get(t))}async getPlaylists(){const t=await this.open();return new Promise((e,n)=>{const i=t.transaction("user_playlists","readwrite").objectStore("user_playlists"),c=i.index("createdAt").getAll();c.onsuccess=()=>{const o=c.result.reverse().map(d=>{let h=!1;if(typeof d.numberOfTracks>"u"&&(d.numberOfTracks=d.tracks?d.tracks.length:0,h=!0),!d.cover&&(!d.images||d.images.length===0)&&(this._updatePlaylistMetadata(d),h=!0),h)try{i.put(d)}catch(f){console.warn("Failed to update playlist metadata",f)}const{tracks:u,...m}=d;return m});e(o)},c.onerror=()=>n(c.error)})}async updatePlaylistName(t,e){const n=await this.performTransaction("user_playlists","readonly",a=>a.get(t));if(!n)throw new Error("Playlist not found");return n.name=e,await this.performTransaction("user_playlists","readwrite",a=>a.put(n)),n}async updatePlaylistTracks(t,e){const n=await this.open();return new Promise((a,i)=>{const r=n.transaction("user_playlists","readwrite"),c=r.objectStore("user_playlists"),l=c.get(t);l.onsuccess=()=>{const o=l.result;if(!o){i(new Error("Playlist not found"));return}o.tracks=e,this._updatePlaylistMetadata(o);const d=c.put(o);d.onsuccess=()=>{a(o)},d.onerror=()=>{i(d.error)}},l.onerror=()=>{i(l.error)},r.onerror=o=>{i(o.target.error)}})}}const C=new $e,pt=Object.freeze(Object.defineProperty({__proto__:null,MusicDatabase:$e,db:C},Symbol.toStringTag,{value:"Module"}));function ge(s,t,e){s/=255,t/=255,e/=255;const n=Math.max(s,t,e),a=Math.min(s,t,e);let i,r,c=(n+a)/2;if(n===a)i=r=0;else{const l=n-a;switch(r=c>.5?l/(2-n-a):l/(n+a),n){case s:i=(t-e)/l+(t<e?6:0);break;case t:i=(e-s)/l+2;break;case e:i=(s-t)/l+4;break}i/=6}return[i,r,c]}function Ps(s,t,e){let n,a,i;if(t===0)n=a=i=e;else{const c=(d,h,u)=>(u<0&&(u+=1),u>1&&(u-=1),u<.16666666666666666?d+(h-d)*6*u:u<.5?h:u<.6666666666666666?d+(h-d)*(.6666666666666666-u)*6:d),l=e<.5?e*(1+t):e+t-e*t,o=2*e-l;n=c(o,l,s+1/3),a=c(o,l,s),i=c(o,l,s-1/3)}const r=c=>{const l=Math.round(c*255).toString(16);return l.length===1?"0"+l:l};return`#${r(n)}${r(a)}${r(i)}`}function _s(s){const t=document.createElement("canvas"),e=t.getContext("2d");if(!e)return null;const n=64;let a=s.naturalWidth||s.width,i=s.naturalHeight||s.height;if(a>n||i>n){const d=Math.min(n/a,n/i);a=Math.floor(a*d),i=Math.floor(i*d)}t.width=a,t.height=i,e.drawImage(s,0,0,a,i);const c=e.getImageData(0,0,a,i).data,l=[];for(let d=0;d<c.length;d+=4){const h=c[d],u=c[d+1],m=c[d+2];if(c[d+3]<125)continue;const[g,p,v]=ge(h,u,m);p>=.3&&v>=.3&&v<=.8&&l.push({r:h,g:u,b:m,h:g,s:p,l:v})}if(l.length===0)for(let d=0;d<c.length;d+=4){const h=c[d],u=c[d+1],m=c[d+2];if(c[d+3]<125)continue;const[g,p,v]=ge(h,u,m);v>.1&&v<.95&&l.push({r:h,g:u,b:m,h:g,s:p,l:v})}if(l.length===0)return null;l.sort((d,h)=>h.s-d.s||.5-Math.abs(d.l-.5)-(.5-Math.abs(h.l-.5)));const o=l[0];return Ps(o.h,o.s,o.l)}let Jt=null,X=null,dt=null,Pe=null;const Mt="monochrome-firebase-config",Rs={apiKey:"AIzaSyDPU-unAjuLtQJt4IkGS5faG50UCF7lYyA",authDomain:"monochrome-database.firebaseapp.com",projectId:"monochrome-database",storageBucket:"monochrome-database.firebasestorage.app",messagingSenderId:"895657412760",appId:"1:895657412760:web:e81c5044c7f4e9b799e8ed"};function Ds(){try{const s=localStorage.getItem(Mt);return s?JSON.parse(s):null}catch(s){return console.warn("Failed to parse Firebase config from storage",s),null}}const _e=Ds(),pe=_e||Rs;if(pe)try{Jt=Qe(pe),X=ze(Jt),dt=Xe(Jt),Pe=new Ke,console.log("Firebase initialized from "+(_e?"saved":"default")+" config")}catch(s){console.error("Error initializing Firebase:",s)}else console.log("No Firebase config found.");function Re(s){s&&localStorage.setItem(Mt,JSON.stringify(s))}function Hs(){localStorage.removeItem(Mt)}function Os(s){if(!s)return null;try{const t=JSON.stringify(s),e=btoa(t),n=new URL(window.location.href);return n.hash=`#setup_firebase=${e}`,n.toString()}catch(t){return console.error("Failed to generate share link:",t),null}}function Fs(){const s=window.location.hash;if(!s.startsWith("#setup_firebase="))return!1;const t=s.split("#setup_firebase=")[1];if(!t)return!1;try{const e=atob(t),n=JSON.parse(e);if(!n.apiKey||!n.authDomain)return alert("The shared configuration link appears to be invalid."),!1;if(confirm("A Firebase configuration was detected in the link. Do you want to import it and enable Sync?"))return Re(n),window.history.replaceState(null,null,window.location.pathname),alert("Configuration imported successfully! The app will now reload."),window.location.reload(),!0;window.history.replaceState(null,null,window.location.pathname+"#settings")}catch(e){console.error("Failed to parse shared config:",e),alert("Failed to read configuration from link. The link might be corrupted.")}return!1}function Ns(){Fs();const s=document.getElementById("firebase-config-input"),t=document.getElementById("save-firebase-config-btn"),e=document.getElementById("clear-firebase-config-btn"),n=document.getElementById("share-firebase-config-btn"),a=document.getElementById("toggle-firebase-config-btn"),i=document.getElementById("custom-firebase-config-container");if(a&&i&&a.addEventListener("click",()=>{i.classList.contains("visible")?(i.classList.remove("visible"),a.textContent="Custom Configuration"):(i.classList.add("visible"),a.textContent="Hide Custom Configuration")}),s){const r=localStorage.getItem(Mt);if(r)try{s.value=JSON.stringify(JSON.parse(r),null,2),i&&a&&(i.classList.add("visible"),a.textContent="Hide Custom Configuration")}catch{s.value=r}}n&&n.addEventListener("click",()=>{const r=localStorage.getItem(Mt);if(!r){alert("No configuration saved to share.");return}try{const c=JSON.parse(r),l=Os(c);l&&navigator.clipboard.writeText(l).then(()=>{alert("Magic Link copied to clipboard! Send it to your other device.")}).catch(o=>{console.error("Clipboard error:",o),prompt("Copy this link:",l)})}catch{alert("Invalid configuration found.")}}),t&&t.addEventListener("click",()=>{const r=s.value.trim();if(!r){alert("Please enter a valid configuration.");return}try{let c=r;c.includes("=")&&(c=c.substring(c.indexOf("=")+1)),c=c.trim(),c.endsWith(";")&&(c=c.slice(0,-1));const l=c.replace(/([{,]\s*)([a-zA-Z0-9_]+)\s*:/g,'$1"$2":').replace(/:\s*'([^']*)'/g,': "$1"').replace(/,\s*([}\]])/g,"$1"),o=JSON.parse(l);Re(o),alert("Configuration saved. Reloading..."),window.location.reload()}catch(c){console.error("Invalid Config:",c),alert("Could not parse configuration. Please ensure it looks like a valid JSON or JS object.")}}),e&&e.addEventListener("click",()=>{confirm("Are you sure you want to remove the custom configuration? The app will revert to the shared default database.")&&(Hs(),window.location.reload())})}class De{constructor(){this.user=null,this.userRef=null,this.unsubscribeFunctions=[],this.isSyncing=!1}initialize(t){!dt||!t||(this.user=t,this.userRef=Rt(dt,`users/${t.uid}`),console.log("Initializing SyncManager for user:",t.uid),this.performInitialSync())}disconnect(){this.userRef&&(this.unsubscribeFunctions.forEach(t=>t()),this.unsubscribeFunctions=[]),this.user=null,this.userRef=null,console.log("SyncManager disconnected")}async performInitialSync(){if(!this.isSyncing){this.isSyncing=!0;try{console.log("Starting initial sync...");const e=(await de(this.userRef)).val()||{},n=e.deleted_playlists||{},a=await C.exportData();a.user_playlists&&Array.isArray(a.user_playlists)&&(a.user_playlists=a.user_playlists.filter(c=>!n[c.id]));const i=this.mergeData(a,e);await Ze(this.userRef,i);const r={favorites_tracks:i.library?.tracks?Object.values(i.library.tracks):[],favorites_albums:i.library?.albums?Object.values(i.library.albums):[],favorites_artists:i.library?.artists?Object.values(i.library.artists):[],favorites_playlists:i.library?.playlists?Object.values(i.library.playlists):[],history_tracks:i.history?.recentTracks?Object.values(i.history.recentTracks):[],user_playlists:i.user_playlists?Object.values(i.user_playlists):[]};await C.importData(r,!0),console.log("Initial sync complete."),this.setupListeners()}catch(t){console.error("Initial sync failed:",t)}finally{this.isSyncing=!1}}}mergeData(t,e){const n=(i,r,c="id")=>{const l=new Map;return Array.isArray(i)?i.forEach(o=>l.set(o[c],o)):i&&typeof i=="object"&&Object.values(i).forEach(o=>l.set(o[c],o)),r&&(Array.isArray(r)?r.forEach(o=>l.set(o[c],o)):Object.keys(r).forEach(o=>{const d=r[o];typeof d=="object"&&l.set(d[c]||o,d)})),Array.from(l.values())};return{library:{tracks:this.arrayToObject(n(t.favorites_tracks,e.library?.tracks),"id"),albums:this.arrayToObject(n(t.favorites_albums,e.library?.albums),"id"),artists:this.arrayToObject(n(t.favorites_artists,e.library?.artists),"id"),playlists:this.arrayToObject(n(t.favorites_playlists,e.library?.playlists,"uuid"),"uuid")},history:{recentTracks:this.arrayToObject(n(t.history_tracks,e.history?.recentTracks,"timestamp"),"timestamp")},user_playlists:this.arrayToObject(n(t.user_playlists,e.user_playlists),"id"),lastUpdated:Date.now()}}arrayToObject(t,e){const n={};return t.forEach(a=>{a&&a[e]&&(n[a[e]]=a)}),n}setupListeners(){const t=it(this.userRef,"library"),e=Wt(t,c=>{if(this.isSyncing)return;const l=c.val();if(l){const o={favorites_tracks:l.tracks?Object.values(l.tracks):[],favorites_albums:l.albums?Object.values(l.albums):[],favorites_artists:l.artists?Object.values(l.artists):[],favorites_playlists:l.playlists?Object.values(l.playlists):[]};C.importData(o,!1).then(()=>{window.dispatchEvent(new Event("library-changed"))})}});this.unsubscribeFunctions.push(()=>Vt(t,"value",e));const n=it(this.userRef,"history/recentTracks"),a=Wt(n,c=>{if(this.isSyncing)return;const l=c.val();if(l){const o={history_tracks:Object.values(l)};C.importData(o,!0).then(()=>{window.dispatchEvent(new Event("history-changed"))})}});this.unsubscribeFunctions.push(()=>Vt(n,"value",a));const i=it(this.userRef,"user_playlists"),r=Wt(i,c=>{if(this.isSyncing)return;const l=c.val();if(l){const o={user_playlists:Object.values(l)};C.importData(o,!0).then(()=>{window.dispatchEvent(new Event("library-changed"))})}});this.unsubscribeFunctions.push(()=>Vt(i,"value",r))}async syncLibraryItem(t,e,n){if(!this.user||!this.userRef)return;const i={track:"tracks",album:"albums",artist:"artists",playlist:"playlists"}[t];if(!i)return;const r=t==="playlist"?e.uuid:e.id,c=`library/${i}/${r}`,l=it(this.userRef,c);if(n){const o=C._minifyItem(t,e),d={...o,addedAt:e.addedAt||o.addedAt||Date.now()};await kt(l,d)}else await Tt(l)}async syncHistoryItem(t){if(!this.user||!this.userRef||!t.timestamp)return;const e=it(this.userRef,`history/recentTracks/${t.timestamp}`);try{await kt(e,t)}catch(n){console.error("Failed to sync history item:",n)}}async syncUserPlaylist(t,e){if(!this.user||!this.userRef)return;const n=t.id,a=`user_playlists/${n}`,i=it(this.userRef,a);if(e==="create"||e==="update"){await kt(i,t);const r=it(this.userRef,`deleted_playlists/${n}`);await Tt(r)}else if(e==="delete"){await Tt(i);const r=it(this.userRef,`deleted_playlists/${n}`);await kt(r,{timestamp:Date.now()})}}async clearCloudData(){if(!this.user||!this.userRef)throw new Error("Not authenticated");await Tt(this.userRef)}async publishPlaylist(t){if(!this.user)throw new Error("Not authenticated");const e=C._minifyItem("playlist",t),n=t.id||t.uuid;if(!n)throw new Error("Invalid playlist ID");const a={...e,uid:this.user.uid,originalId:n,publishedAt:Date.now(),tracks:t.tracks?t.tracks.map(r=>C._minifyItem("track",r)):[]},i=Rt(dt,`public_playlists/${n}`);await kt(i,a)}async unpublishPlaylist(t){if(!this.user)throw new Error("Not authenticated");const e=Rt(dt,`public_playlists/${t}`);await Tt(e)}async getPublicPlaylist(t){if(!dt)return console.warn("[Sync] Database not initialized, cannot fetch public playlist"),null;try{const e=Rt(dt,`public_playlists/${t}`),n=await de(e);if(!n.exists())return console.warn(`[Sync] Public playlist ${t} not found in database.`),null;const a=n.val();return console.log(`[Sync] Public playlist fetch for ${t}: Found`),a}catch(e){return console.error("[Sync] Failed to fetch public playlist:",e),null}}}const F=new De,Xt=Object.freeze(Object.defineProperty({__proto__:null,SyncManager:De,syncManager:F},Symbol.toStringTag,{value:"Module"}));class Us{constructor(t,e){this.api=t,this.player=e,this.currentTrack=null,this.searchAbortController=null,this.vibrantColorCache=new Map}createHeartIcon(t=!1){return t?rt.replace('class="heart-icon"','class="heart-icon filled"'):rt}async extractAndApplyColor(t){if(!yt.isEnabled()||!t){this.resetVibrantColor();return}if(this.vibrantColorCache.has(t)){const a=this.vibrantColorCache.get(t);if(a){this.setVibrantColor(a);return}}const e=new Image;e.crossOrigin="Anonymous";const n=t.includes("?")?"&":"?";e.src=`${t}${n}not-from-cache-please`,e.onload=()=>{try{const a=_s(e);a?(this.vibrantColorCache.set(t,a),this.setVibrantColor(a)):(this.vibrantColorCache.set(t,null),this.resetVibrantColor())}catch{this.vibrantColorCache.set(t,null),this.resetVibrantColor()}},e.onerror=()=>{this.vibrantColorCache.set(t,null),this.resetVibrantColor()}}async updateLikeState(t,e,n){const a=await C.isFavorite(e,n),i=t.querySelector(".like-btn");i&&(i.innerHTML=this.createHeartIcon(a),i.classList.toggle("active",a),i.title=a?"Remove from Liked":"Add to Liked")}setCurrentTrack(t){this.currentTrack=t,this.updateGlobalTheme();const e=document.getElementById("now-playing-like-btn"),n=document.getElementById("now-playing-add-playlist-btn"),a=document.getElementById("mobile-add-playlist-btn"),i=document.getElementById("toggle-lyrics-btn");t?(e&&(e.style.display="flex",this.updateLikeState(e.parentElement,"track",t.id)),n&&n.style.removeProperty("display"),a&&a.style.removeProperty("display"),i&&i.style.removeProperty("display")):(e&&(e.style.display="none"),n&&n.style.setProperty("display","none","important"),a&&a.style.setProperty("display","none","important"),i&&(i.style.display="none"))}updateGlobalTheme(){document.getElementById("page-album").classList.contains("active")||(yt.isEnabled()&&this.currentTrack?.album?.cover?this.extractAndApplyColor(this.api.getCoverUrl(this.currentTrack.album.cover,"80")):this.resetVibrantColor())}createExplicitBadge(){return'<span class="explicit-badge" title="Explicit">E</span>'}adjustTitleFontSize(t,e){t.classList.remove("long-title","very-long-title"),e.length>40?t.classList.add("very-long-title"):e.length>25&&t.classList.add("long-title")}createTrackItemHTML(t,e,n=!1,a=!1){const i=n?`<img src="${this.api.getCoverUrl(t.album?.cover)}" alt="Track Cover" class="track-item-cover" loading="lazy">`:"";let r;a&&!n?r=`${t.volumeNumber??t.discNumber??1}-${t.trackNumber}`:r=e+1;const c=`<div class="track-number">${n?i:r}</div>`,l=Yt(t)?this.createExplicitBadge():"",o=tt(t),d=et(t),h=this.player?.currentTrack?.id===t.id;let u="";const m=t.album?.releaseDate||t.streamStartDate;if(m){const g=new Date(m);isNaN(g.getTime())||(u=` • ${g.getFullYear()}`)}const f=`
            <div class="track-actions-inline">
                <button class="track-action-btn like-btn" data-action="toggle-like" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
                <button class="track-action-btn" data-action="play-next" title="Play Next">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 6h6" />
                        <path d="M5 3v6" />
                        <path d="M11 6h10" />
                        <path d="M3 12h18" />
                        <path d="M3 18h18" />
                    </svg>
                </button>
                <button class="track-action-btn" data-action="add-to-queue" title="Add to Queue">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18" />
                        <path d="M3 12h18" />
                        <path d="M3 18h10" />
                        <path d="M16 18h6" />
                        <path d="M19 15v6" />
                    </svg>
                </button>
                <button class="track-action-btn" data-action="download" title="Download">
                    ${ft}
                </button>
            </div>
            <button class="track-menu-btn" type="button" title="More options">
                ${is}
            </button>
        `;return`
            <div class="track-item ${h?"playing":""}" data-track-id="${t.id}">
                ${c}
                <div class="track-item-info">
                    <div class="track-item-details">
                        <div class="title">
                            ${Y(d)}
                            ${l}
                        </div>
                        <div class="artist">${Y(o)}${u}</div>
                    </div>
                </div>
                <div class="track-item-duration">${xt(t.duration)}</div>
                <div class="track-item-actions">
                    ${f}
                </div>
            </div>
        `}createBaseCardHTML({type:t,id:e,href:n,title:a,subtitle:i,imageHTML:r,actionButtonsHTML:c,isCompact:l,extraClasses:o=""}){const d=t!=="artist"?`
            <button class="play-btn card-play-btn" data-action="play-card" data-type="${t}" data-id="${e}" title="Play">
                ${mt}
            </button>
        `:"",h=t==="artist"?`<h4 class="card-title">${a}</h4>`:`<div class="card-info">
                    <h4 class="card-title">${a}</h4>
                    <p class="card-subtitle">${i}</p>
               </div>`;return`
            <div class="card ${o} ${l?"compact":""}" data-${t}-id="${e}" data-href="${n}" style="cursor: pointer;">
                <div class="card-image-wrapper">
                    ${r}
                    ${c}
                    ${l?"":d}
                </div>
                ${h}
                ${l?d:""}
            </div>
        `}createPlaylistCardHTML(t){const e=t.squareImage||t.image||t.uuid,n=nt.isCompactAlbum();return this.createBaseCardHTML({type:"playlist",id:t.uuid,href:`#playlist/${t.uuid}`,title:t.title,subtitle:`${t.numberOfTracks||0} tracks`,imageHTML:`<img src="${this.api.getCoverUrl(e)}" alt="${t.title}" class="card-image" loading="lazy">`,actionButtonsHTML:`
                <button class="like-btn card-like-btn" data-action="toggle-like" data-type="playlist" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
            `,isCompact:n})}createMixCardHTML(t){const e=t.cover||"assets/appicon.png",n=t.subTitle||t.description||"",a=nt.isCompactAlbum();return this.createBaseCardHTML({type:"mix",id:t.id,href:`#mix/${t.id}`,title:t.title,subtitle:n,imageHTML:`<img src="${e}" alt="${t.title}" class="card-image" loading="lazy">`,actionButtonsHTML:`
                <button class="like-btn card-like-btn" data-action="toggle-like" data-type="mix" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
            `,isCompact:a})}createUserPlaylistCardHTML(t){let e="";if(t.cover)e=`<img src="${t.cover}" alt="${t.name}" class="card-image" loading="lazy">`;else{const a=t.tracks||[];let i=t.images||[];const r=new Set(i);if(i.length===0)for(const c of a){const l=c.album?.cover;if(l&&!r.has(l)&&(r.add(l),i.push(l),i.length>=4))break}if(i.length>=2){const c=Math.min(i.length,4),l=c<4?`items-${c}`:"",o=i.slice(0,4);e=`
                    <div class="card-image card-collage ${l}">
                        ${o.map(d=>`<img src="${this.api.getCoverUrl(d)}" alt="" loading="lazy">`).join("")}
                    </div>
                `}else i.length>0?e=`<img src="${this.api.getCoverUrl(i[0])}" alt="${t.name}" class="card-image" loading="lazy">`:e=`<img src="assets/appicon.png" alt="${t.name}" class="card-image" loading="lazy">`}const n=nt.isCompactAlbum();return this.createBaseCardHTML({type:"user-playlist",id:t.id,href:`#userplaylist/${t.id}`,title:Y(t.name),subtitle:`${t.tracks?t.tracks.length:t.numberOfTracks||0} tracks`,imageHTML:e,actionButtonsHTML:`
                <button class="edit-playlist-btn" data-action="edit-playlist" title="Edit Playlist">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                </button>
                <button class="delete-playlist-btn" data-action="delete-playlist" title="Delete Playlist">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18"/>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                    </svg>
                </button>
            `,isCompact:n,extraClasses:"user-playlist"})}createAlbumCardHTML(t){const e=Yt(t)?this.createExplicitBadge():"";let n="";if(t.releaseDate){const r=new Date(t.releaseDate);isNaN(r.getTime())||(n=`${r.getFullYear()}`)}let a="";t.type==="EP"?a=" • EP":t.type==="SINGLE"&&(a=" • Single");const i=nt.isCompactAlbum();return this.createBaseCardHTML({type:"album",id:t.id,href:`#album/${t.id}`,title:`${Y(t.title)} ${e}`,subtitle:`${Y(t.artist?.name??"")} • ${n}${a}`,imageHTML:`<img src="${this.api.getCoverUrl(t.cover)}" alt="${Y(t.title)}" class="card-image" loading="lazy">`,actionButtonsHTML:`
                <button class="like-btn card-like-btn" data-action="toggle-like" data-type="album" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
            `,isCompact:i})}createArtistCardHTML(t){const e=nt.isCompactArtist();return this.createBaseCardHTML({type:"artist",id:t.id,href:`#artist/${t.id}`,title:Y(t.name),subtitle:"",imageHTML:`<img src="${this.api.getArtistPictureUrl(t.picture)}" alt="${Y(t.name)}" class="card-image" loading="lazy">`,actionButtonsHTML:`
                <button class="like-btn card-like-btn" data-action="toggle-like" data-type="artist" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
            `,isCompact:e,extraClasses:"artist"})}createSkeletonTrack(t=!1){return`
            <div class="skeleton-track">
                ${t?'<div class="skeleton skeleton-track-cover"></div>':'<div class="skeleton skeleton-track-number"></div>'}
                <div class="skeleton-track-info">
                    <div class="skeleton-track-details">
                        <div class="skeleton skeleton-track-title"></div>
                        <div class="skeleton skeleton-track-artist"></div>
                    </div>
                </div>
                <div class="skeleton skeleton-track-duration"></div>
            </div>
        `}createSkeletonCard(t=!1){return`
            <div class="skeleton-card ${t?"artist":""}">
                <div class="skeleton skeleton-card-image"></div>
                <div class="skeleton skeleton-card-title"></div>
                ${t?"":'<div class="skeleton skeleton-card-subtitle"></div>'}
            </div>
        `}createSkeletonTracks(t=5,e=!1){return`<div class="skeleton-container">${Array(t).fill(0).map(()=>this.createSkeletonTrack(e)).join("")}</div>`}createSkeletonCards(t=6,e=!1){return`<div class="card-grid">${Array(t).fill(0).map(()=>this.createSkeletonCard(e)).join("")}</div>`}renderListWithTracks(t,e,n){const a=document.createDocumentFragment(),i=document.createElement("div"),r=e.some(c=>(c.volumeNumber||c.discNumber||1)>1);for(i.innerHTML=e.map((c,l)=>this.createTrackItemHTML(c,l,n,r)).join("");i.firstChild;)a.appendChild(i.firstChild);t.innerHTML="",t.appendChild(a),e.forEach(c=>{const l=t.querySelector(`[data-track-id="${c.id}"]`);l&&(O.set(l,c),this.updateLikeState(l,"track",c.id))})}setPageBackground(t){const e=document.getElementById("page-background");yt.isEnabled()&&t?(e.style.backgroundImage=`url('${t}')`,e.classList.add("active"),document.body.classList.add("has-page-background")):(e.classList.remove("active"),document.body.classList.remove("has-page-background"),setTimeout(()=>{e.classList.contains("active")||(e.style.backgroundImage="")},500))}setVibrantColor(t){if(!t)return;const e=document.documentElement,a=e.getAttribute("data-theme")==="light";let i=t.replace("#","");i.length===3&&(i=i.split("").map(m=>m+m).join(""));let r=parseInt(i.substr(0,2),16),c=parseInt(i.substr(2,2),16),l=parseInt(i.substr(4,2),16),o=(r*299+c*587+l*114)/1e3;if(a)for(;o>150;)r=Math.floor(r*.9),c=Math.floor(c*.9),l=Math.floor(l*.9),o=(r*299+c*587+l*114)/1e3;else for(;o<80&&(r=Math.min(255,Math.max(r+1,Math.floor(r*1.15))),c=Math.min(255,Math.max(c+1,Math.floor(c*1.15))),l=Math.min(255,Math.max(l+1,Math.floor(l*1.15))),o=(r*299+c*587+l*114)/1e3,!(r>=255&&c>=255&&l>=255)););const d=`#${r.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}`,h=o>128?"#000000":"#ffffff";e.style.setProperty("--primary",d),e.style.setProperty("--primary-foreground",h),e.style.setProperty("--highlight",d),e.style.setProperty("--highlight-rgb",`${r}, ${c}, ${l}`),e.style.setProperty("--active-highlight",d),e.style.setProperty("--ring",d);let u;if(o>200){const m=Math.floor(r*.85),f=Math.floor(c*.85),g=Math.floor(l*.85);u=`rgba(${m}, ${f}, ${g}, 0.25)`}else u=`rgba(${r}, ${c}, ${l}, 0.15)`;e.style.setProperty("--track-hover-bg",u)}resetVibrantColor(){const t=document.documentElement;t.style.removeProperty("--primary"),t.style.removeProperty("--primary-foreground"),t.style.removeProperty("--highlight"),t.style.removeProperty("--highlight-rgb"),t.style.removeProperty("--active-highlight"),t.style.removeProperty("--ring"),t.style.removeProperty("--track-hover-bg")}async showFullscreenCover(t,e,n,a){if(!t)return;const i=document.getElementById("fullscreen-cover-overlay"),r=document.getElementById("fullscreen-cover-image"),c=document.getElementById("fullscreen-track-title"),l=document.getElementById("fullscreen-track-artist"),o=document.getElementById("fullscreen-next-track");document.getElementById("fullscreen-lyrics-container");const d=document.getElementById("toggle-fullscreen-lyrics-btn"),h=this.api.getCoverUrl(t.album?.cover,"1280");if(r.src=h,c.textContent=t.title,l.textContent=tt(t),e?(o.style.display="flex",o.querySelector(".value").textContent=`${e.title} • ${tt(e)}`,o.classList.remove("animate-in"),o.offsetWidth,o.classList.add("animate-in")):(o.style.display="none",o.classList.remove("animate-in")),i.style.setProperty("--bg-image",`url('${h}')`),n&&a){d.style.display="flex",d.classList.remove("active");const u=()=>{Nt(t,a,n),d.classList.toggle("active")},m=d.cloneNode(!0);d.parentNode.replaceChild(m,d),m.addEventListener("click",u)}else d.style.display="none";i.style.display="flex"}closeFullscreenCover(){const t=document.getElementById("fullscreen-cover-overlay");t.style.display="none"}showPage(t){document.querySelectorAll(".page").forEach(e=>{e.classList.toggle("active",e.id===`page-${t}`)}),document.querySelectorAll(".sidebar-nav a").forEach(e=>{e.classList.toggle("active",e.hash===`#${t}`)}),document.querySelector(".main-content").scrollTop=0,["album","artist","playlist","mix"].includes(t)||(this.setPageBackground(null),this.updateGlobalTheme()),t==="settings"&&this.renderApiSettings()}async renderLibraryPage(){this.showPage("library");const t=document.getElementById("library-tracks-container"),e=document.getElementById("library-albums-container"),n=document.getElementById("library-artists-container"),a=document.getElementById("library-playlists-container"),i=await C.getFavorites("track");i.length?this.renderListWithTracks(t,i,!0):t.innerHTML=N("No liked tracks yet.");const r=await C.getFavorites("album");r.length?(e.innerHTML=r.map(m=>this.createAlbumCardHTML(m)).join(""),r.forEach(m=>{const f=e.querySelector(`[data-album-id="${m.id}"]`);f&&(O.set(f,m),this.updateLikeState(f,"album",m.id))})):e.innerHTML=N("No liked albums yet.");const c=await C.getFavorites("artist");c.length?(n.innerHTML=c.map(m=>this.createArtistCardHTML(m)).join(""),c.forEach(m=>{const f=n.querySelector(`[data-artist-id="${m.id}"]`);f&&(O.set(f,m),this.updateLikeState(f,"artist",m.id))})):n.innerHTML=N("No liked artists yet.");const l=await C.getFavorites("playlist"),o=await C.getFavorites("mix");let d=[];l.length&&d.push(...l.map(m=>({...m,_type:"playlist"}))),o.length&&d.push(...o.map(m=>({...m,_type:"mix"}))),d.sort((m,f)=>f.addedAt-m.addedAt),d.length?(a.innerHTML=d.map(m=>m._type==="playlist"?this.createPlaylistCardHTML(m):this.createMixCardHTML(m)).join(""),l.forEach(m=>{const f=a.querySelector(`[data-playlist-id="${m.uuid}"]`);f&&(O.set(f,m),this.updateLikeState(f,"playlist",m.uuid))}),o.forEach(m=>{const f=a.querySelector(`[data-mix-id="${m.id}"]`);f&&(O.set(f,m),this.updateLikeState(f,"mix",m.id))})):a.innerHTML=N("No liked playlists or mixes yet.");const h=document.getElementById("my-playlists-container"),u=await C.getPlaylists();u.length?(h.innerHTML=u.map(m=>this.createUserPlaylistCardHTML(m)).join(""),u.forEach(m=>{const f=h.querySelector(`[data-user-playlist-id="${m.id}"]`);f&&O.set(f,m)})):h.innerHTML=N("No playlists yet. Create your first playlist!")}async renderHomePage(){this.showPage("home");const t=ht.getRecents(),e=document.getElementById("home-recent-albums"),n=document.getElementById("home-recent-artists"),a=document.getElementById("home-recent-playlists");if(t.albums.length?(e.innerHTML=t.albums.map(i=>this.createAlbumCardHTML(i)).join(""),t.albums.forEach(i=>{const r=e.querySelector(`[data-album-id="${i.id}"]`);r&&(O.set(r,i),this.updateLikeState(r,"album",i.id))})):e.innerHTML=N("You haven't viewed any albums yet."),t.artists.length?(n.innerHTML=t.artists.map(i=>this.createArtistCardHTML(i)).join(""),t.artists.forEach(i=>{const r=n.querySelector(`[data-artist-id="${i.id}"]`);r&&(O.set(r,i),this.updateLikeState(r,"artist",i.id))})):n.innerHTML=N("You haven't viewed any artists yet."),a){const i=t.playlists||[],r=t.mixes||[],c=[...i,...r];c.length?(a.innerHTML=c.map(l=>l.isUserPlaylist?this.createUserPlaylistCardHTML(l):l.mixType?this.createMixCardHTML(l):this.createPlaylistCardHTML(l)).join(""),c.forEach(l=>{if(l.isUserPlaylist){const o=a.querySelector(`[data-user-playlist-id="${l.id}"]`);o&&O.set(o,l)}else if(l.mixType){const o=a.querySelector(`[data-mix-id="${l.id}"]`);o&&(O.set(o,l),this.updateLikeState(o,"mix",l.id))}else{const o=a.querySelector(`[data-playlist-id="${l.uuid}"]`);o&&(O.set(o,l),this.updateLikeState(o,"playlist",l.uuid))}})):a.innerHTML=N("You haven't viewed any playlists or mixes yet.")}}async renderSearchPage(t){this.showPage("search"),document.getElementById("search-results-title").textContent=`Search Results for "${t}"`;const e=document.getElementById("search-tracks-container"),n=document.getElementById("search-artists-container"),a=document.getElementById("search-albums-container"),i=document.getElementById("search-playlists-container");e.innerHTML=this.createSkeletonTracks(8,!0),n.innerHTML=this.createSkeletonCards(6,!0),a.innerHTML=this.createSkeletonCards(6,!1),i.innerHTML=this.createSkeletonCards(6,!1),this.searchAbortController&&this.searchAbortController.abort(),this.searchAbortController=new AbortController;const r=this.searchAbortController.signal;try{const[c,l,o,d]=await Promise.all([this.api.searchTracks(t,{signal:r}),this.api.searchArtists(t,{signal:r}),this.api.searchAlbums(t,{signal:r}),this.api.searchPlaylists(t,{signal:r})]);let h=c.items,u=l.items,m=o.items,f=d.items;if(u.length===0&&h.length>0){const g=new Map;h.forEach(p=>{p.artist&&!g.has(p.artist.id)&&g.set(p.artist.id,p.artist),p.artists&&p.artists.forEach(v=>{g.has(v.id)||g.set(v.id,v)})}),u=Array.from(g.values())}if(m.length===0&&h.length>0){const g=new Map;h.forEach(p=>{p.album&&!g.has(p.album.id)&&g.set(p.album.id,p.album)}),m=Array.from(g.values())}h.length?this.renderListWithTracks(e,h,!0):e.innerHTML=N("No tracks found."),n.innerHTML=u.length?u.map(g=>this.createArtistCardHTML(g)).join(""):N("No artists found."),u.forEach(g=>{const p=n.querySelector(`[data-artist-id="${g.id}"]`);p&&(O.set(p,g),this.updateLikeState(p,"artist",g.id))}),a.innerHTML=m.length?m.map(g=>this.createAlbumCardHTML(g)).join(""):N("No albums found."),m.forEach(g=>{const p=a.querySelector(`[data-album-id="${g.id}"]`);p&&(O.set(p,g),this.updateLikeState(p,"album",g.id))}),i.innerHTML=f.length?f.map(g=>this.createPlaylistCardHTML(g)).join(""):N("No playlists found."),f.forEach(g=>{const p=i.querySelector(`[data-playlist-id="${g.uuid}"]`);p&&(O.set(p,g),this.updateLikeState(p,"playlist",g.uuid))})}catch(c){if(c.name==="AbortError")return;console.error("Search failed:",c);const l=N(`Error during search. ${c.message}`);e.innerHTML=l,n.innerHTML=l,a.innerHTML=l,i.innerHTML=l}}async renderAlbumPage(t){this.showPage("album");const e=document.getElementById("album-detail-image"),n=document.getElementById("album-detail-title"),a=document.getElementById("album-detail-meta"),i=document.getElementById("album-detail-producer"),r=document.getElementById("album-detail-tracklist"),c=document.getElementById("play-album-btn");c&&(c.innerHTML=`${mt}<span>Play Album</span>`);const l=document.getElementById("download-album-btn");l&&(l.innerHTML=`${ft}<span>Download Album</span>`);const o=document.getElementById("album-mix-btn");o&&(o.style.display="none"),e.src="",e.style.backgroundColor="var(--muted)",n.innerHTML='<div class="skeleton" style="height: 48px; width: 300px; max-width: 90%;"></div>',a.innerHTML='<div class="skeleton" style="height: 16px; width: 200px; max-width: 80%;"></div>',i.innerHTML='<div class="skeleton" style="height: 16px; width: 200px; max-width: 80%;"></div>',r.innerHTML=`
            <div class="track-list-header">
                <span style="width: 40px; text-align: center;">#</span>
                <span>Title</span>
                <span class="duration-header">Duration</span>
            </div>
            ${this.createSkeletonTracks(10,!1)}
        `;try{const{album:d,tracks:h}=await this.api.getAlbum(t),u=this.api.getCoverUrl(d.cover);e.src=u,e.style.backgroundColor="",this.setPageBackground(u),yt.isEnabled()&&d.cover&&this.extractAndApplyColor(this.api.getCoverUrl(d.cover,"80"));const m=Yt(d)?this.createExplicitBadge():"";n.innerHTML=`${Y(d.title)} ${m}`,this.adjustTitleFontSize(n,d.title);const f=Et(h);let g="";if(d.releaseDate){const A=new Date(d.releaseDate);if(!isNaN(A.getTime())){const M=A.getFullYear();g=window.innerWidth>768?A.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):M}}const p=h.find(A=>A.copyright)?.copyright;a.innerHTML=(g?`${g} • `:"")+`${h.length} tracks • ${St(f)}`,i.innerHTML=`By <a href="#artist/${d.artist.id}">${d.artist.name}</a>`+(p?` • ${p}`:""),r.innerHTML=`
                <div class="track-list-header">
                    <span style="width: 40px; text-align: center;">#</span>
                    <span>Title</span>
                    <span class="duration-header">Duration</span>
                </div>
            `,h.sort((A,M)=>{const P=A.volumeNumber??A.discNumber??1,B=M.volumeNumber??M.discNumber??1;return P!==B?P-B:A.trackNumber-M.trackNumber}),this.renderListWithTracks(r,h,!1),ht.addAlbum(d);const v=document.getElementById("like-album-btn");if(v){const A=await C.isFavorite("album",d.id);v.innerHTML=this.createHeartIcon(A),v.classList.toggle("active",A)}document.title=`${d.title} - ${d.artist.name}`;const I=document.getElementById("album-section-more-albums"),y=document.getElementById("album-detail-more-albums"),b=document.getElementById("album-title-more-albums"),T=document.getElementById("album-section-eps"),k=document.getElementById("album-detail-eps"),w=document.getElementById("album-title-eps"),S=document.getElementById("album-section-similar-artists"),L=document.getElementById("album-detail-similar-artists"),x=document.getElementById("album-section-similar-albums"),_=document.getElementById("album-detail-similar-albums");[I,T,S,x].forEach(A=>{A&&(A.style.display="none")});try{const A=await this.api.getArtist(d.artist.id),M=document.getElementById("album-mix-btn");M&&A.mixes&&A.mixes.ARTIST_MIX&&(M.style.display="flex",M.onclick=()=>window.location.hash=`#mix/${A.mixes.ARTIST_MIX}`);const P=(B,D,U,z,V)=>{if(!D||!U)return;const st=(B||[]).filter(q=>q.id!=d.id).filter((q,E,$)=>E===$.findIndex(R=>R.title===q.title)).slice(0,12);st.length!==0&&(D.innerHTML=st.map(q=>this.createAlbumCardHTML(q)).join(""),z&&V&&(z.textContent=V),U.style.display="block",st.forEach(q=>{const E=D.querySelector(`[data-album-id="${q.id}"]`);E&&(O.set(E,q),this.updateLikeState(E,"album",q.id))}))};P(A.albums,y,I,b,`More albums from ${d.artist.name}`),P(A.eps,k,T,w,`EPs and Singles from ${d.artist.name}`),this.api.getSimilarArtists(d.artist.id).then(B=>{B&&B.length>0&&L&&S&&(L.innerHTML=B.map(D=>this.createArtistCardHTML(D)).join(""),S.style.display="block")}).catch(B=>console.warn("Failed to load similar artists:",B)),this.api.getSimilarAlbums(t).then(B=>{B&&B.length>0&&_&&x&&(_.innerHTML=B.map(D=>this.createAlbumCardHTML(D)).join(""),x.style.display="block",B.forEach(D=>{const U=_.querySelector(`[data-album-id="${D.id}"]`);U&&(O.set(U,D),this.updateLikeState(U,"album",D.id))}))}).catch(B=>console.warn("Failed to load similar albums:",B))}catch(A){console.warn('Failed to load "More from artist":',A)}}catch(d){console.error("Failed to load album:",d),r.innerHTML=N(`Could not load album details. ${d.message}`)}}async loadRecommendedSongsForPlaylist(t){const e=document.getElementById("playlist-section-recommended"),n=document.getElementById("playlist-detail-recommended");if(!e||!n){console.warn("Recommended songs section not found in DOM");return}try{const a=await this.api.getRecommendedTracksForPlaylist(t,20);a.length>0?(this.renderListWithTracks(n,a,!0),n.querySelectorAll(".track-item").forEach(r=>{const c=r.querySelector(".track-item-actions");if(c){const l=document.createElement("button");l.className="track-action-btn add-to-playlist-btn",l.title="Add to this playlist",l.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>',l.onclick=async d=>{d.stopPropagation();const h=O.get(r);if(h)try{const m=window.location.hash.match(/#userplaylist\/([^/]+)/);if(m){const f=m[1];await C.addTrackToPlaylist(f,h);const g=await C.getPlaylist(f);F.syncUserPlaylist(g,"update");const p=document.getElementById("playlist-detail-tracklist");if(p&&g.tracks){p.innerHTML=`
                                                <div class="track-list-header">
                                                    <span style="width: 40px; text-align: center;">#</span>
                                                    <span>Title</span>
                                                    <span class="duration-header">Duration</span>
                                                </div>
                                            `,this.renderListWithTracks(p,g.tracks,!0),document.querySelector(".remove-from-playlist-btn")&&this.enableTrackReordering(p,g.tracks,f,F);const v=document.getElementById("playlist-detail-meta");if(v){const I=Et(g.tracks);v.textContent=`${g.tracks.length} tracks • ${St(I)}`}}showNotification(`Added "${h.title}" to playlist`)}}catch(u){console.error("Failed to add track to playlist:",u),showNotification("Failed to add track to playlist")}};const o=c.querySelector(".track-menu-btn");o?c.insertBefore(l,o):c.appendChild(l)}}),e.style.display="block"):e.style.display="none"}catch(a){console.error("Failed to load recommended songs:",a),e.style.display="none"}}async renderPlaylistPage(t,e=null){this.showPage("playlist");const n=document.getElementById("playlist-detail-image"),a=document.getElementById("playlist-detail-title"),i=document.getElementById("playlist-detail-meta"),r=document.getElementById("playlist-detail-description"),c=document.getElementById("playlist-detail-tracklist"),l=document.getElementById("play-playlist-btn");l&&(l.innerHTML=`${mt}<span>Play</span>`);const o=document.getElementById("download-playlist-btn");o&&(o.innerHTML=`${ft}<span>Download</span>`),n.src="",n.style.backgroundColor="var(--muted)",a.innerHTML='<div class="skeleton" style="height: 48px; width: 300px; max-width: 90%;"></div>',i.innerHTML='<div class="skeleton" style="height: 16px; width: 200px; max-width: 80%;"></div>',r.innerHTML='<div class="skeleton" style="height: 16px; width: 100%;"></div>',c.innerHTML=`
            <div class="track-list-header">
                <span style="width: 40px; text-align: center;">#</span>
                <span>Title</span>
                <span class="duration-header">Duration</span>
            </div>
            ${this.createSkeletonTracks(10,!0)}
        `;try{const d=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t);let h=null,u=null;if((e==="user"||!e&&d)&&(u=await C.getPlaylist(t),h=u,!h))try{h=await F.getPublicPlaylist(t)}catch(m){console.warn("Failed to check public Firebase playlists:",m)}if(h){n.src=h.cover||"assets/appicon.png",n.style.backgroundColor="",a.textContent=h.name||h.title,this.adjustTitleFontSize(a,a.textContent);const m=h.tracks||[],f=Et(m);i.textContent=`${m.length} tracks • ${St(f)}`,r.textContent=h.description||"",c.innerHTML=`
                    <div class="track-list-header">
                        <span style="width: 40px; text-align: center;">#</span>
                        <span>Title</span>
                        <span class="duration-header">Duration</span>
                    </div>
                `,this.renderListWithTracks(c,m,!0),u&&(c.querySelectorAll(".track-item").forEach((b,T)=>{const k=b.querySelector(".track-item-actions"),w=document.createElement("button");w.className="track-action-btn remove-from-playlist-btn",w.title="Remove from playlist",w.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>',w.dataset.trackIndex=T;const S=k.querySelector(".track-menu-btn");k.insertBefore(w,S)}),this.enableTrackReordering(c,m,t,F));const g=document.getElementById("like-playlist-btn");g&&(g.style.display="none"),u&&this.loadRecommendedSongsForPlaylist(m),this.updatePlaylistHeaderActions(h,!!u,m);const p=[],v=new Set,I=h.tracks||[];for(const y of I){const b=y.album?.cover;if(b&&!v.has(b)&&(v.add(b),p.push(b),p.length>=4))break}ht.addPlaylist({id:h.id||h.uuid,name:h.name||h.title,title:h.title||h.name,uuid:h.uuid||h.id,cover:h.cover,images:p,numberOfTracks:h.tracks?h.tracks.length:0,isUserPlaylist:!0}),document.title=`${h.name||h.title} - Monochrome`}else{if(e==="user")throw new Error("Playlist not found. If this is a custom playlist, make sure it is set to Public.");let m=await this.api.getPlaylist(t);const{playlist:f,tracks:g}=m,p=f.squareImage||f.image;p?(n.src=this.api.getCoverUrl(p,"1080"),this.setPageBackground(n.src),this.extractAndApplyColor(this.api.getCoverUrl(p,"160"))):(n.src="assets/appicon.png",this.setPageBackground(null),this.resetVibrantColor()),a.textContent=f.title,this.adjustTitleFontSize(a,f.title);const v=Et(g);i.textContent=`${f.numberOfTracks} tracks • ${St(v)}`,r.textContent=f.description||"",c.innerHTML=`
                    <div class="track-list-header">
                        <span style="width: 40px; text-align: center;">#</span>
                        <span>Title</span>
                        <span class="duration-header">Duration</span>
                    </div>
                `,this.renderListWithTracks(c,g,!0);const I=document.getElementById("like-playlist-btn");if(I){const T=await C.isFavorite("playlist",f.uuid);I.innerHTML=this.createHeartIcon(T),I.classList.toggle("active",T),I.style.display="flex"}const y=document.getElementById("delete-playlist-btn");y&&(y.style.display="none");const b=document.getElementById("playlist-section-recommended");b&&(b.style.display="none"),this.updatePlaylistHeaderActions(f,!1,g,!1),ht.addPlaylist(f),document.title=f.title||"Artist Mix"}}catch(d){console.error("Failed to load playlist:",d),c.innerHTML=N(`Could not load playlist details. ${d.message}`)}}async renderMixPage(t){this.showPage("mix");const e=document.getElementById("mix-detail-image"),n=document.getElementById("mix-detail-title"),a=document.getElementById("mix-detail-meta"),i=document.getElementById("mix-detail-description"),r=document.getElementById("mix-detail-tracklist"),c=document.getElementById("play-mix-btn");c&&(c.innerHTML=`${mt}<span>Play</span>`);const l=document.getElementById("download-mix-btn");l&&(l.innerHTML=`${ft}<span>Download</span>`),e.src="",e.style.backgroundColor="var(--muted)",n.innerHTML='<div class="skeleton" style="height: 48px; width: 300px; max-width: 90%;"></div>',a.innerHTML='<div class="skeleton" style="height: 16px; width: 200px; max-width: 80%;"></div>',i.innerHTML='<div class="skeleton" style="height: 16px; width: 100%;"></div>',r.innerHTML=`
            <div class="track-list-header">
                <span style="width: 40px; text-align: center;">#</span>
                <span>Title</span>
                <span class="duration-header">Duration</span>
            </div>
            ${this.createSkeletonTracks(10,!0)}
        `;try{const{mix:o,tracks:d}=await this.api.getMix(t);o.cover?(e.src=o.cover,this.setPageBackground(o.cover),this.extractAndApplyColor(o.cover)):d.length>0&&d[0].album?.cover?(e.src=this.api.getCoverUrl(d[0].album.cover),this.setPageBackground(e.src),this.extractAndApplyColor(this.api.getCoverUrl(d[0].album.cover,"160"))):(e.src="assets/appicon.png",this.setPageBackground(null),this.resetVibrantColor()),e.style.backgroundColor="";const h=o.title||"Mix";n.textContent=h,this.adjustTitleFontSize(n,h);const u=Et(d);a.textContent=`${d.length} tracks • ${St(u)}`,i.innerHTML=`${o.subTitle}`,r.innerHTML=`
                <div class="track-list-header">
                    <span style="width: 40px; text-align: center;">#</span>
                    <span>Title</span>
                    <span class="duration-header">Duration</span>
                </div>
            `,this.renderListWithTracks(r,d,!0),c.onclick=()=>{this.player.setQueue(d,0),this.player.playTrackFromQueue()},ht.addMix(o);const m=document.getElementById("like-mix-btn");if(m){m.style.display="flex";const f=await C.isFavorite("mix",o.id);m.innerHTML=this.createHeartIcon(f),m.classList.toggle("active",f)}document.title=h}catch(o){console.error("Failed to load mix:",o),r.innerHTML=N(`Could not load mix details. ${o.message}`)}}async renderArtistPage(t){this.showPage("artist");const e=document.getElementById("artist-detail-image"),n=document.getElementById("artist-detail-name"),a=document.getElementById("artist-detail-meta"),i=document.getElementById("artist-detail-tracks"),r=document.getElementById("artist-detail-albums"),c=document.getElementById("artist-detail-eps"),l=document.getElementById("artist-section-eps"),o=document.getElementById("artist-detail-similar"),d=document.getElementById("artist-section-similar"),h=document.getElementById("download-discography-btn");h&&(h.innerHTML=`${ft}<span>Download Discography</span>`),e.src="",e.style.backgroundColor="var(--muted)",n.innerHTML='<div class="skeleton" style="height: 48px; width: 300px; max-width: 90%;"></div>',a.innerHTML='<div class="skeleton" style="height: 16px; width: 150px;"></div>',i.innerHTML=this.createSkeletonTracks(5,!0),r.innerHTML=this.createSkeletonCards(6,!1),c&&(c.innerHTML=this.createSkeletonCards(6,!1)),l&&(l.style.display="none"),o&&(o.innerHTML=this.createSkeletonCards(6,!0)),d&&(d.style.display="block");try{const u=await this.api.getArtist(t),m=document.getElementById("artist-mix-btn");m&&(u.mixes&&u.mixes.ARTIST_MIX?(m.style.display="flex",m.onclick=()=>window.location.hash=`#mix/${u.mixes.ARTIST_MIX}`):m.style.display="none"),o&&d&&this.api.getSimilarArtists(t).then(p=>{p&&p.length>0?(o.innerHTML=p.map(v=>this.createArtistCardHTML(v)).join(""),d.style.display="block"):d.style.display="none"}).catch(()=>{d.style.display="none"}),e.src=this.api.getArtistPictureUrl(u.picture),e.style.backgroundColor="",n.textContent=u.name,this.setPageBackground(e.src);const f=this.api.getArtistPictureUrl(u.picture,"160");this.extractAndApplyColor(f),this.adjustTitleFontSize(n,u.name),a.innerHTML=`
                <span>${u.popularity}% popularity</span>
                <div class="artist-tags">
                    ${(u.artistRoles||[]).filter(p=>p.category).map(p=>`<span class="artist-tag">${p.category}</span>`).join("")}
                </div>
            `,this.renderListWithTracks(i,u.tracks,!0);const g=document.getElementById("like-artist-btn");if(g){const p=await C.isFavorite("artist",u.id);g.innerHTML=this.createHeartIcon(p),g.classList.toggle("active",p)}r.innerHTML=u.albums.map(p=>this.createAlbumCardHTML(p)).join(""),r.innerHTML=u.albums.length?u.albums.map(p=>this.createAlbumCardHTML(p)).join(""):N("No albums found."),c&&l&&(u.eps&&u.eps.length>0?(c.innerHTML=u.eps.map(p=>this.createAlbumCardHTML(p)).join(""),l.style.display="block"):l.style.display="none"),u.albums.forEach(p=>{const v=r.querySelector(`[data-album-id="${p.id}"]`);v&&(O.set(v,p),this.updateLikeState(v,"album",p.id))}),ht.addArtist(u),document.title=u.name}catch(u){console.error("Failed to load artist:",u),i.innerHTML=r.innerHTML=N(`Could not load artist details. ${u.message}`)}}async renderRecentPage(){this.showPage("recent");const t=document.getElementById("recent-tracks-container");t.innerHTML=this.createSkeletonTracks(10,!0);try{const e=await C.getHistory();if(e.length===0){t.innerHTML=N("You haven't played any tracks yet.");return}const n={},a=new Date().setHours(0,0,0,0),i=new Date(a-864e5).setHours(0,0,0,0);e.forEach(r=>{const c=new Date(r.timestamp),l=new Date(c).setHours(0,0,0,0);let o;l===a?o="Today":l===i?o="Yesterday":o=c.toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"}),n[o]||(n[o]=[]),n[o].push(r)}),t.innerHTML="";for(const[r,c]of Object.entries(n)){const l=document.createElement("h3");l.className="track-list-header-group",l.textContent=r,l.style.margin="1.5rem 0 0.5rem 0",l.style.fontSize="1.1rem",l.style.fontWeight="600",l.style.color="var(--foreground)",l.style.paddingLeft="0.5rem",t.appendChild(l);const o=document.createElement("div");for(this.renderListWithTracks(o,c,!0);o.firstChild;)t.appendChild(o.firstChild)}}catch(e){console.error("Failed to load history:",e),t.innerHTML=N("Failed to load history.")}}updatePlaylistHeaderActions(t,e,n,a=!1){const i=document.getElementById("page-playlist").querySelector(".detail-header-actions");["shuffle-playlist-btn","edit-playlist-btn","delete-playlist-btn","share-playlist-btn"].forEach(o=>{const d=i.querySelector(`#${o}`);d&&d.remove()});const r=document.createDocumentFragment(),c=document.createElement("button");if(c.id="shuffle-playlist-btn",c.className="btn-primary",c.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 14 4 4-4 4"/><path d="m18 2 4 4-4 4"/><path d="M2 18h1.973a4 4 0 0 0 3.3-1.7l5.454-8.6a4 4 0 0 1 3.3-1.7H22"/><path d="M2 6h1.972a4 4 0 0 1 3.6 2.2"/><path d="M22 18h-6.041a4 4 0 0 1-3.3-1.8l-.359-.45"/></svg><span>Shuffle</span>',c.onclick=()=>{const o=[...n].sort(()=>Math.random()-.5);this.player.setQueue(o,0),this.player.playTrackFromQueue()},r.appendChild(c),e){const o=document.createElement("button");o.id="edit-playlist-btn",o.className="btn-secondary",o.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg><span>Edit</span>',r.appendChild(o);const d=document.createElement("button");d.id="delete-playlist-btn",d.className="btn-secondary danger",d.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg><span>Delete</span>',r.appendChild(d)}if(a||e&&t.isPublic){const o=document.createElement("button");o.id="share-playlist-btn",o.className="btn-secondary",o.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg><span>Share</span>',o.onclick=()=>{const d=`${window.location.origin}${window.location.pathname}#userplaylist/${t.id||t.uuid}`;navigator.clipboard.writeText(d).then(()=>alert("Link copied to clipboard!"))},r.appendChild(o)}const l=i.querySelector("#download-playlist-btn");if(l)for(i.insertBefore(c,l);r.firstChild;)i.appendChild(r.firstChild);else i.appendChild(r)}enableTrackReordering(t,e,n,a){let i=null,r=-1;Array.from(t.querySelectorAll(".track-item")).forEach((m,f)=>{m.draggable=!0,m.dataset.index=f});const l=m=>{i=m.target,r=parseInt(m.target.dataset.index),m.dataTransfer.effectAllowed="move",m.dataTransfer.setData("text/plain",r),i.classList.add("dragging")},o=()=>{i&&(i.classList.remove("dragging"),i=null)},d=m=>{if(m.preventDefault(),m.dataTransfer.dropEffect="move",!i)return;const f=u(t,m.clientY);f!==i&&(f?t.insertBefore(i,f):t.appendChild(i))},h=async m=>{if(m.preventDefault(),!!i)try{const f=Array.from(t.querySelectorAll(".track-item")),g=f.map(v=>{const I=parseInt(v.dataset.index);return e[I]});f.forEach((v,I)=>{v.dataset.index=I}),e.splice(0,e.length,...g);const p=await C.updatePlaylistTracks(n,g);a.syncUserPlaylist(p,"update"),i=null,r=-1}catch(f){console.error("Error updating playlist tracks:",f),i&&(i.classList.remove("dragging"),i=null),r=-1}};t.addEventListener("dragstart",l),t.addEventListener("dragend",o),t.addEventListener("dragover",d),t.addEventListener("drop",h);function u(m,f){return[...m.querySelectorAll(".track-item:not(.dragging)")].reduce((p,v)=>{const I=v.getBoundingClientRect(),y=f-I.top-I.height/2;return y<0&&y>p.offset?{offset:y,element:v}:p},{offset:Number.NEGATIVE_INFINITY}).element}}getDragAfterElement(t,e){return[...t.querySelectorAll(".track-item:not(.dragging)")].reduce((a,i)=>{const r=i.getBoundingClientRect(),c=e-r.top-r.height/2;return c<0&&c>a.offset?{offset:c,element:i}:a},{offset:Number.NEGATIVE_INFINITY}).element}renderApiSettings(){const t=document.getElementById("api-instance-list");Promise.all([this.api.settings.getInstances("api"),this.api.settings.getInstances("streaming")]).then(([e,n])=>{const i=this.api.settings.getCachedSpeedTests()?.speeds||{},r=(o,d)=>{if(!o||o.length===0)return"";const h=o.map((u,m)=>{const f=d==="streaming"?`${u}#streaming`:u,g=i[f],p=g?g.speed===1/0||typeof g.speed!="number"?'<span style="color: var(--muted-foreground); font-size: 0.8rem;">Failed</span>':`<span style="color: var(--muted-foreground); font-size: 0.8rem;">${g.speed.toFixed(0)}ms</span>`:"";return`
                        <li data-index="${m}" data-type="${d}">
                            <div style="flex: 1; min-width: 0;">
                                <div class="instance-url">${u}</div>
                                ${p}
                            </div>
                            <div class="controls">
                                <button class="move-up" title="Move Up" ${m===0?"disabled":""}>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 19V5M5 12l7-7 7 7"/>
                                    </svg>
                                </button>
                                <button class="move-down" title="Move Down" ${m===o.length-1?"disabled":""}>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 5v14M19 12l-7 7-7-7"/>
                                    </svg>
                                </button>
                            </div>
                        </li>
                    `}).join("");return`
                    <li class="group-header" style="font-weight: bold; padding: 1rem 0 0.5rem; background: transparent; border: none; pointer-events: none;">
                        ${d==="api"?"API Instances":"Streaming Instances"}
                    </li>
                    ${h}
                `};t.innerHTML=r(e,"api")+r(n,"streaming");const c=this.api.getCacheStats(),l=document.getElementById("cache-info");l&&(l.textContent=`Cache: ${c.memoryEntries}/${c.maxSize} entries`)})}}class js{constructor(t,e,n="LOSSLESS"){this.audio=t,this.api=e,this.quality=n,this.queue=[],this.shuffledQueue=[],this.originalQueueBeforeShuffle=[],this.currentQueueIndex=-1,this.shuffleActive=!1,this.repeatMode=J.OFF,this.preloadCache=new Map,this.preloadAbortController=null,this.currentTrack=null,this.currentRgValues=null,this.userVolume=parseFloat(localStorage.getItem("volume")||"0.7"),this.sleepTimer=null,this.sleepTimerEndTime=null,this.sleepTimerInterval=null,this.loadQueueState(),this.setupMediaSession(),window.addEventListener("beforeunload",()=>{this.saveQueueState()})}setVolume(t){this.userVolume=Math.max(0,Math.min(1,t)),localStorage.setItem("volume",this.userVolume),this.applyReplayGain()}applyReplayGain(){const t=bt.getMode();let e=0,n=1;if(t!=="off"&&this.currentRgValues){const{trackReplayGain:r,trackPeakAmplitude:c,albumReplayGain:l,albumPeakAmplitude:o}=this.currentRgValues;t==="album"&&l!==void 0?(e=l,n=o||1):r!==void 0&&(e=r,n=c||1),e+=bt.getPreamp()}let a=Math.pow(10,e/20);a*n>1&&(a=1/n);const i=this.userVolume*a;this.audio.volume=Math.max(0,Math.min(1,i))}loadQueueState(){const t=fe.getQueue();if(t){this.queue=t.queue||[],this.shuffledQueue=t.shuffledQueue||[],this.originalQueueBeforeShuffle=t.originalQueueBeforeShuffle||[],this.currentQueueIndex=t.currentQueueIndex??-1,this.shuffleActive=t.shuffleActive||!1,this.repeatMode=t.repeatMode||J.OFF;const e=this.shuffleActive?this.shuffledQueue:this.queue;if(this.currentQueueIndex>=0&&this.currentQueueIndex<e.length){this.currentTrack=e[this.currentQueueIndex];const n=this.currentTrack,a=et(n),i=me(n);let r="";const c=n.album?.releaseDate||n.streamStartDate;if(c){const m=new Date(c);isNaN(m.getTime())||(r=` • ${m.getFullYear()}`)}const l=document.querySelector(".now-playing-bar .cover"),o=document.querySelector(".now-playing-bar .title"),d=document.querySelector(".now-playing-bar .artist");l&&(l.src=this.api.getCoverUrl(n.album?.cover)),o&&(o.textContent=a),d&&(d.innerHTML=i+r);const h=document.getElementById("now-playing-mix-btn");h&&(h.style.display=n.mixes&&n.mixes.TRACK_MIX?"flex":"none");const u=document.getElementById("total-duration");u&&(u.textContent=xt(n.duration)),document.title=`${a} • ${tt(n)}`,this.updatePlayingTrackIndicator(),this.updateMediaSession(n)}}}saveQueueState(){fe.saveQueue({queue:this.queue,shuffledQueue:this.shuffledQueue,originalQueueBeforeShuffle:this.originalQueueBeforeShuffle,currentQueueIndex:this.currentQueueIndex,shuffleActive:this.shuffleActive,repeatMode:this.repeatMode})}setupMediaSession(){"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",()=>{this.audio.play().catch(console.error)}),navigator.mediaSession.setActionHandler("pause",()=>{this.audio.pause()}),navigator.mediaSession.setActionHandler("previoustrack",()=>{this.playPrev()}),navigator.mediaSession.setActionHandler("nexttrack",()=>{this.playNext()}),navigator.mediaSession.setActionHandler("seekbackward",t=>{const e=t.seekOffset||10;this.seekBackward(e)}),navigator.mediaSession.setActionHandler("seekforward",t=>{const e=t.seekOffset||10;this.seekForward(e)}),navigator.mediaSession.setActionHandler("seekto",t=>{t.seekTime!==void 0&&(this.audio.currentTime=Math.max(0,t.seekTime),this.updateMediaSessionPositionState())}),navigator.mediaSession.setActionHandler("stop",()=>{this.audio.pause(),this.audio.currentTime=0,this.updateMediaSessionPlaybackState()}))}setQuality(t){this.quality=t}async preloadNextTracks(){this.preloadAbortController&&this.preloadAbortController.abort(),this.preloadAbortController=new AbortController;const t=this.shuffleActive?this.shuffledQueue:this.queue,e=[];for(let n=1;n<=2;n++){const a=this.currentQueueIndex+n;a<t.length&&e.push({track:t[a],index:a})}for(const{track:n}of e){if(this.preloadCache.has(n.id))continue;const a=et(n);try{const i=await this.api.getStreamUrl(n.id,this.quality);if(this.preloadAbortController.signal.aborted)break;this.preloadCache.set(n.id,i),fetch(i,{method:"HEAD",signal:this.preloadAbortController.signal}).catch(()=>{})}catch(i){i.name!=="AbortError"&&console.debug("Failed to get stream URL for preload:",a)}}}async playTrackFromQueue(t=0){const e=this.shuffleActive?this.shuffledQueue:this.queue;if(this.currentQueueIndex<0||this.currentQueueIndex>=e.length)return;this.saveQueueState();const n=e[this.currentQueueIndex];this.currentTrack=n;const a=et(n),i=me(n);let r="";const c=n.album?.releaseDate||n.streamStartDate;if(c){const o=new Date(c);isNaN(o.getTime())||(r=` • ${o.getFullYear()}`)}document.querySelector(".now-playing-bar .cover").src=this.api.getCoverUrl(n.album?.cover),document.querySelector(".now-playing-bar .title").textContent=a,document.querySelector(".now-playing-bar .artist").innerHTML=i+r;const l=document.getElementById("now-playing-mix-btn");l&&(l.style.display=n.mixes&&n.mixes.TRACK_MIX?"flex":"none"),document.title=`${a} • ${tt(n)}`,this.updatePlayingTrackIndicator();try{const o=await this.api.getTrack(n.id,this.quality);o&&o.info?this.currentRgValues={trackReplayGain:o.info.trackReplayGain,trackPeakAmplitude:o.info.trackPeakAmplitude,albumReplayGain:o.info.albumReplayGain,albumPeakAmplitude:o.info.albumPeakAmplitude}:this.currentRgValues=null,this.applyReplayGain();let d;this.preloadCache.has(n.id)?d=this.preloadCache.get(n.id):o.originalTrackUrl?d=o.originalTrackUrl:d=this.api.extractStreamUrlFromManifest(o.info.manifest),this.audio.src=d,t>0&&(this.audio.currentTime=t),await this.audio.play(),this.updateMediaSession(n),this.updateMediaSessionPlaybackState(),this.preloadNextTracks()}catch(o){console.error(`Could not play track: ${a}`,o),document.querySelector(".now-playing-bar .title").textContent=`Error: ${a}`,document.querySelector(".now-playing-bar .artist").textContent=o.message||"Could not load track"}}playAtIndex(t){const e=this.shuffleActive?this.shuffledQueue:this.queue;t>=0&&t<e.length&&(this.currentQueueIndex=t,this.playTrackFromQueue())}playNext(){const t=this.shuffleActive?this.shuffledQueue:this.queue,e=this.currentQueueIndex>=t.length-1;if(this.repeatMode===J.ONE){this.audio.currentTime=0,this.audio.play();return}if(!e)this.currentQueueIndex++;else if(this.repeatMode===J.ALL)this.currentQueueIndex=0;else return;this.playTrackFromQueue()}playPrev(){this.audio.currentTime>3?(this.audio.currentTime=0,this.updateMediaSessionPositionState()):this.currentQueueIndex>0&&(this.currentQueueIndex--,this.playTrackFromQueue())}handlePlayPause(){if(!this.audio.src||this.audio.error){this.currentTrack&&this.playTrackFromQueue();return}this.audio.paused?this.audio.play().catch(t=>{t.name==="NotAllowedError"||t.name==="AbortError"||(console.error("Play failed, reloading track:",t),this.currentTrack&&this.playTrackFromQueue())}):(this.audio.pause(),this.saveQueueState())}seekBackward(t=10){const e=Math.max(0,this.audio.currentTime-t);this.audio.currentTime=e,this.updateMediaSessionPositionState()}seekForward(t=10){const e=this.audio.duration||0,n=Math.min(e,this.audio.currentTime+t);this.audio.currentTime=n,this.updateMediaSessionPositionState()}toggleShuffle(){if(this.shuffleActive=!this.shuffleActive,this.shuffleActive){this.originalQueueBeforeShuffle=[...this.queue];const t=this.queue[this.currentQueueIndex];this.shuffledQueue=[...this.queue].sort(()=>Math.random()-.5),this.currentQueueIndex=this.shuffledQueue.findIndex(e=>e.id===t?.id),this.currentQueueIndex===-1&&t&&(this.shuffledQueue.unshift(t),this.currentQueueIndex=0)}else{const t=this.shuffledQueue[this.currentQueueIndex];this.queue=[...this.originalQueueBeforeShuffle],this.currentQueueIndex=this.queue.findIndex(e=>e.id===t?.id)}this.preloadCache.clear(),this.preloadNextTracks(),this.saveQueueState()}toggleRepeat(){return this.repeatMode=(this.repeatMode+1)%3,this.saveQueueState(),this.repeatMode}setQueue(t,e=0){this.queue=t,this.currentQueueIndex=e,this.shuffleActive=!1,this.preloadCache.clear(),this.saveQueueState()}addToQueue(t){this.queue.push(t),(!this.currentTrack||this.currentQueueIndex===-1)&&(this.currentQueueIndex=this.queue.length-1,this.playTrackFromQueue()),this.saveQueueState()}addNextToQueue(t){const e=this.shuffleActive?this.shuffledQueue:this.queue,n=this.currentQueueIndex+1;e.splice(n,0,t),this.shuffleActive&&this.originalQueueBeforeShuffle.push(t),this.saveQueueState(),this.preloadNextTracks()}removeFromQueue(t){const e=this.shuffleActive?this.shuffledQueue:this.queue;this.currentQueueIndex,t<this.currentQueueIndex&&this.currentQueueIndex--;const n=e.splice(t,1)[0];if(this.shuffleActive){const a=this.originalQueueBeforeShuffle.findIndex(i=>i.id===n.id);a!==-1&&this.originalQueueBeforeShuffle.splice(a,1)}this.saveQueueState(),this.preloadNextTracks()}clearQueue(){this.queue=[],this.shuffledQueue=[],this.originalQueueBeforeShuffle=[],this.currentQueueIndex=-1,this.preloadCache.clear(),this.saveQueueState()}moveInQueue(t,e){const n=this.shuffleActive?this.shuffledQueue:this.queue;if(t<0||t>=n.length||e<0||e>=n.length)return;const[a]=n.splice(t,1);n.splice(e,0,a),this.currentQueueIndex===t?this.currentQueueIndex=e:t<this.currentQueueIndex&&e>=this.currentQueueIndex?this.currentQueueIndex--:t>this.currentQueueIndex&&e<=this.currentQueueIndex&&this.currentQueueIndex++,this.saveQueueState()}getCurrentQueue(){return this.shuffleActive?this.shuffledQueue:this.queue}getNextTrack(){const t=this.getCurrentQueue();if(this.currentQueueIndex===-1||t.length===0)return null;const e=this.currentQueueIndex+1;return e<t.length?t[e]:this.repeatMode===J.ALL?t[0]:null}updatePlayingTrackIndicator(){const t=this.getCurrentQueue()[this.currentQueueIndex];document.querySelectorAll(".track-item").forEach(e=>{e.classList.toggle("playing",t&&e.dataset.trackId==t.id)}),document.querySelectorAll(".queue-track-item").forEach(e=>{const n=parseInt(e.dataset.queueIndex);e.classList.toggle("playing",n===this.currentQueueIndex)})}updateMediaSession(t){if(!("mediaSession"in navigator))return;navigator.mediaSession.metadata=null;const e=[],n=["320"],a=t.album?.cover,i=et(t);a&&n.forEach(r=>{e.push({src:this.api.getCoverUrl(a,r),sizes:`${r}x${r}`,type:"image/jpeg"})}),navigator.mediaSession.metadata=new MediaMetadata({title:i||"Unknown Title",artist:tt(t)||"Unknown Artist",album:t.album?.title||"Unknown Album",artwork:e.length>0?e:void 0}),this.updateMediaSessionPlaybackState(),this.updateMediaSessionPositionState()}updateMediaSessionPlaybackState(){"mediaSession"in navigator&&(navigator.mediaSession.playbackState=this.audio.paused?"paused":"playing")}updateMediaSessionPositionState(){if(!("mediaSession"in navigator)||!("setPositionState"in navigator.mediaSession))return;const t=this.audio.duration;if(!(!t||isNaN(t)||!isFinite(t)))try{navigator.mediaSession.setPositionState({duration:t,playbackRate:this.audio.playbackRate||1,position:Math.min(this.audio.currentTime,t)})}catch(e){console.debug("Failed to update Media Session position:",e)}}setSleepTimer(t){this.clearSleepTimer(),this.sleepTimerEndTime=Date.now()+t*60*1e3,this.sleepTimer=setTimeout(()=>{this.audio.pause(),this.clearSleepTimer(),this.updateSleepTimerUI()},t*60*1e3),this.sleepTimerInterval=setInterval(()=>{this.updateSleepTimerUI()},1e3),this.updateSleepTimerUI()}clearSleepTimer(){this.sleepTimer&&(clearTimeout(this.sleepTimer),this.sleepTimer=null),this.sleepTimerInterval&&(clearInterval(this.sleepTimerInterval),this.sleepTimerInterval=null),this.sleepTimerEndTime=null,this.updateSleepTimerUI()}getSleepTimerRemaining(){if(!this.sleepTimerEndTime)return null;const t=Math.max(0,this.sleepTimerEndTime-Date.now());return Math.ceil(t/1e3)}isSleepTimerActive(){return this.sleepTimer!==null}updateSleepTimerUI(){const t=document.getElementById("sleep-timer-btn"),e=document.getElementById("sleep-timer-btn-desktop"),n=a=>{if(a)if(this.isSleepTimerActive()){const i=this.getSleepTimerRemaining();if(i>0){const r=Math.floor(i/60),c=i%60;a.innerHTML=`<span style="font-size: 12px; font-weight: bold;">${r}:${c.toString().padStart(2,"0")}</span>`,a.title=`Sleep Timer: ${r}:${c.toString().padStart(2,"0")} remaining`,a.classList.add("active"),a.style.color="var(--primary)"}else a.innerHTML=`
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12,6 12,12 16,14"/>
                        </svg>
                    `,a.title="Sleep Timer",a.classList.remove("active"),a.style.color=""}else a.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                `,a.title="Sleep Timer",a.classList.remove("active"),a.style.color=""};n(t),n(e)}}const qs="modulepreload",Qs=function(s,t){return new URL(s,t).href},ye={},Q=function(t,e,n){let a=Promise.resolve();if(e&&e.length>0){let o=function(d){return Promise.all(d.map(h=>Promise.resolve(h).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};const r=document.getElementsByTagName("link"),c=document.querySelector("meta[property=csp-nonce]"),l=c?.nonce||c?.getAttribute("nonce");a=o(e.map(d=>{if(d=Qs(d,n),d in ye)return;ye[d]=!0;const h=d.endsWith(".css"),u=h?'[rel="stylesheet"]':"";if(n)for(let f=r.length-1;f>=0;f--){const g=r[f];if(g.href===d&&(!h||g.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${u}`))return;const m=document.createElement("link");if(m.rel=h?"stylesheet":qs,h||(m.as="script"),m.crossOrigin="",m.href=d,l&&m.setAttribute("nonce",l),document.head.appendChild(m),h)return new Promise((f,g)=>{m.addEventListener("load",f),m.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${d}`)))})}))}function i(r){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=r,window.dispatchEvent(c),!c.defaultPrevented)throw r}return a.then(r=>{for(const c of r||[])c.status==="rejected"&&i(c.reason);return t().catch(i)})};class zs{constructor(){this.API_KEY="0ecf01914957b40c17030db822845a76",this.API_SECRET="bd37e61e0b16b8c7bf8de2862de5493c",this.API_URL="https://ws.audioscrobbler.com/2.0/",this.sessionKey=null,this.username=null,this.currentTrack=null,this.scrobbleTimer=null,this.scrobbleThreshold=0,this.hasScrobbled=!1,this.loadSession()}loadSession(){try{const t=localStorage.getItem("lastfm-session");if(t){const e=JSON.parse(t);this.sessionKey=e.key,this.username=e.name}}catch(t){console.error("Failed to load Last.fm session:",t)}}saveSession(t,e){this.sessionKey=t,this.username=e,localStorage.setItem("lastfm-session",JSON.stringify({key:t,name:e}))}clearSession(){this.sessionKey=null,this.username=null,localStorage.removeItem("lastfm-session")}isAuthenticated(){return!!this.sessionKey}async generateSignature(t){const e={...t};delete e.format,delete e.callback;const a=Object.keys(e).sort().map(i=>`${i}${e[i]}`).join("")+this.API_SECRET;console.log("Signature string:",a);try{const{default:i}=await Q(async()=>{const{default:r}=await import("https://cdn.jsdelivr.net/npm/md5@2.3.0/+esm");return{default:r}},[],import.meta.url);return i(a)}catch{throw console.error("MD5 library not available"),new Error("MD5 library required for Last.fm")}}async makeRequest(t,e={},n=!1){const a={method:t,api_key:this.API_KEY,...e};n&&this.sessionKey&&(a.sk=this.sessionKey);const i=await this.generateSignature(a),r=new URLSearchParams({...a,api_sig:i,format:"json"});try{const l=await(await fetch(this.API_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r})).json();if(l.error)throw new Error(l.message||"Last.fm API error");return l}catch(c){throw console.error("Last.fm API request failed:",c),c}}async getAuthUrl(){try{const e=(await this.makeRequest("auth.getToken")).token;return{token:e,url:`https://www.last.fm/api/auth/?api_key=${this.API_KEY}&token=${e}`}}catch(t){throw console.error("Failed to get auth URL:",t),t}}async completeAuthentication(t){try{const e=await this.makeRequest("auth.getSession",{token:t});if(e.session)return this.saveSession(e.session.key,e.session.name),{success:!0,username:e.session.name};throw new Error("No session returned")}catch(e){throw console.error("Authentication failed:",e),e}}async updateNowPlaying(t){if(this.isAuthenticated()){this.currentTrack=t,this.hasScrobbled=!1,this.clearScrobbleTimer();try{const e={artist:t.artist?.name||t.artists?.[0]?.name||"Unknown Artist",track:t.title};t.album?.title&&(e.album=t.album.title),t.duration&&(e.duration=Math.floor(t.duration)),t.trackNumber&&(e.trackNumber=t.trackNumber),await this.makeRequest("track.updateNowPlaying",e,!0),console.log("Now playing updated:",t.title),this.scrobbleThreshold=Math.min(t.duration/2,240),this.scheduleScrobble(this.scrobbleThreshold*1e3)}catch(e){console.error("Failed to update now playing:",e)}}}scheduleScrobble(t){this.clearScrobbleTimer(),this.scrobbleTimer=setTimeout(()=>{this.scrobbleCurrentTrack()},t)}clearScrobbleTimer(){this.scrobbleTimer&&(clearTimeout(this.scrobbleTimer),this.scrobbleTimer=null)}async scrobbleCurrentTrack(){if(!(!this.isAuthenticated()||!this.currentTrack||this.hasScrobbled))try{const t=Math.floor(Date.now()/1e3),e={artist:this.currentTrack.artist?.name||this.currentTrack.artists?.[0]?.name||"Unknown Artist",track:this.currentTrack.title,timestamp:t};this.currentTrack.album?.title&&(e.album=this.currentTrack.album.title),this.currentTrack.duration&&(e.duration=Math.floor(this.currentTrack.duration)),this.currentTrack.trackNumber&&(e.trackNumber=this.currentTrack.trackNumber),await this.makeRequest("track.scrobble",e,!0),this.hasScrobbled=!0,console.log("Scrobbled:",this.currentTrack.title)}catch(t){console.error("Failed to scrobble:",t)}}async loveTrack(t){if(this.isAuthenticated())try{const e={artist:t.artist?.name||t.artists?.[0]?.name||"Unknown Artist",track:t.title};await this.makeRequest("track.love",e,!0),console.log("Loved track on Last.fm:",t.title)}catch(e){console.error("Failed to love track on Last.fm:",e)}}onTrackChange(t){this.isAuthenticated()&&this.updateNowPlaying(t)}onPlaybackStop(){this.clearScrobbleTimer()}disconnect(){this.clearSession(),this.clearScrobbleTimer(),this.currentTrack=null}}function Ks(s){return()=>{const e=window.location.hash.substring(1)||"home",[n,a]=e.split("/");switch(n){case"search":s.renderSearchPage(decodeURIComponent(a));break;case"album":s.renderAlbumPage(a);break;case"artist":s.renderArtistPage(a);break;case"playlist":s.renderPlaylistPage(a,"api");break;case"userplaylist":s.renderPlaylistPage(a,"user");break;case"mix":s.renderMixPage(a);break;case"library":s.renderLibraryPage();break;case"recent":s.renderRecentPage();break;case"home":s.renderHomePage();break;default:s.showPage(n);break}}}function He(s){if(s.currentTrack){const t=s.currentTrack;document.title=`${t.title} • ${tt(t)}`}else{const t=window.location.hash;if(t.includes("#album/")||t.includes("#playlist/"))return;document.title="Monochrome Music"}}class Gs{constructor(){this.user=null,this.unsubscribe=null,this.init()}init(){X&&(this.unsubscribe=Ge(X,t=>{this.user=t,this.updateUI(t),t?(console.log("User logged in:",t.uid),F.initialize(t)):(console.log("User logged out"),F.disconnect())}))}async signInWithGoogle(){if(!X){alert("Firebase is not configured. Please check console.");return}try{return(await We(X,Pe)).user}catch(t){throw console.error("Login failed:",t),alert(`Login failed: ${t.message}`),t}}async signInWithEmail(t,e){if(!X){alert("Firebase is not configured.");return}try{return(await Ve(X,t,e)).user}catch(n){throw console.error("Email Login failed:",n),alert(`Login failed: ${n.message}`),n}}async signUpWithEmail(t,e){if(!X){alert("Firebase is not configured.");return}try{return(await Ye(X,t,e)).user}catch(n){throw console.error("Sign Up failed:",n),alert(`Sign Up failed: ${n.message}`),n}}async signOut(){if(X)try{await Je(X)}catch(t){throw console.error("Logout failed:",t),t}}updateUI(t){const e=document.getElementById("firebase-connect-btn"),n=document.getElementById("firebase-clear-cloud-btn"),a=document.getElementById("firebase-status"),i=document.getElementById("email-auth-container"),r=document.getElementById("toggle-email-auth-btn");e&&(t?(e.textContent="Sign Out",e.classList.add("danger"),e.onclick=()=>this.signOut(),n&&(n.style.display="block"),i&&(i.style.display="none"),r&&(r.style.display="none"),a&&(a.textContent=`Signed in as ${t.email}`)):(e.textContent="Connect with Google",e.classList.remove("danger"),e.onclick=()=>this.signInWithGoogle(),n&&(n.style.display="none"),r&&(r.style.display="inline-block"),a&&(a.textContent="Sync your library across devices")))}}const It=new Gs;function Ws(s,t,e,n){It.updateUI(It.user),Ns();const a=document.getElementById("toggle-email-auth-btn"),i=document.getElementById("cancel-email-auth-btn"),r=document.getElementById("email-auth-container"),c=document.getElementById("auth-buttons-container"),l=document.getElementById("auth-email"),o=document.getElementById("auth-password"),d=document.getElementById("email-signin-btn"),h=document.getElementById("email-signup-btn");a&&r&&c&&a.addEventListener("click",()=>{r.style.display="flex",c.style.display="none"}),i&&r&&c&&i.addEventListener("click",()=>{r.style.display="none",c.style.display="flex"}),d&&d.addEventListener("click",async()=>{const E=l.value,$=o.value;if(!E||!$){alert("Please enter both email and password.");return}try{await It.signInWithEmail(E,$),r.style.display="none",c.style.display="flex",l.value="",o.value=""}catch{}}),h&&h.addEventListener("click",async()=>{const E=l.value,$=o.value;if(!E||!$){alert("Please enter both email and password.");return}try{await It.signUpWithEmail(E,$),r.style.display="none",c.style.display="flex",l.value="",o.value=""}catch{}});const u=document.getElementById("lastfm-connect-btn"),m=document.getElementById("lastfm-status"),f=document.getElementById("lastfm-toggle"),g=document.getElementById("lastfm-toggle-setting"),p=document.getElementById("lastfm-love-toggle"),v=document.getElementById("lastfm-love-setting");function I(){s.isAuthenticated()?(m.textContent=`Connected as ${s.username}`,u.textContent="Disconnect",u.classList.add("danger"),g.style.display="flex",v.style.display="flex",f.checked=lt.isEnabled(),p.checked=lt.shouldLoveOnLike()):(m.textContent="Connect your Last.fm account to scrobble tracks",u.textContent="Connect Last.fm",u.classList.remove("danger"),g.style.display="none",v.style.display="none")}I(),u?.addEventListener("click",async()=>{if(s.isAuthenticated()){confirm("Disconnect from Last.fm?")&&(s.disconnect(),I());return}const E=window.open("","_blank");u.disabled=!0,u.textContent="Opening Last.fm...";try{const{token:$,url:R}=await s.getAuthUrl();if(E)E.location.href=R;else{alert("Popup blocked! Please allow popups."),u.textContent="Connect Last.fm",u.disabled=!1;return}u.textContent="Waiting for authorization...";let H=0;const at=30,K=setInterval(async()=>{if(H++,H>at){clearInterval(K),u.textContent="Connect Last.fm",u.disabled=!1,E&&!E.closed&&E.close(),alert("Authorization timed out. Please try again.");return}try{const Gt=await s.completeAuthentication($);Gt.success&&(clearInterval(K),E&&!E.closed&&E.close(),I(),u.disabled=!1,lt.setEnabled(!0),f.checked=!0,alert(`Successfully connected to Last.fm as ${Gt.username}!`))}catch{}},2e3)}catch($){console.error("Last.fm connection failed:",$),alert("Failed to connect to Last.fm: "+$.message),u.textContent="Connect Last.fm",u.disabled=!1,E&&!E.closed&&E.close()}}),f?.addEventListener("change",E=>{lt.setEnabled(E.target.checked)}),p?.addEventListener("change",E=>{lt.setLoveOnLike(E.target.checked)});const y=document.getElementById("theme-picker"),b=ot.getTheme();y.querySelectorAll(".theme-option").forEach(E=>{E.dataset.theme===b&&E.classList.add("active"),E.addEventListener("click",()=>{const $=E.dataset.theme;y.querySelectorAll(".theme-option").forEach(R=>R.classList.remove("active")),E.classList.add("active"),$==="custom"?(document.getElementById("custom-theme-editor").classList.add("show"),T(),ot.setTheme("custom")):(document.getElementById("custom-theme-editor").classList.remove("show"),ot.setTheme($))})});function T(){const E=document.getElementById("theme-color-grid"),$=ot.getCustomTheme()||{background:"#000000",foreground:"#fafafa",primary:"#ffffff",secondary:"#27272a",muted:"#27272a",border:"#27272a",highlight:"#ffffff"};E.innerHTML=Object.entries($).map(([R,H])=>`
            <div class="theme-color-input">
                <label>${R}</label>
                <input type="color" data-color="${R}" value="${H}">
            </div>
        `).join("")}document.getElementById("apply-custom-theme")?.addEventListener("click",()=>{const E={};document.querySelectorAll('#theme-color-grid input[type="color"]').forEach($=>{E[$.dataset.color]=$.value}),ot.setCustomTheme(E)}),document.getElementById("reset-custom-theme")?.addEventListener("click",()=>{T()});const k=document.getElementById("streaming-quality-setting");if(k){const E=localStorage.getItem("playback-quality")||"LOSSLESS";k.value=E,t.setQuality(E),k.addEventListener("change",$=>{const R=$.target.value;t.setQuality(R),localStorage.setItem("playback-quality",R)})}const w=document.getElementById("download-quality-setting");w&&(w.value=ct.getQuality(),w.addEventListener("change",E=>{ct.setQuality(E.target.value)}));const S=document.getElementById("replay-gain-mode");S&&(S.value=bt.getMode(),S.addEventListener("change",E=>{bt.setMode(E.target.value),t.applyReplayGain()}));const L=document.getElementById("replay-gain-preamp");L&&(L.value=bt.getPreamp(),L.addEventListener("change",E=>{bt.setPreamp(parseFloat(E.target.value)||3),t.applyReplayGain()}));const x=document.getElementById("now-playing-mode");x&&(x.value=te.getMode(),x.addEventListener("change",E=>{te.setMode(E.target.value)}));const _=document.getElementById("track-list-actions-mode");_&&(_.value=ee.getMode(),_.addEventListener("change",E=>{ee.setMode(E.target.value)}));const A=document.getElementById("compact-artist-toggle");A&&(A.checked=nt.isCompactArtist(),A.addEventListener("change",E=>{nt.setCompactArtist(E.target.checked)}));const M=document.getElementById("compact-album-toggle");M&&(M.checked=nt.isCompactAlbum(),M.addEventListener("change",E=>{nt.setCompactAlbum(E.target.checked)}));const P=document.getElementById("download-lyrics-toggle");P&&(P.checked=At.shouldDownloadLyrics(),P.addEventListener("change",E=>{At.setDownloadLyrics(E.target.checked)}));const B=document.getElementById("romaji-lyrics-toggle");B&&(B.checked=localStorage.getItem("lyricsRomajiMode")==="true",B.addEventListener("change",E=>{localStorage.setItem("lyricsRomajiMode",E.target.checked?"true":"false")}));const D=document.getElementById("album-background-toggle");D&&(D.checked=yt.isEnabled(),D.addEventListener("change",E=>{yt.setEnabled(E.target.checked)}));const U=document.getElementById("waveform-toggle");U&&(U.checked=se.isEnabled(),U.addEventListener("change",E=>{se.setEnabled(E.target.checked),window.dispatchEvent(new CustomEvent("waveform-toggle",{detail:{enabled:E.target.checked}}))}));const z=document.getElementById("smooth-scrolling-toggle");z&&(z.checked=ne.isEnabled(),z.addEventListener("change",E=>{ne.setEnabled(E.target.checked),window.dispatchEvent(new CustomEvent("smooth-scrolling-toggle",{detail:{enabled:E.target.checked}}))}));const V=document.getElementById("filename-template");V&&(V.value=localStorage.getItem("filename-template")||"{trackNumber} - {artist} - {title}",V.addEventListener("change",E=>{localStorage.setItem("filename-template",E.target.value)}));const st=document.getElementById("zip-folder-template");st&&(st.value=localStorage.getItem("zip-folder-template")||"{albumTitle} - {albumArtist}",st.addEventListener("change",E=>{localStorage.setItem("zip-folder-template",E.target.value)})),document.getElementById("refresh-speed-test-btn")?.addEventListener("click",async()=>{const E=document.getElementById("refresh-speed-test-btn"),$=E.textContent;E.textContent="Testing...",E.disabled=!0;try{await e.settings.refreshSpeedTests(),n.renderApiSettings(),E.textContent="Done!",setTimeout(()=>{E.textContent=$,E.disabled=!1},1500)}catch(R){console.error("Failed to refresh speed tests:",R),E.textContent="Error",setTimeout(()=>{E.textContent=$,E.disabled=!1},1500)}}),document.getElementById("api-instance-list")?.addEventListener("click",async E=>{const $=E.target.closest("button");if(!$)return;const R=$.closest("li"),H=parseInt(R.dataset.index,10),at=R.dataset.type||"api",K=await e.settings.getInstances(at);$.classList.contains("move-up")&&H>0?[K[H],K[H-1]]=[K[H-1],K[H]]:$.classList.contains("move-down")&&H<K.length-1&&([K[H],K[H+1]]=[K[H+1],K[H]]),e.settings.saveInstances(K,at),n.renderApiSettings()}),document.getElementById("clear-cache-btn")?.addEventListener("click",async()=>{const E=document.getElementById("clear-cache-btn"),$=E.textContent;E.textContent="Clearing...",E.disabled=!0;try{await e.clearCache(),E.textContent="Cleared!",setTimeout(()=>{E.textContent=$,E.disabled=!1,window.location.hash.includes("settings")&&n.renderApiSettings()},1500)}catch(R){console.error("Failed to clear cache:",R),E.textContent="Error",setTimeout(()=>{E.textContent=$,E.disabled=!1},1500)}}),document.getElementById("firebase-clear-cloud-btn")?.addEventListener("click",async()=>{if(confirm("Are you sure you want to delete ALL your data from the cloud? This cannot be undone."))try{await F.clearCloudData(),alert("Cloud data cleared successfully."),It.signOut()}catch(E){console.error("Failed to clear cloud data:",E),alert("Failed to clear cloud data: "+E.message)}}),document.getElementById("export-library-btn")?.addEventListener("click",async()=>{const E=await C.exportData(),$=new Blob([JSON.stringify(E,null,2)],{type:"application/json"}),R=URL.createObjectURL($),H=document.createElement("a");H.href=R,H.download=`monochrome-library-${new Date().toISOString().split("T")[0]}.json`,H.click(),URL.revokeObjectURL(R)});const q=document.getElementById("import-library-input");document.getElementById("import-library-btn")?.addEventListener("click",()=>{q.click()}),q?.addEventListener("change",async E=>{const $=E.target.files[0];if(!$)return;const R=new FileReader;R.onload=async H=>{try{const at=JSON.parse(H.target.result);await C.importData(at),alert("Library imported successfully!"),window.location.reload()}catch(at){console.error("Import failed:",at),alert("Failed to import library. Please check the file format.")}},R.readAsText($)})}const Bt=new Map,$t=new Map,Zt=new Set;let W=null;function re(s,t,e){if(!e)return;const n=t?`${t}/cover.jpg`:"cover.jpg";s.file(n)||s.file(n,e)}async function Vs(){try{return(await Q(()=>import("https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm"),[],import.meta.url)).default}catch(s){throw console.error("Failed to load JSZip:",s),new Error("Failed to load ZIP library")}}function oe(){return W||(W=document.createElement("div"),W.id="download-notifications",document.body.appendChild(W)),W}function G(s){const t=oe(),e=document.createElement("div");e.className="download-task",e.innerHTML=`
        <div style="display: flex; align-items: start;">
            ${s}
        </div>
    `,t.appendChild(e),setTimeout(()=>{e.style.animation="slideOut 0.3s ease",setTimeout(()=>e.remove(),300)},1500)}function Oe(s,t,e,n,a){const i=oe(),r=document.createElement("div");r.className="download-task",r.dataset.trackId=s;const c=et(t),l=tt(t);return r.innerHTML=`
        <div style="display: flex; align-items: start; gap: 0.75rem;">
            <img src="${n.getCoverUrl(t.album?.cover)}"
                 style="width: 40px; height: 40px; border-radius: 4px; flex-shrink: 0;">
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 500; font-size: 0.9rem; margin-bottom: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${c}</div>
                <div style="font-size: 0.8rem; color: var(--muted-foreground); margin-bottom: 0.5rem;">${l}</div>
                <div class="download-progress-bar" style="height: 4px; background: var(--secondary); border-radius: 2px; overflow: hidden;">
                    <div class="download-progress-fill" style="width: 0%; height: 100%; background: var(--highlight); transition: width 0.2s;"></div>
                </div>
                <div class="download-status" style="font-size: 0.75rem; color: var(--muted-foreground); margin-top: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Starting...</div>
            </div>
            <button class="download-cancel" style="background: transparent; border: none; color: var(--muted-foreground); cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s;">
                ${Pt}
            </button>
        </div>
    `,i.appendChild(r),Bt.set(s,{taskEl:r,abortController:a}),r.querySelector(".download-cancel").addEventListener("click",()=>{a.abort(),Ut(s)}),{taskEl:r,abortController:a}}function Fe(s,t){const e=Bt.get(s);if(!e)return;const{taskEl:n}=e,a=n.querySelector(".download-progress-fill"),i=n.querySelector(".download-status");if(t.stage==="downloading"){const r=t.totalBytes?Math.round(t.receivedBytes/t.totalBytes*100):0;a.style.width=`${r}%`;const c=(t.receivedBytes/(1024*1024)).toFixed(1),l=t.totalBytes?(t.totalBytes/(1024*1024)).toFixed(1):"?";i.textContent=`Downloading: ${c}MB / ${l}MB (${r}%)`}}function ae(s,t=!0,e=null){const n=Bt.get(s);if(!n)return;const{taskEl:a}=n,i=a.querySelector(".download-progress-fill"),r=a.querySelector(".download-status"),c=a.querySelector(".download-cancel");t?(i.style.width="100%",i.style.background="#10b981",r.textContent="✓ Downloaded",r.style.color="#10b981",c.remove(),setTimeout(()=>Ut(s),3e3)):(i.style.background="#ef4444",r.textContent=e||"✗ Download failed",r.style.color="#ef4444",c.innerHTML=`
            ${Pt}
        `,c.onclick=()=>Ut(s),setTimeout(()=>Ut(s),5e3))}function Ut(s){const t=Bt.get(s);if(!t)return;const{taskEl:e}=t;e.style.animation="slideOut 0.3s ease",setTimeout(()=>{e.remove(),Bt.delete(s),W&&W.children.length===0&&(W.remove(),W=null)},300)}function Ys(s){$t.get(s)&&(s.style.animation="slideOut 0.3s ease",setTimeout(()=>{s.remove(),$t.delete(s),W&&W.children.length===0&&(W.remove(),W=null)},300))}async function Ne(s,t,e,n=null,a=null){let i={...s,artist:s.artist||(s.artists&&s.artists.length>0?s.artists[0]:null)};if(i.album&&!i.album.title&&i.album.id)try{const d=await e.getAlbum(i.album.id);d.album&&(i.album={...i.album,...d.album})}catch(d){console.warn("Failed to fetch album data for metadata:",d)}const r=await e.getTrack(s.id,t);let c;if(r.originalTrackUrl)c=r.originalTrackUrl;else if(c=e.extractStreamUrlFromManifest(r.info.manifest),!c)throw new Error("Could not resolve stream URL");const l=await fetch(c,{signal:a});if(!l.ok)throw new Error(`Failed to fetch track: ${l.status}`);let o=await l.blob();return o=await Ae(o,i,e,t),o}async function Qt(s,t,e,n,a=null){ce(e,n,n,"Creating ZIP...");try{if(a){const i=await a.createWritable();await new Promise((r,c)=>{s.generateInternalStream({type:"uint8array",compression:"STORE",streamFiles:!0}).on("data",(l,o)=>{i.write(l)}).on("error",l=>{i.close(),c(l)}).on("end",()=>{i.close(),r()}).resume()})}else{const i=await s.generateAsync({type:"blob",compression:"STORE",streamFiles:!0}),r=URL.createObjectURL(i),c=document.createElement("a");c.href=r,c.download=`${t}.zip`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(r)}vt(e,!0)}catch(i){console.error("ZIP generation failed:",i),vt(e,!1,"ZIP creation failed")}}async function zt(s,t=!1){const e=await Vs(),n=new e;let a=null;if(t&&window.showSaveFilePicker)try{a=await window.showSaveFilePicker({suggestedName:`${s}.zip`,types:[{description:"ZIP Archive",accept:{"application/zip":[".zip"]}}]})}catch(i){if(i.name==="AbortError")return null;throw i}return{zip:n,fileHandle:a}}async function le(s,t,e,n,a,i,r,c=0,l=t.length){const{abortController:o}=$t.get(r),d=o.signal;for(let h=0;h<t.length;h++){const u=t[h],m=c+h,f=jt(u,a),g=et(u);ce(r,m,l,g);try{const p=await Ne(u,a,n,null,d);if(s.file(`${e}/${f}`,p),i&&At.shouldDownloadLyrics())try{const v=await i.fetchLyrics(u.id,u);if(v){const I=i.generateLRCContent(v,u);if(I){const y=f.replace(/\.[^.]+$/,".lrc");s.file(`${e}/${y}`,I)}}}catch{console.log("Could not add lyrics for:",g)}}catch(p){if(p.name==="AbortError")throw p;console.error(`Failed to download track ${g}:`,p)}}}async function Js(s,t,e,n=null){const a=`Queue - ${new Date().toISOString().slice(0,10)}`,i=await zt(a,s.length>=20);if(!i)return;const{zip:r,fileHandle:c}=i,l=Kt("queue","Queue",s.length);try{await le(r,s,a,t,e,n,l),await Qt(r,a,l,s.length,c)}catch(o){if(o.name==="AbortError")return;throw vt(l,!1,o.message),o}}async function Ue(s,t,e,n,a=null){const i=s.releaseDate||(t[0]?.streamStartDate?t[0].streamStartDate.split("T")[0]:""),r=i?new Date(i):null,c=r&&!isNaN(r.getTime())?r.getFullYear():"",l=qt(localStorage.getItem("zip-folder-template")||"{albumTitle} - {albumArtist}",{albumTitle:s.title,albumArtist:s.artist?.name,year:c}),o=await zt(l,t.length>=20);if(!o)return;const{zip:d,fileHandle:h}=o,u=await _t(e,s.cover||s.album?.cover||s.coverId),m=Kt("album",s.title,t.length);try{re(d,l,u),await le(d,t,l,e,n,a,m),await Qt(d,l,m,t.length,h)}catch(f){if(f.name==="AbortError")return;throw vt(m,!1,f.message),f}}async function ie(s,t,e,n,a=null){const i=qt(localStorage.getItem("zip-folder-template")||"{albumTitle} - {albumArtist}",{albumTitle:s.title,albumArtist:"Playlist",year:new Date().getFullYear()}),r=await zt(i,t.length>=20);if(!r)return;const{zip:c,fileHandle:l}=r,o=Kt("playlist",s.title,t.length);try{const d=t.find(u=>u.album?.cover),h=await _t(e,d?.album?.cover);re(c,i,h),await le(c,t,i,e,n,a,o),await Qt(c,i,o,t.length,l)}catch(d){if(d.name==="AbortError")return;throw vt(o,!1,d.message),d}}async function je(s,t,e,n,a=null){const i=`${gt(s.name)} discography`,r=await zt(i,!0);if(!r)return;const{zip:c,fileHandle:l}=r,o=Kt("discography",s.name,t.length),{abortController:d}=$t.get(o),h=d.signal;try{for(let u=0;u<t.length;u++){const m=t[u];ce(o,u,t.length,m.title);try{const{album:f,tracks:g}=await e.getAlbum(m.id),p=await _t(e,f.cover||m.cover),v=f.releaseDate||(g[0]?.streamStartDate?g[0].streamStartDate.split("T")[0]:""),I=v?new Date(v):null,y=I&&!isNaN(I.getTime())?I.getFullYear():"",b=qt(localStorage.getItem("zip-folder-template")||"{albumTitle} - {albumArtist}",{albumTitle:f.title,albumArtist:f.artist?.name,year:y}),T=`${i}/${b}`;re(c,T,p);for(const k of g){const w=jt(k,n);try{const S=await Ne(k,n,e,null,h);if(c.file(`${T}/${w}`,S),a&&At.shouldDownloadLyrics())try{const L=await a.fetchLyrics(k.id,k);if(L){const x=a.generateLRCContent(L,k);if(x){const _=w.replace(/\.[^.]+$/,".lrc");c.file(`${T}/${_}`,x)}}}catch{}}catch(S){if(S.name==="AbortError")throw S;console.error(`Failed to download track ${k.title}:`,S)}}}catch(f){if(f.name==="AbortError")throw f;console.error(`Failed to download album ${m.title}:`,f)}}await Qt(c,i,o,t.length,l)}catch(u){if(u.name==="AbortError")return;throw vt(o,!1,u.message),u}}function Kt(s,t,e){const n=oe(),a=document.createElement("div");a.className="download-task bulk-download",a.dataset.bulkType=s,a.dataset.bulkName=t;const i=s==="album"?"Album":s==="playlist"?"Playlist":"Discography";a.innerHTML=`
        <div style="display: flex; align-items: start; gap: 0.75rem;">
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.25rem;">
                    Downloading ${i}
                </div>
                <div style="font-size: 0.85rem; color: var(--muted-foreground); margin-bottom: 0.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${t}</div>
                <div class="download-progress-bar" style="height: 4px; background: var(--secondary); border-radius: 2px; overflow: hidden;">
                    <div class="download-progress-fill" style="width: 0%; height: 100%; background: var(--highlight); transition: width 0.2s;"></div>
                </div>
                <div class="download-status" style="font-size: 0.75rem; color: var(--muted-foreground); margin-top: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Starting...</div>
            </div>
            <button class="download-cancel" style="background: transparent; border: none; color: var(--muted-foreground); cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s;">
                ${Pt}
            </button>
        </div>
    `,n.appendChild(a);const r=new AbortController;return $t.set(a,{abortController:r}),a.querySelector(".download-cancel").addEventListener("click",()=>{r.abort(),Ys(a)}),a}function ce(s,t,e,n){const a=s.querySelector(".download-progress-fill"),i=s.querySelector(".download-status"),r=e>0?Math.round(t/e*100):0;a.style.width=`${r}%`,i.textContent=`${t}/${e} - ${n}`}function vt(s,t=!0,e=null){const n=s.querySelector(".download-progress-fill"),a=s.querySelector(".download-status");t?(n.style.width="100%",n.style.background="#10b981",a.textContent="✓ Download complete",a.style.color="#10b981",setTimeout(()=>{s.style.animation="slideOut 0.3s ease",setTimeout(()=>s.remove(),300)},3e3)):(n.style.background="#ef4444",a.textContent=e||"✗ Download failed",a.style.color="#ef4444",setTimeout(()=>{s.style.animation="slideOut 0.3s ease",setTimeout(()=>s.remove(),300)},5e3))}async function qe(s,t,e,n=null,a=null){if(!s){alert("No track is currently playing");return}const i=`track-${s.id}`;if(Zt.has(i)){G("This track is already being downloaded");return}let r={...s,artist:s.artist||(s.artists&&s.artists.length>0?s.artists[0]:null)};if(r.album&&!r.album.title&&r.album.id)try{const o=await e.getAlbum(r.album.id);o.album&&(r.album={...r.album,...o.album})}catch(o){console.warn("Failed to fetch album data for metadata:",o)}const c=jt(r,t),l=a||new AbortController;Zt.add(i);try{const{taskEl:o}=Oe(s.id,r,c,e,l);if(await e.downloadTrack(s.id,t,c,{signal:l.signal,track:r,onProgress:d=>{Fe(s.id,d)}}),ae(s.id,!0),n&&At.shouldDownloadLyrics())try{const d=await n.fetchLyrics(s.id,s);d&&n.downloadLRC(d,s)}catch{console.log("Could not download lyrics for track")}}catch(o){if(o.name!=="AbortError"){const d=o.message===Se?o.message:"Download failed. Please try again.";ae(s.id,!1,d)}}finally{Zt.delete(i)}}const Ht=Object.freeze(Object.defineProperty({__proto__:null,addDownloadTask:Oe,completeDownloadTask:ae,downloadAlbumAsZip:Ue,downloadDiscography:je,downloadPlaylistAsZip:ie,downloadTrackWithMetadata:qe,downloadTracks:Js,showNotification:G,updateDownloadProgress:Fe},Symbol.toStringTag,{value:"Module"}));class Xs{constructor(){this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.cache=new Map}async getWaveform(t,e){if(this.cache.has(e))return this.cache.get(e);try{const a=await(await fetch(t)).arrayBuffer(),i=await this.audioContext.decodeAudioData(a),c={peaks:this.extractPeaks(i),duration:i.duration};return this.cache.set(e,c),c}catch(n){return console.error("Waveform generation failed:",n),null}}extractPeaks(t){const{length:e,duration:n}=t,a=Math.min(Math.floor(4*n),1e3),i=new Float32Array(a),r=t.getChannelData(0),c=Math.floor(e/a),l=8;for(let d=0;d<a;d++){let h=0;const u=d*c,m=u+c;for(let f=u;f<m;f+=l){const g=r[f];g>h?h=g:-g>h&&(h=-g)}i[d]=h}let o=0;for(let d=0;d<a;d++)i[d]>o&&(o=i[d]);if(o>0)for(let d=0;d<a;d++)i[d]/=o;return i}drawWaveform(t,e){if(!t||!e)return;const n=t.getContext("2d"),a=t.width,i=t.height;n.clearRect(0,0,a,i);const r=a/e.length,c=i/2;n.fillStyle="#000",n.beginPath(),n.moveTo(0,c);for(let l=0;l<e.length;l++){const o=e[l],d=Math.max(1.5,o*i*.9);n.lineTo(l*r,c-d/2)}for(let l=e.length-1;l>=0;l--){const o=e[l],d=Math.max(1.5,o*i*.9);n.lineTo(l*r,c+d/2)}n.closePath(),n.fill()}}const Ot=new Xs;let Ft=null;function Zs(s,t,e,n){const a=document.querySelector(".play-pause-btn"),i=document.getElementById("next-btn"),r=document.getElementById("prev-btn"),c=document.getElementById("shuffle-btn"),l=document.getElementById("repeat-btn"),o=document.getElementById("sleep-timer-btn-desktop"),d=document.getElementById("sleep-timer-btn");let h=null;s.shuffleActive&&c.classList.add("active"),s.repeatMode!==J.OFF?(l.classList.add("active"),s.repeatMode===J.ONE&&l.classList.add("repeat-one"),l.title=s.repeatMode===J.ALL?"Repeat Queue":"Repeat One"):l.title="Repeat",t.addEventListener("play",()=>{s.currentTrack&&(e.isAuthenticated()&&lt.isEnabled()&&e.updateNowPlaying(s.currentTrack),Ot.audioContext.state==="suspended"&&Ot.audioContext.resume(),g()),a.innerHTML=ss,s.updateMediaSessionPlaybackState(),s.updateMediaSessionPositionState(),He(s)}),t.addEventListener("playing",()=>{s.updateMediaSessionPlaybackState(),s.updateMediaSessionPositionState()}),t.addEventListener("pause",()=>{a.innerHTML=mt,s.updateMediaSessionPlaybackState(),s.updateMediaSessionPositionState()}),t.addEventListener("ended",()=>{s.playNext()}),t.addEventListener("timeupdate",async()=>{const{currentTime:y,duration:b}=t;if(b){const T=document.getElementById("progress-fill"),k=document.getElementById("current-time");if(T.style.width=`${y/b*100}%`,k.textContent=xt(y),y>=10&&s.currentTrack&&s.currentTrack.id!==h){h=s.currentTrack.id;const w=await C.addToHistory(s.currentTrack);F.syncHistoryItem(w),window.location.hash==="#recent"&&n.renderRecentPage()}}}),t.addEventListener("loadedmetadata",()=>{const y=document.getElementById("total-duration");y.textContent=xt(t.duration),s.updateMediaSessionPositionState()}),t.addEventListener("error",y=>{console.error("Audio playback error:",y),document.querySelector(".now-playing-bar .artist").textContent="Playback error. Try another track.",a.innerHTML=mt}),a.addEventListener("click",()=>s.handlePlayPause()),i.addEventListener("click",()=>s.playNext()),r.addEventListener("click",()=>s.playPrev()),c.addEventListener("click",()=>{s.toggleShuffle(),c.classList.toggle("active",s.shuffleActive),window.renderQueueFunction&&window.renderQueueFunction()}),l.addEventListener("click",()=>{const y=s.toggleRepeat();l.classList.toggle("active",y!==J.OFF),l.classList.toggle("repeat-one",y===J.ONE),l.title=y===J.OFF?"Repeat":y===J.ALL?"Repeat Queue":"Repeat One"}),o&&o.addEventListener("click",()=>{s.isSleepTimerActive()?(s.clearSleepTimer(),G("Sleep timer cancelled")):we(s)}),d&&d.addEventListener("click",()=>{s.isSleepTimerActive()?(s.clearSleepTimer(),G("Sleep timer cancelled")):we(s)});const u=document.getElementById("volume-bar"),m=document.getElementById("volume-fill"),f=document.getElementById("volume-btn"),g=async()=>{const y=document.getElementById("progress-bar"),b=document.querySelector(".player-controls");if(!se.isEnabled()||!s.currentTrack){y&&(y.style.webkitMaskImage="",y.style.maskImage="",y.classList.remove("has-waveform","waveform-loaded")),b&&b.classList.remove("waveform-loaded"),Ft=null;return}if(y&&Ft!==s.currentTrack.id){Ft=s.currentTrack.id,y.classList.add("has-waveform"),y.classList.remove("waveform-loaded"),b&&b.classList.remove("waveform-loaded"),y.style.webkitMaskImage="",y.style.maskImage="";try{const T=await s.api.getStreamUrl(s.currentTrack.id,"LOW"),k=await Ot.getWaveform(T,s.currentTrack.id);if(k&&Ft===s.currentTrack.id){let{peaks:w,duration:S}=k;const L=s.currentTrack.duration;if(L&&S&&S<L){const M=L-S;if(M>.5){const P=w.length/S,B=Math.floor(M*P);if(B>0){const D=new Float32Array(w.length+B);D.set(w,B),w=D}}}const x=document.createElement("canvas"),_=y.getBoundingClientRect();x.width=_.width||500,x.height=28,Ot.drawWaveform(x,w);const A=x.toDataURL();y.style.webkitMaskImage=`url(${A})`,y.style.webkitMaskSize="100% 100%",y.style.webkitMaskRepeat="no-repeat",y.style.maskImage=`url(${A})`,y.style.maskSize="100% 100%",y.style.maskRepeat="no-repeat",y.classList.add("waveform-loaded"),b&&b.classList.add("waveform-loaded")}}catch(T){console.error("Failed to load waveform mask:",T)}}};window.addEventListener("waveform-toggle",y=>{if(!y.detail.enabled){const b=document.getElementById("progress-bar"),T=document.querySelector(".player-controls");b&&(b.style.webkitMaskImage="",b.style.maskImage="",b.classList.remove("has-waveform","waveform-loaded")),T&&T.classList.remove("waveform-loaded")}g()});const p=()=>{const{muted:y}=t,b=s.userVolume;f.innerHTML=y||b===0?as:ns;const T=y?0:b*100;m.style.setProperty("--volume-level",`${T}%`),m.style.width=`${T}%`};f.addEventListener("click",()=>{t.muted=!t.muted,localStorage.setItem("muted",t.muted)}),t.addEventListener("volumechange",p);const v=parseFloat(localStorage.getItem("volume")||"0.7"),I=localStorage.getItem("muted")==="true";s.setVolume(v),t.muted=I,m.style.width=`${v*100}%`,u.style.setProperty("--volume-level",`${v*100}%`),p(),tn(t,s)}function tn(s,t){const e=document.getElementById("progress-bar"),n=document.getElementById("progress-fill"),a=document.getElementById("volume-bar"),i=document.getElementById("volume-fill"),r=document.getElementById("volume-btn");let c=!1,l=!1,o=!1;const d=(h,u,m)=>{const f=h.getBoundingClientRect(),g=Math.max(0,Math.min(1,(u.clientX-f.left)/f.width));m(g)};e.addEventListener("mousedown",h=>{c=!0,l=!s.paused,l&&s.pause(),d(e,h,u=>{isNaN(s.duration)||(s.currentTime=u*s.duration,n.style.width=`${u*100}%`)})}),e.addEventListener("touchstart",h=>{h.preventDefault(),c=!0,l=!s.paused,l&&s.pause();const u=h.touches[0],m=e.getBoundingClientRect(),f=Math.max(0,Math.min(1,(u.clientX-m.left)/m.width));isNaN(s.duration)||(s.currentTime=f*s.duration,n.style.width=`${f*100}%`)}),document.addEventListener("mousemove",h=>{c&&d(e,h,u=>{isNaN(s.duration)||(s.currentTime=u*s.duration,n.style.width=`${u*100}%`)}),o&&d(a,h,u=>{s.muted&&(s.muted=!1,localStorage.setItem("muted",!1)),t.setVolume(u),i.style.width=`${u*100}%`,a.style.setProperty("--volume-level",`${u*100}%`)})}),document.addEventListener("touchmove",h=>{if(c){const u=h.touches[0],m=e.getBoundingClientRect(),f=Math.max(0,Math.min(1,(u.clientX-m.left)/m.width));isNaN(s.duration)||(s.currentTime=f*s.duration,n.style.width=`${f*100}%`)}if(o){const u=h.touches[0],m=a.getBoundingClientRect(),f=Math.max(0,Math.min(1,(u.clientX-m.left)/m.width));s.muted&&(s.muted=!1,localStorage.setItem("muted",!1)),t.setVolume(f),i.style.width=`${f*100}%`,a.style.setProperty("--volume-level",`${f*100}%`)}}),document.addEventListener("mouseup",h=>{c&&(d(e,h,u=>{isNaN(s.duration)||(s.currentTime=u*s.duration,t.updateMediaSessionPositionState(),l&&s.play())}),c=!1),o&&(o=!1)}),document.addEventListener("touchend",h=>{c&&(isNaN(s.duration)||(t.updateMediaSessionPositionState(),l&&s.play()),c=!1),o&&(o=!1)}),e.addEventListener("click",h=>{c||d(e,h,u=>{if(!isNaN(s.duration)&&s.duration>0&&s.duration!==1/0)s.currentTime=u*s.duration,t.updateMediaSessionPositionState();else if(t.currentTrack&&t.currentTrack.duration){const m=u*t.currentTrack.duration,f=document.querySelector(".progress-fill");f&&(f.style.width=`${u*100}%`),t.playTrackFromQueue(m)}})}),a.addEventListener("mousedown",h=>{o=!0,d(a,h,u=>{s.muted&&(s.muted=!1,localStorage.setItem("muted",!1)),t.setVolume(u),i.style.width=`${u*100}%`,a.style.setProperty("--volume-level",`${u*100}%`)})}),a.addEventListener("touchstart",h=>{h.preventDefault(),o=!0;const u=h.touches[0],m=a.getBoundingClientRect(),f=Math.max(0,Math.min(1,(u.clientX-m.left)/m.width));s.muted&&(s.muted=!1,localStorage.setItem("muted",!1)),t.setVolume(f),i.style.width=`${f*100}%`,a.style.setProperty("--volume-level",`${f*100}%`)}),a.addEventListener("click",h=>{o||d(a,h,u=>{s.muted&&(s.muted=!1,localStorage.setItem("muted",!1)),t.setVolume(u),i.style.width=`${u*100}%`,a.style.setProperty("--volume-level",`${u*100}%`)})}),a.addEventListener("wheel",h=>{h.preventDefault();const u=h.deltaY>0?-.05:.05,m=Math.max(0,Math.min(1,t.userVolume+u));u>0&&s.muted&&(s.muted=!1,localStorage.setItem("muted",!1)),t.setVolume(m),i.style.width=`${m*100}%`,a.style.setProperty("--volume-level",`${m*100}%`)},{passive:!1}),r?.addEventListener("wheel",h=>{h.preventDefault();const u=h.deltaY>0?-.05:.05,m=Math.max(0,Math.min(1,t.userVolume+u));u>0&&s.muted&&(s.muted=!1,localStorage.setItem("muted",!1)),t.setVolume(m),i.style.width=`${m*100}%`,a.style.setProperty("--volume-level",`${m*100}%`)},{passive:!1})}async function ut(s,t,e,n,a,i="track",r=null,c=null){if(t){if(s==="add-to-queue")e.addToQueue(t),window.renderQueueFunction&&window.renderQueueFunction(),G(`Added to queue: ${t.title}`);else if(s==="play-next")e.addNextToQueue(t),window.renderQueueFunction&&window.renderQueueFunction(),G(`Playing next: ${t.title}`);else if(s==="track-mix")t.mixes&&t.mixes.TRACK_MIX&&(window.location.hash=`#mix/${t.mixes.TRACK_MIX}`);else if(s==="play-card")try{let l=[];if(i==="album")l=(await n.getAlbum(t.id)).tracks;else if(i==="playlist")l=(await n.getPlaylist(t.uuid)).tracks;else if(i==="user-playlist"){let o=await C.getPlaylist(t.id);if(!o)try{o=await F.getPublicPlaylist(t.id)}catch{}l=o?o.tracks:t.tracks||[]}if(l.length>0){e.setQueue(l,0);const o=document.getElementById("shuffle-btn");o&&o.classList.remove("active"),e.playAtIndex(0);const d=i==="user-playlist"?t.name:t.title;G(`Playing ${i.replace("user-","")}: ${d}`)}else G(`No tracks found in this ${i}`)}catch(l){console.error("Failed to play card:",l),G(`Failed to play ${i}`)}else if(s==="download")await qe(t,ct.getQuality(),n,a);else if(s==="toggle-like"){const l=await C.toggleFavorite(i,t);F.syncLibraryItem(i,t,l),l&&i==="track"&&c&&lt.isEnabled()&&lt.shouldLoveOnLike()&&c.loveTrack(t);const o=i==="playlist"?t.uuid:t.id,d=i==="track"?`[data-track-id="${o}"] .like-btn`:`.card[data-${i}-id="${o}"] .like-btn, .card[data-playlist-id="${o}"] .like-btn`,h=document.getElementById(`like-${i}-btn`),u=[...document.querySelectorAll(d)];h&&u.push(h);const m=document.getElementById("now-playing-like-btn");if(m&&i==="track"&&e?.currentTrack?.id===t.id&&u.push(m),u.forEach(f=>{const g=f.querySelector("svg");g&&(g.classList.toggle("filled",l),g.hasAttribute("fill")&&g.setAttribute("fill",l?"currentColor":"none")),f.classList.toggle("active",l),f.title=l?"Remove from Favorites":"Add to Favorites"}),window.location.hash==="#library"){const f=i==="track"?`.track-item[data-track-id="${o}"]`:`.card[data-${i}-id="${o}"], .card[data-playlist-id="${o}"]`,g=document.querySelector(f);if(!l&&g){const p=g.parentElement;if(g.remove(),p&&p.children.length===0){const v=i==="track"?"No liked tracks yet.":`No liked ${i}s yet.`;p.innerHTML=`<div class="placeholder-text">${v}</div>`}}else if(l&&!g&&r&&i==="track"){const p=document.getElementById("library-tracks-container");if(p){const v=p.querySelector(".placeholder-text");v&&v.remove();const I=p.children.length,y=r.createTrackItemHTML(t,I,!0,!1),b=document.createElement("div");b.innerHTML=y;const T=b.firstElementChild;T&&(p.appendChild(T),O.set(T,t),r.updateLikeState(T,"track",t.id))}}}}else if(s==="add-to-playlist"){const l=await C.getPlaylists();if(l.length===0){G("No playlists yet. Create one first.");return}const o=document.getElementById("playlist-select-modal"),d=document.getElementById("playlist-select-list"),h=document.getElementById("playlist-select-cancel"),u=o.querySelector(".modal-overlay"),m=t.id,f=new Set;for(const y of l)y.tracks&&y.tracks.some(b=>b.id===m)&&f.add(y.id);const g='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';d.innerHTML=l.map(y=>{const b=f.has(y.id);return`
                <div class="modal-option ${b?"already-contains":""}" data-id="${y.id}">
                    <span>${y.name}</span>
                    ${b?`<span class="checkmark">${g}</span>`:""}
                </div>
            `}).join("");const p=()=>{o.classList.remove("active"),I()},v=async y=>{const b=y.target.closest(".modal-option");if(b){const T=b.dataset.id;if(f.has(T))return;await C.addTrackToPlaylist(T,t);const w=await C.getPlaylist(T);F.syncUserPlaylist(w,"update"),G(`Added to playlist: ${b.querySelector("span").textContent}`),p()}},I=()=>{h.removeEventListener("click",p),u.removeEventListener("click",p),d.removeEventListener("click",v)};h.addEventListener("click",p),u.addEventListener("click",p),d.addEventListener("click",v),o.classList.add("active")}}}async function be(s,t){if(!s||!t)return;const e=s.querySelector('li[data-action="toggle-like"]');if(e){const{db:a}=await Q(async()=>{const{db:r}=await Promise.resolve().then(()=>pt);return{db:r}},void 0,import.meta.url),i=await a.isFavorite("track",t.id);e.textContent=i?"Unlike":"Like"}const n=s.querySelector('li[data-action="track-mix"]');if(n){const a=t.mixes&&t.mixes.TRACK_MIX;n.style.display=a?"block":"none"}}function en(s,t,e,n,a,i,r){let c=null;e.addEventListener("click",async u=>{const m=u.target.closest(".track-action-btn, .like-btn, .play-btn");if(m&&m.dataset.action){u.preventDefault(),u.stopPropagation();const v=m.closest(".track-item, .card"),I=m.dataset.action,y=m.dataset.type||"track";let b=v?O.get(v):null;if(!b&&I==="toggle-like"){const T=window.location.hash.split("/")[1];if(T)try{y==="album"?b=(await t.getAlbum(T)).album:y==="artist"?b=await t.getArtist(T):y==="playlist"?b=(await t.getPlaylist(T)).playlist:y==="mix"&&(b=(await t.getMix(T)).mix)}catch(k){console.error(k)}}b&&await ut(I,b,s,t,a,y,i,r);return}const f=u.target.closest(".track-menu-btn");if(f){u.stopPropagation();const v=f.closest(".track-item");if(v&&!v.dataset.queueIndex){const I=O.get(v);if(n.style.display==="block"&&c&&I&&c.id===I.id){n.style.display="none";return}if(c=I,c){await be(n,c);const y=f.getBoundingClientRect();ve(n,y.left,y.bottom+5,y)}}return}const g=u.target.closest(".track-item");if(g&&!g.dataset.queueIndex&&!u.target.closest(".remove-from-playlist-btn")){const v=g.closest(".track-list"),y=Array.from(v.querySelectorAll(".track-item")).map(b=>O.get(b)).filter(Boolean);if(y.length>0){const b=g.dataset.trackId,T=y.findIndex(k=>k.id==b);s.setQueue(y,T),document.getElementById("shuffle-btn").classList.remove("active"),s.playTrackFromQueue()}}const p=u.target.closest(".card");if(p){if(u.target.closest(".edit-playlist-btn")||u.target.closest(".delete-playlist-btn"))return;const v=p.dataset.href;if(v){if(u.target.closest("a"))return;u.preventDefault(),window.location.hash=v}}}),e.addEventListener("contextmenu",async u=>{const m=u.target.closest(".track-item, .queue-track-item");if(m){if(u.preventDefault(),m.classList.contains("queue-track-item")){const f=parseInt(m.dataset.queueIndex);c=s.getCurrentQueue()[f]}else c=O.get(m);c&&(await be(n,c),ve(n,u.pageX,u.pageY))}}),document.addEventListener("click",()=>{n.style.display="none"}),n.addEventListener("click",async u=>{u.stopPropagation();const m=u.target.dataset.action,f=n._contextTrack||c;m&&f&&await ut(m,f,s,t,a,"track",i,r),n.style.display="none"}),document.querySelector(".now-playing-bar .title").addEventListener("click",()=>{const u=s.currentTrack;u?.album?.id&&(window.location.hash=`#album/${u.album.id}`)}),document.querySelector(".now-playing-bar .artist").addEventListener("click",u=>{const m=u.target.closest(".artist-link");if(m){u.stopPropagation();const g=m.dataset.artistId;g&&(window.location.hash=`#artist/${g}`);return}const f=s.currentTrack;f?.artist?.id&&(window.location.hash=`#artist/${f.artist.id}`)});const l=document.getElementById("now-playing-like-btn");l&&l.addEventListener("click",async u=>{u.stopPropagation(),s.currentTrack&&await ut("toggle-like",s.currentTrack,s,t,a,"track",i,r)});const o=document.getElementById("now-playing-mix-btn");o&&o.addEventListener("click",async u=>{u.stopPropagation(),s.currentTrack&&await ut("track-mix",s.currentTrack,s,t,a,"track",i,r)});const d=document.getElementById("now-playing-add-playlist-btn");d&&d.addEventListener("click",async u=>{u.stopPropagation(),s.currentTrack&&await ut("add-to-playlist",s.currentTrack,s,t,a,"track",i,r)});const h=document.getElementById("mobile-add-playlist-btn");h&&h.addEventListener("click",async u=>{u.stopPropagation(),s.currentTrack&&await ut("add-to-playlist",s.currentTrack,s,t,a,"track",i,r)})}function we(s){const t=document.getElementById("sleep-timer-modal");if(!t)return;const e=()=>{t.classList.remove("active"),i()},n=r=>{const c=r.target.closest(".timer-option");if(c){let l;if(c.id==="custom-timer-btn"){const o=document.getElementById("custom-minutes");if(l=parseInt(o.value),!l||l<1){G("Please enter a valid number of minutes");return}}else l=parseInt(c.dataset.minutes);l&&(s.setSleepTimer(l),G(`Sleep timer set for ${l} minute${l===1?"":"s"}`),e())}},a=r=>{(r.target.id==="cancel-sleep-timer"||r.target.classList.contains("modal-overlay"))&&e()},i=()=>{t.removeEventListener("click",n),t.removeEventListener("click",a)};t.addEventListener("click",n),t.addEventListener("click",a),t.classList.add("active")}function ve(s,t,e,n=null){s.style.visibility="hidden",s.style.display="block";const a=s.offsetWidth,i=s.offsetHeight,r=window.innerWidth,c=window.innerHeight;let l=t,o=e;n?(l+a>r-10&&(l=n.right-a,l<10&&(l=10)),o+i>c-10&&(o=n.top-i-5)):(l+a>r-10&&(l=r-a-10),o+i>c-10&&(o=e-i)),s.style.top=`${o}px`,s.style.left=`${l}px`,s.style.visibility="visible"}function sn(s,t){const e=document.querySelector(".sidebar"),n=document.getElementById("sidebar-overlay"),a=document.getElementById("hamburger-btn"),i=document.getElementById("queue-btn");let r=null;a.addEventListener("click",()=>{e.classList.add("is-open"),n.classList.add("is-visible")});const c=()=>{e.classList.remove("is-open"),n.classList.remove("is-visible")};n.addEventListener("click",c),e.addEventListener("click",u=>{u.target.closest("a")&&c()});const l=u=>{const m=s.getCurrentQueue(),f=m.length>0;u.innerHTML=`
            <button id="download-queue-btn" class="btn-icon" title="Download Queue" style="display: ${f?"flex":"none"}">
                ${ft}
            </button>
            <button id="like-queue-btn" class="btn-icon" title="Add Queue to Liked" style="display: ${f?"flex":"none"}">
                ${rt}
            </button>
            <button id="add-queue-to-playlist-btn" class="btn-icon" title="Add Queue to Playlist" style="display: ${f?"flex":"none"}">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
            </button>
            <button id="clear-queue-btn" class="btn-icon" title="Clear Queue" style="display: ${f?"flex":"none"}">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
            </button>
            <button id="close-side-panel-btn" class="btn-icon" title="Close">
                ${Pt}
            </button>
        `,u.querySelector("#close-side-panel-btn").addEventListener("click",()=>{j.close()});const g=u.querySelector("#download-queue-btn");g&&g.addEventListener("click",async()=>{const{downloadTracks:y}=await Q(async()=>{const{downloadTracks:b}=await Promise.resolve().then(()=>Ht);return{downloadTracks:b}},void 0,import.meta.url);y(m,t,ct.getQuality())});const p=u.querySelector("#like-queue-btn");p&&p.addEventListener("click",async()=>{const{db:y}=await Q(async()=>{const{db:w}=await Promise.resolve().then(()=>pt);return{db:w}},void 0,import.meta.url),{syncManager:b}=await Q(async()=>{const{syncManager:w}=await Promise.resolve().then(()=>Xt);return{syncManager:w}},void 0,import.meta.url),{showNotification:T}=await Q(async()=>{const{showNotification:w}=await Promise.resolve().then(()=>Ht);return{showNotification:w}},void 0,import.meta.url);let k=0;for(const w of m)await y.toggleFavorite("track",w)&&(b.syncLibraryItem("track",w,!0),k++);k>0?T(`Added ${k} track${k>1?"s":""} to Liked`):T("All tracks in queue are already liked"),d()});const v=u.querySelector("#add-queue-to-playlist-btn");v&&v.addEventListener("click",async()=>{const{db:y}=await Q(async()=>{const{db:L}=await Promise.resolve().then(()=>pt);return{db:L}},void 0,import.meta.url),{syncManager:b}=await Q(async()=>{const{syncManager:L}=await Promise.resolve().then(()=>Xt);return{syncManager:L}},void 0,import.meta.url),{showNotification:T}=await Q(async()=>{const{showNotification:L}=await Promise.resolve().then(()=>Ht);return{showNotification:L}},void 0,import.meta.url),k=await y.getPlaylists();if(k.length===0){T("No playlists yet. Create one first.");return}const w=document.createElement("div");w.className="modal active",w.innerHTML=`
                    <div class="modal-overlay"></div>
                    <div class="modal-content">
                        <h3>Add Queue to Playlist</h3>
                        <div class="modal-list">
                            ${k.map(L=>`
                                <div class="modal-option" data-id="${L.id}">${Y(L.name)}</div>
                            `).join("")}
                        </div>
                        <div class="modal-actions">
                            <button class="btn-secondary cancel-btn">Cancel</button>
                        </div>
                    </div>
                `,document.body.appendChild(w);const S=()=>{w.remove()};w.addEventListener("click",async L=>{if(L.target.classList.contains("modal-overlay")||L.target.classList.contains("cancel-btn")){S();return}const x=L.target.closest(".modal-option");if(x){const _=x.dataset.id,A=x.textContent;try{let M=0;for(const B of m){const D=await y.addTrackToPlaylist(_,B);M++}const P=await y.getPlaylist(_);b.syncUserPlaylist(P,"update"),T(`Added ${M} tracks to playlist: ${A}`)}catch(M){console.error("Failed to add tracks to playlist:",M),T("Failed to add tracks to playlist")}S()}})});const I=u.querySelector("#clear-queue-btn");I&&I.addEventListener("click",()=>{s.clearQueue(),d()})},o=u=>{const m=s.getCurrentQueue();if(m.length===0){u.innerHTML='<div class="placeholder-text">Queue is empty.</div>';return}const f=m.map((g,p)=>{const v=p===s.currentQueueIndex,I=et(g),y=tt(g,{fallback:"Unknown"});return`
                <div class="queue-track-item ${v?"playing":""}" data-queue-index="${p}" data-track-id="${g.id}" draggable="true">
                    <div class="drag-handle">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="8" x2="19" y2="8"></line>
                            <line x1="5" y1="16" x2="19" y2="16"></line>
                        </svg>
                    </div>
                    <div class="track-item-info">
                        <img src="${t.getCoverUrl(g.album?.cover)}"
                             class="track-item-cover" loading="lazy">
                        <div class="track-item-details">
                            <div class="title">${Y(I)}</div>
                            <div class="artist">${Y(y)}</div>
                        </div>
                    </div>
                    <div class="track-item-duration">${xt(g.duration)}</div>
                    <button class="queue-like-btn" data-action="toggle-like" title="Add to Liked">
                        ${rt}
                    </button>
                    <button class="queue-remove-btn" data-track-index="${p}" title="Remove from queue">
                        ${rs}
                    </button>
                </div>
            `}).join("");u.innerHTML=f,u.querySelectorAll(".queue-track-item").forEach(async g=>{const p=parseInt(g.dataset.queueIndex),v=s.getCurrentQueue()[p],I=g.querySelector(".queue-like-btn");if(I&&v){const{db:y}=await Q(async()=>{const{db:T}=await Promise.resolve().then(()=>pt);return{db:T}},void 0,import.meta.url),b=await y.isFavorite("track",v.id);I.classList.toggle("active",b),I.innerHTML=b?rt.replace('class="heart-icon"','class="heart-icon filled"'):rt}g.addEventListener("click",async y=>{if(y.target.closest(".queue-remove-btn")){y.stopPropagation(),s.removeFromQueue(p),d();return}const T=y.target.closest(".queue-like-btn");if(T&&T.dataset.action==="toggle-like"){y.stopPropagation();const k=s.getCurrentQueue()[p];if(k){const{db:w}=await Q(async()=>{const{db:_}=await Promise.resolve().then(()=>pt);return{db:_}},void 0,import.meta.url),{syncManager:S}=await Q(async()=>{const{syncManager:_}=await Promise.resolve().then(()=>Xt);return{syncManager:_}},void 0,import.meta.url),{showNotification:L}=await Q(async()=>{const{showNotification:_}=await Promise.resolve().then(()=>Ht);return{showNotification:_}},void 0,import.meta.url),x=await w.toggleFavorite("track",k);S.syncLibraryItem("track",k,x),T.classList.toggle("active",x),T.innerHTML=x?rt.replace('class="heart-icon"','class="heart-icon filled"'):rt,L(x?`Added to Liked: ${k.title}`:`Removed from Liked: ${k.title}`)}return}s.playAtIndex(p),d()}),g.addEventListener("contextmenu",async y=>{y.preventDefault();const b=document.getElementById("context-menu");if(b){const T=s.getCurrentQueue()[p];if(T){const{db:k}=await Q(async()=>{const{db:P}=await Promise.resolve().then(()=>pt);return{db:P}},void 0,import.meta.url),w=await k.isFavorite("track",T.id),S=b.querySelector('li[data-action="toggle-like"]');S&&(S.textContent=w?"Unlike":"Like");const L=b.querySelector('li[data-action="track-mix"]');if(L){const P=T.mixes&&T.mixes.TRACK_MIX;L.style.display=P?"block":"none"}g.getBoundingClientRect();const x=150,_=200;let A=y.clientX,M=y.clientY;A+x>window.innerWidth&&(A=window.innerWidth-x-10),M+_>window.innerHeight&&(M=y.clientY-_-10),b.style.left=`${A}px`,b.style.top=`${M}px`,b.style.display="block",b._contextTrack=T}}}),g.addEventListener("dragstart",y=>{r=p,g.style.opacity="0.5"}),g.addEventListener("dragend",()=>{g.style.opacity="1"}),g.addEventListener("dragover",y=>{y.preventDefault()}),g.addEventListener("drop",y=>{y.preventDefault(),r!==null&&r!==p&&(s.moveInQueue(r,p),d())})})},d=()=>{j.refresh("queue",l,o)},h=()=>{j.open("queue","Queue",l,o)};i.addEventListener("click",h),window.renderQueueFunction=()=>{j.isActive("queue")&&d()},document.querySelectorAll(".search-tab").forEach(u=>{u.addEventListener("click",()=>{const m=u.closest(".page");if(!m)return;m.querySelectorAll(".search-tab").forEach(p=>p.classList.remove("active")),m.querySelectorAll(".search-tab-content").forEach(p=>p.classList.remove("active")),u.classList.add("active");const g=`${m.id==="page-library"?"library-tab-":"search-tab-"}${u.dataset.tab}`;document.getElementById(g)?.classList.add("active")})})}function nn(s={}){const{immediate:t=!1,onNeedRefresh:e,onOfflineReady:n,onRegistered:a,onRegisteredSW:i,onRegisterError:r}=s;let c,l,o;const d=async(u=!0)=>{await l,o?.()};async function h(){if("serviceWorker"in navigator){if(c=await Q(async()=>{const{Workbox:u}=await import("./workbox-window.prod.es5-BIl4cyR9.js");return{Workbox:u}},[],import.meta.url).then(({Workbox:u})=>new u("./sw.js",{scope:"./",type:"classic"})).catch(u=>{r?.(u)}),!c)return;o=()=>{c?.messageSkipWaiting()};{let u=!1;const m=()=>{u=!0,c?.addEventListener("controlling",f=>{f.isUpdate&&window.location.reload()}),e?.()};c.addEventListener("installed",f=>{typeof f.isUpdate>"u"?typeof f.isExternal<"u"&&f.isExternal?m():!u&&n?.():f.isUpdate||n?.()}),c.addEventListener("waiting",m)}c.register({immediate:t}).then(u=>{i?i("./sw.js",u):a?.(u)}).catch(u=>{r?.(u)})}}return l=h(),d}let wt=null;function ke(){if(wt)return;wt=new Lenis({wrapper:document.querySelector(".main-content"),content:document.querySelector(".main-content"),lerp:.1,smoothWheel:!0,smoothTouch:!1,normalizeWheel:!0,wheelMultiplier:.8});function s(t){wt.raf(t),requestAnimationFrame(s)}requestAnimationFrame(s)}function an(){wt&&(wt.destroy(),wt=null)}function Te(){ne.isEnabled()&&ke(),window.addEventListener("smooth-scrolling-toggle",function(t){t.detail.enabled?ke():an()})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Te):Te();function rn(s,t){t&&("remote"in s?(s.remote.watchAvailability(e=>{e&&(t.style.display="flex",t.classList.add("available"))}).catch(e=>{console.log("Remote playback not available:",e),window.innerWidth>768&&(t.style.display="flex")}),t.addEventListener("click",()=>{if(!s.src){alert("Please play a track first to enable casting.");return}s.remote.prompt().catch(e=>{if(e.name!=="NotAllowedError"){if(e.name==="NotFoundError"){alert("No remote playback devices (Chromecast/AirPlay) were found on your network.");return}console.log("Cast prompt error:",e)}})}),s.addEventListener("playing",()=>{s.remote&&s.remote.state==="connected"&&t.classList.add("connected")}),s.addEventListener("pause",()=>{s.remote&&s.remote.state==="disconnected"&&t.classList.remove("connected")})):s.webkitShowPlaybackTargetPicker?(t.style.display="flex",t.classList.add("available"),t.addEventListener("click",()=>{s.webkitShowPlaybackTargetPicker()}),s.addEventListener("webkitplaybacktargetavailabilitychanged",e=>{e.availability==="available"&&t.classList.add("available")}),s.addEventListener("webkitcurrentplaybacktargetiswirelesschanged",()=>{s.webkitCurrentPlaybackTargetIsWireless?t.classList.add("connected"):t.classList.remove("connected")})):window.innerWidth>768&&(t.style.display="flex",t.addEventListener("click",()=>{alert("Casting is not supported in this browser. Try Chrome for Chromecast or Safari for AirPlay.")})))}function on(s,t){document.addEventListener("keydown",e=>{if(!e.target.matches("input, textarea"))switch(e.key.toLowerCase()){case" ":e.preventDefault(),s.handlePlayPause();break;case"arrowright":e.shiftKey?s.playNext():t.currentTime=Math.min(t.duration,t.currentTime+10);break;case"arrowleft":e.shiftKey?s.playPrev():t.currentTime=Math.max(0,t.currentTime-10);break;case"arrowup":e.preventDefault(),s.setVolume(s.userVolume+.1);break;case"arrowdown":e.preventDefault(),s.setVolume(s.userVolume-.1);break;case"m":t.muted=!t.muted;break;case"s":document.getElementById("shuffle-btn")?.click();break;case"r":document.getElementById("repeat-btn")?.click();break;case"q":document.getElementById("queue-btn")?.click();break;case"/":e.preventDefault(),document.getElementById("search-input")?.focus();break;case"escape":document.getElementById("search-input")?.blur(),j.close(),Ct(t,j.panel);break;case"l":document.querySelector(".now-playing-bar .cover")?.click();break}})}function ln(){const s=document.createElement("div");s.className="offline-notification",s.innerHTML=`
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        <span>You are offline. Some features may not work.</span>
    `,document.body.appendChild(s),setTimeout(()=>{s.style.animation="slideOut 0.3s ease forwards",setTimeout(()=>s.remove(),300)},5e3)}function cn(){const s=document.querySelector(".offline-notification");s&&(s.style.animation="slideOut 0.3s ease forwards",setTimeout(()=>s.remove(),300))}document.addEventListener("DOMContentLoaded",async()=>{const s=new As(Cs),t=document.getElementById("audio-player"),e=localStorage.getItem("playback-quality")||"LOSSLESS",n=new js(t,s,e),a=new Us(s,n),i=new zs,r=new Be(s);r.loadKuroshiro().catch(y=>{console.warn("Failed to pre-load Kuroshiro:",y)});const c=ot.getTheme();ot.setTheme(c),ee.getMode(),Ws(i,n,s,a),Zs(n,t,i,a),en(n,s,document.querySelector(".main-content"),document.getElementById("context-menu"),r,a,i),sn(n,s),on(n,t);const l=document.getElementById("cast-btn");rn(t,l),n.currentTrack&&a.setCurrentTrack(n.currentTrack),document.querySelector(".now-playing-bar .cover").addEventListener("click",async()=>{if(!n.currentTrack){alert("No track is currently playing");return}const y=te.getMode();if(y==="lyrics")j.isActive("lyrics")?(j.close(),Ct(t,j.panel)):Nt(n.currentTrack,t,r);else if(y==="cover"){const b=document.getElementById("fullscreen-cover-overlay");if(b&&b.style.display==="flex")a.closeFullscreenCover();else{const T=n.getNextTrack();a.showFullscreenCover(n.currentTrack,T,r,t)}}else n.currentTrack.album?.id&&(window.location.hash=`#album/${n.currentTrack.album.id}`)}),document.getElementById("playlist-public-toggle")?.addEventListener("change",y=>{const b=document.getElementById("playlist-share-btn");b&&(b.style.display=y.target.checked?"flex":"none")}),document.getElementById("close-fullscreen-cover-btn")?.addEventListener("click",()=>{a.closeFullscreenCover()}),document.getElementById("fullscreen-cover-image")?.addEventListener("click",()=>{a.closeFullscreenCover()}),document.getElementById("nav-back")?.addEventListener("click",()=>{window.history.back()}),document.getElementById("nav-forward")?.addEventListener("click",()=>{window.history.forward()}),document.getElementById("toggle-lyrics-btn")?.addEventListener("click",async y=>{if(y.stopPropagation(),!n.currentTrack){alert("No track is currently playing");return}j.isActive("lyrics")?(j.close(),Ct(t,j.panel)):Nt(n.currentTrack,t,r)}),document.getElementById("download-current-btn")?.addEventListener("click",()=>{n.currentTrack&&ut("download",n.currentTrack,n,s,r,"track",a)});let o=null;t.addEventListener("play",async()=>{if(!n.currentTrack)return;a.setCurrentTrack(n.currentTrack);const y=n.currentTrack.id;if(y===o)return;o=y,j.isActive("lyrics")&&Nt(n.currentTrack,t,r);const b=document.getElementById("fullscreen-cover-overlay");if(b&&getComputedStyle(b).display!=="none"){const T=n.getNextTrack();a.showFullscreenCover(n.currentTrack,T,r,t)}}),document.addEventListener("click",async y=>{if(y.target.closest("#play-album-btn")){if(y.target.closest("#play-album-btn").disabled)return;const T=window.location.hash.split("/")[1];if(!T)return;try{const{tracks:k}=await s.getAlbum(T);k.length>0&&(n.setQueue(k,0),document.getElementById("shuffle-btn").classList.remove("active"),n.playTrackFromQueue())}catch(k){console.error("Failed to play album:",k),alert("Failed to play album: "+k.message)}}if(y.target.closest("#download-mix-btn")){const b=y.target.closest("#download-mix-btn");if(b.disabled)return;const T=window.location.hash.split("#mix/")[1];if(!T)return;b.disabled=!0;const k=b.innerHTML;b.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Downloading...</span>';try{const{mix:w,tracks:S}=await s.getMix(T);await ie(w,S,s,ct.getQuality(),r)}catch(w){console.error("Mix download failed:",w),alert("Failed to download mix: "+w.message)}finally{b.disabled=!1,b.innerHTML=k}}if(y.target.closest("#download-playlist-btn")){const b=y.target.closest("#download-playlist-btn");if(b.disabled)return;const T=window.location.hash.split("/")[1];if(!T)return;b.disabled=!0;const k=b.innerHTML;b.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Downloading...</span>';try{let w,S,L=await C.getPlaylist(T);if(!L)try{L=await F.getPublicPlaylist(T)}catch{}if(L)w={...L,title:L.name||L.title},S=L.tracks||[];else{const x=await s.getPlaylist(T);w=x.playlist,S=x.tracks}await ie(w,S,s,ct.getQuality(),r)}catch(w){console.error("Playlist download failed:",w),alert("Failed to download playlist: "+w.message)}finally{b.disabled=!1,b.innerHTML=k}}if(y.target.closest("#create-playlist-btn")){const b=document.getElementById("playlist-modal");document.getElementById("playlist-modal-title").textContent="Create Playlist",document.getElementById("playlist-name-input").value="",document.getElementById("playlist-cover-input").value="",b.dataset.editingId="",document.getElementById("csv-import-section").style.display="block",document.getElementById("csv-file-input").value="";const T=document.getElementById("playlist-public-toggle"),k=document.getElementById("playlist-share-btn");T&&(T.checked=!1),k&&(k.style.display="none"),b.classList.add("active"),document.getElementById("playlist-name-input").focus()}if(y.target.closest("#playlist-modal-save")){const b=document.getElementById("playlist-name-input").value.trim(),T=document.getElementById("playlist-public-toggle")?.checked;if(b){const k=document.getElementById("playlist-modal"),w=k.dataset.editingId,S=async L=>{if(L.isPublic=T,T)try{await F.publishPlaylist(L)}catch(x){console.error("Failed to publish playlist:",x),alert("Failed to publish playlist. Please ensure you are logged in.")}else try{await F.unpublishPlaylist(L.id)}catch{}return L};if(w){const L=document.getElementById("playlist-cover-input").value.trim();C.getPlaylist(w).then(async x=>{x&&(x.name=b,x.cover=L,await S(x),await C.performTransaction("user_playlists","readwrite",_=>_.put(x)),F.syncUserPlaylist(x,"update"),a.renderLibraryPage(),window.location.hash===`#userplaylist/${w}`&&a.renderPlaylistPage(w,"user"),k.classList.remove("active"),delete k.dataset.editingId)})}else{const L=document.getElementById("csv-file-input");let x=[];if(L.files.length>0){const A=L.files[0],M=document.getElementById("csv-import-progress"),P=document.getElementById("csv-progress-fill"),B=document.getElementById("csv-progress-current"),D=document.getElementById("csv-progress-total"),U=M.querySelector(".current-track"),z=M.querySelector(".current-artist");try{M.style.display="block",P.style.width="0%",B.textContent="0",U.textContent="Reading CSV file...",z&&(z.textContent="");const V=await A.text(),st=V.trim().split(`
`),q=Math.max(0,st.length-1);D.textContent=q.toString();const E=await hn(V,s,R=>{const H=q>0?R.current/q*100:0;P.style.width=`${Math.min(H,100)}%`,B.textContent=R.current.toString(),U.textContent=R.currentTrack,z&&(z.textContent=R.currentArtist||"")});x=E.tracks;const $=E.missingTracks;if(x.length===0){alert("No valid tracks found in the CSV file! Please check the format."),M.style.display="none";return}console.log(`Imported ${x.length} tracks from CSV`),$.length>0&&setTimeout(()=>{mn($)},500)}catch(V){console.error("Failed to parse CSV!",V),alert("Failed to parse CSV file! "+V.message),M.style.display="none";return}finally{setTimeout(()=>{M.style.display="none"},1e3)}}const _=document.getElementById("playlist-cover-input").value.trim();C.createPlaylist(b,x,_).then(async A=>{await S(A),await C.performTransaction("user_playlists","readwrite",M=>M.put(A)),F.syncUserPlaylist(A,"create"),a.renderLibraryPage(),k.classList.remove("active")})}}}if(y.target.closest("#playlist-modal-cancel")&&document.getElementById("playlist-modal").classList.remove("active"),y.target.closest(".edit-playlist-btn")){const T=y.target.closest(".user-playlist").dataset.userPlaylistId;C.getPlaylist(T).then(async k=>{if(k){const w=document.getElementById("playlist-modal");document.getElementById("playlist-modal-title").textContent="Edit Playlist",document.getElementById("playlist-name-input").value=k.name,document.getElementById("playlist-cover-input").value=k.cover||"";const S=document.getElementById("playlist-public-toggle"),L=document.getElementById("playlist-share-btn");S&&(S.checked=!!k.isPublic),L&&(L.style.display=k.isPublic?"flex":"none",L.onclick=()=>{const x=`${window.location.origin}${window.location.pathname}#userplaylist/${k.id}`;navigator.clipboard.writeText(x).then(()=>alert("Link copied to clipboard!"))}),w.dataset.editingId=T,document.getElementById("csv-import-section").style.display="none",w.classList.add("active"),document.getElementById("playlist-name-input").focus()}})}if(y.target.closest(".delete-playlist-btn")){const T=y.target.closest(".user-playlist").dataset.userPlaylistId;confirm("Are you sure you want to delete this playlist?")&&C.deletePlaylist(T).then(()=>{F.syncUserPlaylist({id:T},"delete"),a.renderLibraryPage()})}if(y.target.closest("#edit-playlist-btn")){const b=window.location.hash.split("/")[1];C.getPlaylist(b).then(T=>{if(T){const k=document.getElementById("playlist-modal");document.getElementById("playlist-modal-title").textContent="Edit Playlist",document.getElementById("playlist-name-input").value=T.name,document.getElementById("playlist-cover-input").value=T.cover||"";const w=document.getElementById("playlist-public-toggle"),S=document.getElementById("playlist-share-btn");w&&(w.checked=!!T.isPublic),S&&(S.style.display=T.isPublic?"flex":"none",S.onclick=()=>{const L=`${window.location.origin}${window.location.pathname}#userplaylist/${T.id}`;navigator.clipboard.writeText(L).then(()=>alert("Link copied to clipboard!"))}),k.dataset.editingId=b,document.getElementById("csv-import-section").style.display="none",k.classList.add("active"),document.getElementById("playlist-name-input").focus()}})}if(y.target.closest("#delete-playlist-btn")){const b=window.location.hash.split("/")[1];confirm("Are you sure you want to delete this playlist?")&&C.deletePlaylist(b).then(()=>{F.syncUserPlaylist({id:b},"delete"),window.location.hash="#library"})}if(y.target.closest(".remove-from-playlist-btn")){y.stopPropagation();const b=y.target.closest(".remove-from-playlist-btn"),T=parseInt(b.dataset.trackIndex),k=window.location.hash.split("/")[1];C.getPlaylist(k).then(async w=>{if(w&&w.tracks[T]){const S=w.tracks[T].id,L=await C.removeTrackFromPlaylist(k,S);F.syncUserPlaylist(L,"update");const x=document.querySelector(".main-content").scrollTop;await a.renderPlaylistPage(k,"user"),document.querySelector(".main-content").scrollTop=x}})}if(y.target.closest("#play-playlist-btn")){if(y.target.closest("#play-playlist-btn").disabled)return;const T=window.location.hash.split("/")[1];if(!T)return;try{let k;const w=await C.getPlaylist(T);if(w)k=w.tracks;else try{const{tracks:S}=await s.getPlaylist(T);k=S}catch(S){const L=await F.getPublicPlaylist(T);if(L)k=L.tracks;else throw S}k.length>0&&(n.setQueue(k,0),document.getElementById("shuffle-btn").classList.remove("active"),n.playTrackFromQueue())}catch(k){console.error("Failed to play playlist:",k),alert("Failed to play playlist: "+k.message)}}if(y.target.closest("#download-album-btn")){const b=y.target.closest("#download-album-btn");if(b.disabled)return;const T=window.location.hash.split("/")[1];if(!T)return;b.disabled=!0;const k=b.innerHTML;b.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Downloading...</span>';try{const{album:w,tracks:S}=await s.getAlbum(T);await Ue(w,S,s,ct.getQuality(),r)}catch(w){console.error("Album download failed:",w),alert("Failed to download album: "+w.message)}finally{b.disabled=!1,b.innerHTML=k}}if(y.target.closest("#play-artist-radio-btn")){const b=y.target.closest("#play-artist-radio-btn");if(b.disabled)return;const T=window.location.hash.split("/")[1];if(!T)return;b.disabled=!0;const k=b.innerHTML;b.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Loading...</span>';try{const w=await s.getArtist(T),S=[...w.albums||[],...w.eps||[]];if(S.length===0)throw new Error("No albums or EPs found for this artist");const L=new Set,x=[],_=[],A=3,M=S;for(let P=0;P<M.length;P+=A)_.push(M.slice(P,P+A));for(const P of _)await Promise.all(P.map(async B=>{try{const{tracks:D}=await s.getAlbum(B.id);D.forEach(U=>{L.has(U.id)||(L.add(U.id),x.push(U))})}catch(D){console.warn(`Failed to fetch tracks for album ${B.title}:`,D)}}));if(x.length>0){for(let P=x.length-1;P>0;P--){const B=Math.floor(Math.random()*(P+1));[x[P],x[B]]=[x[B],x[P]]}n.setQueue(x,0),n.playTrackFromQueue()}else throw new Error("No tracks found across all albums")}catch(w){console.error("Artist radio failed:",w),alert("Failed to start artist radio: "+w.message)}finally{document.body.contains(b)&&(b.disabled=!1,b.innerHTML=k)}}if(y.target.closest("#download-discography-btn")){const b=y.target.closest("#download-discography-btn");if(b.disabled)return;const T=window.location.hash.split("/")[1];if(!T)return;try{const k=await s.getArtist(T);fn(k,s,ct.getQuality(),r,b)}catch(k){console.error("Failed to load artist for discography download:",k),alert("Failed to load artist: "+k.message)}}});const d=document.getElementById("search-form"),h=document.getElementById("search-input"),u=cs(y=>{y&&(window.location.hash=`#search/${encodeURIComponent(y)}`)},300);h.addEventListener("input",y=>{const b=y.target.value.trim();b.length>2&&u(b)}),d.addEventListener("submit",y=>{y.preventDefault();const b=h.value.trim();b&&(window.location.hash=`#search/${encodeURIComponent(b)}`)}),window.addEventListener("online",()=>{cn(),console.log("Back online")}),window.addEventListener("offline",()=>{ln(),console.log("Gone offline")}),document.querySelector(".play-pause-btn").innerHTML=mt;const m=Ks(a);m(),window.addEventListener("hashchange",m);const f=[window.location.hash];let g=0;const p=()=>{const y=document.getElementById("nav-back"),b=document.getElementById("nav-forward");y&&(y.disabled=g<=0),b&&(b.disabled=g>=f.length-1)};window.addEventListener("hashchange",()=>{const y=window.location.hash;y!==f[g]&&(g>0&&y===f[g-1]?g--:g<f.length-1&&y===f[g+1]?g++:(g++,f.splice(g),f.push(y)),p())}),p(),t.addEventListener("play",()=>{He(n)});const v=nn({onNeedRefresh(){dn(()=>v(!0))},onOfflineReady(){console.log("App ready to work offline")}});let I;window.addEventListener("beforeinstallprompt",y=>{y.preventDefault(),I=y,localStorage.getItem("installPromptDismissed")||un(I)}),document.getElementById("show-shortcuts-btn")?.addEventListener("click",()=>{Ee()}),!localStorage.getItem("shortcuts-shown")&&window.innerWidth>768&&setTimeout(()=>{Ee(),localStorage.setItem("shortcuts-shown","true")},3e3),window.addEventListener("library-changed",()=>{const y=window.location.hash;y==="#library"?a.renderLibraryPage():(y==="#home"||y==="")&&a.renderHomePage()}),window.addEventListener("history-changed",()=>{window.location.hash==="#recent"&&a.renderRecentPage()})});function dn(s){const t=document.createElement("div");t.className="update-notification",t.innerHTML=`
        <div>
            <strong>Update Available</strong>
            <p>A new version of Monochrome is available.</p>
        </div>
        <button class="btn-secondary" id="update-now-btn">Update Now</button>
    `,document.body.appendChild(t),document.getElementById("update-now-btn").addEventListener("click",()=>{typeof s=="function"?s():s&&s.postMessage?s.postMessage({action:"skipWaiting"}):window.location.reload()})}function un(s){if(!s)return;const t=document.createElement("div");t.className="install-prompt",t.innerHTML=`
        <div>
            <strong>Install Monochrome</strong>
            <p>Install this app for a better experience.</p>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn-secondary" id="install-btn">Install</button>
            <button class="btn-secondary" id="dismiss-install">Dismiss</button>
        </div>
    `,document.body.appendChild(t),document.getElementById("install-btn").addEventListener("click",async()=>{t.remove(),s.prompt();const{outcome:e}=await s.userChoice;console.log(`User response to install prompt: ${e}`),s=null}),document.getElementById("dismiss-install").addEventListener("click",()=>{t.remove(),localStorage.setItem("installPromptDismissed","true")})}function mn(s){const t=document.getElementById("missing-tracks-modal"),e=document.getElementById("missing-tracks-list-ul");e.innerHTML=s.map(i=>`<li>${i}</li>`).join("");const n=()=>t.classList.remove("active"),a=i=>{(i.target===t||i.target.closest(".close-missing-tracks")||i.target.id==="close-missing-tracks-btn"||i.target.classList.contains("modal-overlay"))&&(n(),t.removeEventListener("click",a))};t.addEventListener("click",a),t.classList.add("active")}async function hn(s,t,e){const n=s.trim().split(`
`);if(n.length<2)return[];const a=d=>{const h=[];let u="",m=!1;for(let f=0;f<d.length;f++){const g=d[f];g==='"'?m=!m:g===","&&!m?(h.push(u),u=""):u+=g}return h.push(u),h.map(f=>f.trim().replace(/^"|"$/g,"").replace(/""/g,'"').trim())},i=a(n[0]),r=n.slice(1),c=[],l=[],o=r.length;for(let d=0;d<r.length;d++){const h=r[d];if(!h.trim())continue;const u=a(h);if(u.length>=i.length){let m="",f="",g="";if(i.forEach((p,v)=>{const I=u[v];if(I)switch(p.toLowerCase()){case"track name":case"title":case"song":m=I;break;case"artist name(s)":case"artist name":case"artist":case"artists":f=I;break;case"album":case"album name":g=I;break}}),e&&e({current:d,total:o,currentTrack:m||"Unknown track",currentArtist:f||""}),m&&f){await new Promise(p=>setTimeout(p,300));try{let p=null;const v=k=>k.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim(),I=(k,w,S,L)=>{if(!k)return!1;const x=v(k.title||""),_=(k.artists||[]).map(z=>v(z.name||"")).join(" "),A=v(k.album?.name||""),M=v(w),P=v(S),B=v(L||"");return!(x===M||x.includes(M)||M.includes(x))||!(_.includes(P.split(" ")[0])||P.includes(_.split(" ")[0]))?!1:B?A===B||A.includes(B)||B.includes(A):!0};if(!p){let k=`${m} ${f}`;g&&(k+=` ${g}`);const w=await t.searchTracks(k);if(w.items&&w.items.length>0){for(const S of w.items)if(I(S,m,f,g)){p=S;break}if(!p&&g){const S=w.items[0];I(S,m,f,g)&&(p=S)}}}if(!p&&f){const k=f.split(",")[0].trim();if(k&&k!==f){let w=`${m} ${k}`;g&&(w+=` ${g}`);const S=await t.searchTracks(w);if(S.items&&S.items.length>0){for(const L of S.items)if(I(L,m,k,g)){p=L,console.log(`Found (Retry 1 - Main Artist): ${m}`);break}}}}if(!p&&g){const k=`${m} ${g}`,w=await t.searchTracks(k);if(w.items&&w.items.length>0){for(const S of w.items)if(I(S,m,f,g)){p=S,console.log(`Found (Retry 2 - Album): ${m}`);break}}}const b=(k=>k.split(" - ")[0].replace(/\s*[\(\[]feat\.?.*?[\)\]]/i,"").trim())(m),T=b!==m;if(!p&&T){const k=(f||"").split(",")[0].trim();if(b){let w=`${b} ${k}`;g&&(w+=` ${g}`);const S=await t.searchTracks(w);if(S.items&&S.items.length>0){for(const L of S.items)if(I(L,b,k,g)){p=L,console.log(`Found (Retry 3 - Cleaned Title): ${m}`);break}}}}if(!p){const k=(f||"").split(",")[0].trim(),w=`${m} ${k}`,S=await t.searchTracks(w);if(S.items&&S.items.length>0){for(const L of S.items)if(I(L,m,k,null)){p=L,console.log(`Found (Retry 4 - Ignore Album): ${m}`);break}}}if(!p&&T){const k=(f||"").split(",")[0].trim(),w=`${b} ${k}`,S=await t.searchTracks(w);if(S.items&&S.items.length>0){for(const L of S.items)if(I(L,b,k,null)){p=L,console.log(`Found (Retry 5 - Cleaned Title + Ignore Album): ${m}`);break}}}p?(c.push(p),console.log(`✓ "${m}" by ${f}${g?" ["+g+"]":""}`)):(console.warn(`✗ Track not found: "${m}" by ${f}${g?" ["+g+"]":""}`),l.push(`${m} - ${f}${g?" (album: "+g+")":""}`))}catch(p){console.error(`Error searching for track "${m}":`,p),l.push(`${m} - ${f}${g?" (album: "+g+")":""}`)}}}}return e&&e({current:o,total:o,currentTrack:"Import complete"}),{tracks:c,missingTracks:l}}function fn(s,t,e,n,a){const i=document.getElementById("discography-download-modal");document.getElementById("discography-artist-name").textContent=s.name,document.getElementById("albums-count").textContent=s.albums?.length||0,document.getElementById("eps-count").textContent=(s.eps||[]).filter(l=>l.type==="EP").length,document.getElementById("singles-count").textContent=(s.eps||[]).filter(l=>l.type==="SINGLE").length,document.getElementById("download-albums").checked=!0,document.getElementById("download-eps").checked=!0,document.getElementById("download-singles").checked=!0;const r=()=>{i.classList.remove("active")},c=l=>{(l.target===i||l.target.classList.contains("modal-overlay")||l.target.closest(".close-modal-btn")||l.target.id==="cancel-discography-download")&&r()};i.addEventListener("click",c),document.getElementById("start-discography-download").onclick=async()=>{const l=document.getElementById("download-albums").checked,o=document.getElementById("download-eps").checked,d=document.getElementById("download-singles").checked;if(!l&&!o&&!d){alert("Please select at least one type of release to download.");return}r();let h=[];l&&(h=h.concat(s.albums||[])),o&&(h=h.concat((s.eps||[]).filter(m=>m.type==="EP"))),d&&(h=h.concat((s.eps||[]).filter(m=>m.type==="SINGLE"))),a.disabled=!0;const u=a.innerHTML;a.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Downloading...</span>';try{await je(s,h,t,e,n)}catch(m){console.error("Discography download failed:",m),alert("Failed to download discography: "+m.message)}finally{a.disabled=!1,a.innerHTML=u}},i.classList.add("active")}function Ee(){const s=document.getElementById("shortcuts-modal"),t=()=>{s.classList.remove("active"),s.removeEventListener("click",e)},e=n=>{(n.target===s||n.target.classList.contains("close-shortcuts")||n.target.classList.contains("modal-overlay"))&&t()};s.addEventListener("click",e),s.classList.add("active")}
